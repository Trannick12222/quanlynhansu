<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ¸ Dashboard - TrÆ°á»ng Máº§m Non Hoa HÆ°á»›ng DÆ°Æ¡ng</title>
  
  <!-- TailwindCSS -->
  <link href="{{ url_for('static', filename='css/employee-dashboard.css') }}" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'neutral': {
              'primary': '#14532d',
              'secondary': '#166534',
              'accent': '#15803d',
              'muted': '#16a34a',
              'light': '#dcfce7',
              'lighter': '#f0fdf4',
              'lightest': '#f7fee7'
            },
            'background': {
              'primary': '#f9fafb',
              'secondary': '#f4f6f8',
              'muted': '#e5e7eb',
              'card': '#ffffff'
            },
            'kindergarten': {
              'pink': '#dcfce7',
              'yellow': '#f0fdf4',
              'blue': '#14532d',
              'green': '#166534',
              'orange': '#15803d',
              'purple': '#16a34a',
              'coral': '#22c55e'
            },
            'cute': {
              'primary': '#14532d',
              'secondary': '#166534'
            }
          },
          fontFamily: {
            'system': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
            'cute': ['Inter', 'Fredoka', 'Comic Sans MS', 'cursive', 'sans-serif']
          },
          animation: {
            'bounce-slow': 'bounce 2s infinite',
            'wiggle': 'wiggle 1s ease-in-out infinite',
            'float': 'float 3s ease-in-out infinite',
            'pulse-slow': 'pulse 3s infinite'
          },
          keyframes: {
            wiggle: {
              '0%, 100%': { transform: 'rotate(-3deg)' },
              '50%': { transform: 'rotate(3deg)' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0px)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <!-- Custom CSS for additional cute styles -->
  <style>
    .shadow-neutral { box-shadow: 0 4px 20px rgba(20, 83, 45, 0.08); }
    .shadow-neutral-lg { box-shadow: 0 10px 30px rgba(20, 83, 45, 0.12); }
    .shadow-cute { box-shadow: 0 10px 25px -5px rgba(20, 83, 45, 0.15), 0 4px 6px -2px rgba(20, 83, 45, 0.05); }
    .shadow-cute-lg { box-shadow: 0 20px 40px -12px rgba(20, 83, 45, 0.2), 0 8px 16px -4px rgba(20, 83, 45, 0.08); }
    .bg-neutral-gradient { background: linear-gradient(135deg, #14532d 0%, #15803d 100%); }
    .bg-muted-gradient { background: linear-gradient(135deg, #f4f6f8 0%, #e5e7eb 100%); }
    .gradient-cute { background: linear-gradient(135deg, #14532d 0%, #166534 50%, #15803d 100%); }
    .gradient-cute-blue { background: linear-gradient(135deg, #16a34a 0%, #14532d 100%); }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Loading animation */
    .loading {
      position: relative;
      opacity: 0.7;
    }
    
    .loading::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid #f4f6f8;
      border-top: 3px solid #16a34a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 1000;
    }
    
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Cute hover effects */
    .hover-float:hover {
      transform: translateY(-2px);
      transition: transform 0.3s ease;
    }
    
    /* Active nav link pulse */
    .nav-link.active {
      animation: gentle-pulse 2s infinite;
    }
    
    @keyframes gentle-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.9; }
    }
  </style>
  
</head>

<body class="employee-dashboard bg-background-primary min-h-screen font-system">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-80 bg-white/95 backdrop-blur-sm shadow-neutral-lg transform transition-transform duration-300 ease-in-out z-50 fixed lg:relative lg:transform-none -translate-x-full lg:translate-x-0" id="sidebar">
      <!-- Header -->
      <div class="bg-neutral-gradient p-6 text-center shadow-lg relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-white/20 to-transparent"></div>
        <div class="relative z-10">
          <div class="mb-4 flex justify-center">
            <div class="w-20 h-20 rounded-full border-4 border-white/30 shadow-neutral overflow-hidden animate-float">
              <img src="{{ url_for('static_files', filename='mnhhd.jpg') }}" 
                   alt="ğŸŒ¸" 
                   class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
            </div>
          </div>
          <h2 class="text-white font-system font-bold text-xl leading-tight mb-2">
            ğŸŒ¸ TRÆ¯á»œNG Máº¦M NON<br>
            ğŸŒ» HOA HÆ¯á»šNG DÆ¯Æ NG ğŸŒ»
          </h2>
          <p class="text-white/90 text-xs font-semibold tracking-wider font-system">
            âœ¨ Há»† THá»NG QUáº¢N LÃ NHÃ‚N Sá»° âœ¨
          </p>
        </div>
        <!-- Decorative elements -->
        <div class="absolute top-2 left-2 text-white/20 text-2xl animate-spin-slow">ğŸŒŸ</div>
        <div class="absolute top-4 right-4 text-white/20 text-xl animate-bounce">ğŸ¦‹</div>
        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-white/20 text-lg animate-wiggle">ğŸŒˆ</div>
      </div>
      
      <nav class="p-4 space-y-2 h-[calc(100vh-200px)] lg:max-h-[calc(100vh-200px)] overflow-y-auto">
        <!-- Main Section -->
        <div class="mb-6">
          <div class="flex items-center mb-3 text-gray-500 font-cute text-sm">
            <span class="mr-2">ğŸ </span>
            <span class="uppercase tracking-wider font-semibold">Trang ChÃ­nh</span>
          </div>
          <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute group bg-gradient-to-r from-cute-primary/10 to-cute-secondary/10 border-l-4 border-cute-primary" 
             data-page="/employees" href="#">
            <span class="text-2xl mr-3 group-hover:animate-bounce">ğŸ¡</span>
            <span class="font-cute font-semibold text-gray-700 group-hover:text-cute-primary">Trang Chá»§</span>
          </a>
        </div>
        
        <!-- EPA Section -->
        {% if session['role'] == 'user' or session['role'] == 'supervisor' %}
        <div class="mb-6">
          <div class="flex items-center mb-3 text-gray-500 font-cute text-sm">
            <span class="mr-2">â­</span>
            <span class="uppercase tracking-wider font-semibold">ÄÃ¡nh GiÃ¡ EPA</span>
          </div>
          <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-yellow/20 hover:to-kindergarten-orange/20 group" 
             data-page="/user-epa-score" href="#">
            <span class="text-2xl mr-3 group-hover:animate-bounce">ğŸŒŸ</span>
            <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-orange">ÄÃ¡nh GiÃ¡ CÃ¡ NhÃ¢n</span>
          </a>
        </div>
        {% endif %}
        
        <!-- Admin Section -->
        {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
        <div class="mb-6">
          <div class="flex items-center mb-3 text-gray-500 font-cute text-sm">
            <span class="mr-2">ğŸ‘‘</span>
            <span class="uppercase tracking-wider font-semibold">Quáº£n LÃ½</span>
          </div>
          <div class="space-y-2">
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-blue/20 hover:to-kindergarten-purple/20 group" 
               data-page="/users" href="#">
              <span class="text-2xl mr-3 group-hover:animate-wiggle">ğŸ‘¥</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-blue">TÃ i Khoáº£n</span>
            </a>
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-green/20 hover:to-kindergarten-blue/20 group" 
               data-page="/classes" href="#">
              <span class="text-2xl mr-3 group-hover:animate-bounce">ğŸ«</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-green">Danh SÃ¡ch Lá»›p</span>
            </a>
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-purple/20 hover:to-kindergarten-pink/20 group" 
               data-page="/assign-classes" href="#">
              <span class="text-2xl mr-3 group-hover:animate-bounce">ğŸ‘¶</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-purple">PhÃ¢n Lá»›p</span>
            </a>
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-coral/20 hover:to-kindergarten-yellow/20 group" 
               data-page="/assign-teachers" href="#">
              <span class="text-2xl mr-3 group-hover:animate-wiggle">ğŸ‘©â€ğŸ«</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-coral">PhÃ¢n CÃ´ng GV</span>
            </a>
          </div>
        </div>
        
        <div class="mb-6">
          <div class="flex items-center mb-3 text-gray-500 font-cute text-sm">
            <span class="mr-2">ğŸ“Š</span>
            <span class="uppercase tracking-wider font-semibold">ÄÃ¡nh GiÃ¡ & BÃ¡o CÃ¡o</span>
          </div>
          <div class="space-y-2">
            {% if session['role'] == 'supervisor' %}
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-blue/20 hover:to-kindergarten-green/20 group" 
               data-page="/sup-epa-score" href="#">
              <span class="text-2xl mr-3 group-hover:animate-bounce">âœ…</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-blue">Cháº¥m Äiá»ƒm Tá»• ViÃªn</span>
            </a>
            {% else %}
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-blue/20 hover:to-kindergarten-green/20 group" 
               data-page="/data_epa" href="#">
              <span class="text-2xl mr-3 group-hover:animate-bounce">ğŸ“ˆ</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-blue">ÄÃ¡nh GiÃ¡ GV</span>
            </a>
            {% endif %}
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-yellow/20 hover:to-kindergarten-orange/20 group" 
               data-page="/epa_summary" href="#">
              <span class="text-2xl mr-3 group-hover:animate-bounce">ğŸ†</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-orange">Xáº¿p Háº¡ng</span>
            </a>
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-purple/20 hover:to-kindergarten-blue/20 group" 
               data-page="/admin/questions" href="#">
              <span class="text-2xl mr-3 group-hover:animate-wiggle">â“</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-purple">CÃ¢u Há»i EPA</span>
            </a>
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-kindergarten-green/20 hover:to-kindergarten-blue/20 group" 
               data-page="/thoigianmoepa" href="#">
              <span class="text-2xl mr-3 group-hover:animate-bounce">â°</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-kindergarten-green">Thá»i Gian EPA</span>
            </a>
          </div>
        </div>
        
        <div class="mb-6">
          <div class="flex items-center mb-3 text-gray-500 font-cute text-sm">
            <span class="mr-2">âš™ï¸</span>
            <span class="uppercase tracking-wider font-semibold">Há»‡ Thá»‘ng</span>
          </div>
          <div class="space-y-2">
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-gray-200/50 hover:to-gray-300/50 group" 
               data-page="/logs" href="#">
              <span class="text-2xl mr-3 group-hover:animate-bounce">ğŸ“š</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-gray-600">Nháº­t KÃ½</span>
            </a>
            <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-gray-200/50 hover:to-gray-300/50 group" 
               data-page="/stats" href="#">
              <span class="text-2xl mr-3 group-hover:animate-bounce">ğŸ“Š</span>
              <span class="font-cute font-semibold text-gray-700 group-hover:text-gray-600">Thá»‘ng KÃª</span>
            </a>
          </div>
        </div>
        {% endif %}
        
        <!-- Logout -->
        <div class="border-t border-gray-200 pt-4">
          <a class="nav-link flex items-center p-3 rounded-xl transition-all duration-300 hover:shadow-cute hover:bg-gradient-to-r hover:from-red-100 hover:to-red-200 group" 
             href="/logout">
            <span class="text-2xl mr-3 group-hover:animate-wiggle">ğŸ‘‹</span>
            <span class="font-cute font-semibold text-red-500 group-hover:text-red-600">ÄÄƒng Xuáº¥t</span>
          </a>
        </div>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:ml-0">
      <!-- Topbar -->
      <header class="bg-white/80 backdrop-blur-lg border-b border-gray-200/50 px-3 sm:px-6 py-4 shadow-cute sticky top-0 z-40">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2 sm:space-x-4">
            <button class="lg:hidden p-2 rounded-xl bg-gradient-to-r from-cute-primary/10 to-cute-secondary/10 text-cute-primary hover:shadow-cute transition-all duration-300" 
                    id="mobileMenuBtn">
              <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="flex items-center space-x-2 sm:space-x-3">
              <span class="text-2xl sm:text-3xl animate-float">ğŸŒ¸</span>
              <h1 class="text-lg sm:text-2xl font-cute font-bold bg-gradient-to-r from-cute-primary to-cute-secondary bg-clip-text text-transparent">
                Dashboard Máº§m Non
              </h1>
            </div>
          </div>
          
          <div class="flex items-center space-x-1 sm:space-x-3">
            <a class="btn-cute flex items-center space-x-1 sm:space-x-2 px-2 sm:px-4 py-2 rounded-xl bg-gradient-to-r from-kindergarten-blue/20 to-kindergarten-green/20 text-kindergarten-blue hover:shadow-cute transition-all duration-300 group" 
               href="/dashboard">
              <span class="group-hover:animate-bounce">ğŸ </span>
              <span class="hidden sm:inline font-cute font-semibold text-xs sm:text-sm">Trang Chá»§</span>
            </a>
            <button class="btn-cute flex items-center space-x-1 sm:space-x-2 px-2 sm:px-4 py-2 rounded-xl bg-gradient-to-r from-kindergarten-yellow/20 to-kindergarten-orange/20 text-kindergarten-orange hover:shadow-cute transition-all duration-300 group" 
                    onclick="openChangePassModal()">
              <span class="group-hover:animate-wiggle">ğŸ”‘</span>
              <span class="hidden sm:inline font-cute font-semibold text-xs sm:text-sm">Äá»•i MK</span>
            </button>
            <a class="btn-cute flex items-center space-x-1 sm:space-x-2 px-2 sm:px-4 py-2 rounded-xl bg-gradient-to-r from-red-400/20 to-red-500/20 text-red-500 hover:shadow-cute transition-all duration-300 group" 
               href="/logout">
              <span class="group-hover:animate-bounce">ğŸ‘‹</span>
              <span class="hidden sm:inline font-cute font-semibold text-xs sm:text-sm">ÄÄƒng Xuáº¥t</span>
            </a>
            
            <div class="flex items-center space-x-2 sm:space-x-3 px-2 sm:px-4 py-2 bg-gradient-to-r from-cute-primary/10 to-cute-secondary/10 rounded-full border border-cute-primary/20 shadow-cute">
              <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-cute rounded-full flex items-center justify-center text-white font-bold animate-pulse-slow text-xs sm:text-sm">
                {{ user[0].upper() if user else 'ğŸŒ¸' }}
              </div>
              <div class="hidden sm:block">
                <div class="font-cute font-bold text-gray-700 text-xs sm:text-sm">{{ user or 'Unknown' }}</div>
                <div class="font-cute text-xs text-gray-500">{{ role or 'user' }}</div>
              </div>
            </div>
          </div>
        </div>
      </header>
      
      <!-- Content Area -->
      <div class="flex-1 p-3 sm:p-6 bg-gradient-to-br from-white/50 to-gray-50/50">
        <div class="h-full bg-white/80 backdrop-blur-lg rounded-xl sm:rounded-3xl shadow-cute-lg border border-white/60 overflow-hidden">
          <iframe 
            id="mainFrame" 
            class="w-full h-full border-0 rounded-xl sm:rounded-3xl"
            src="/employees"
            title="Main Content"
          ></iframe>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Mobile Overlay -->
  <div class="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 hidden transition-opacity duration-300" id="mobileOverlay"></div>
  
  <!-- Change Password Modal -->
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-all duration-300" id="changePassModal">
    <div class="bg-white/95 backdrop-blur-lg rounded-3xl shadow-cute-lg border border-white/60 w-full max-w-md mx-4 transform transition-all duration-300">
      <div class="gradient-cute-blue p-6 text-center rounded-t-3xl relative">
        <div class="absolute top-2 right-2">
          <button class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-white hover:bg-white/30 transition-colors duration-200" 
                  onclick="closeChangePassModal()">
            <i class="fas fa-times text-sm"></i>
          </button>
        </div>
        <span class="text-3xl animate-bounce">ğŸ”</span>
        <h3 class="text-white font-cute font-bold text-xl mt-2">Äá»•i Máº­t Kháº©u</h3>
      </div>
      
      <div class="p-6">
        <form id="changePassForm" class="space-y-4">
          <div>
            <label class="block text-gray-700 font-cute font-semibold mb-2">
              <span class="mr-2">ğŸ”’</span>Máº­t kháº©u hiá»‡n táº¡i
            </label>
            <input class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-cute-primary focus:outline-none transition-colors duration-200 font-cute" 
                   id="oldPassword" type="password" placeholder="Nháº­p máº­t kháº©u hiá»‡n táº¡i" required>
          </div>
          <div>
            <label class="block text-gray-700 font-cute font-semibold mb-2">
              <span class="mr-2">ğŸ”‘</span>Máº­t kháº©u má»›i
            </label>
            <input class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-cute-primary focus:outline-none transition-colors duration-200 font-cute" 
                   id="newPassword" type="password" placeholder="Nháº­p máº­t kháº©u má»›i" required>
          </div>
          <div>
            <label class="block text-gray-700 font-cute font-semibold mb-2">
              <span class="mr-2">âœ…</span>XÃ¡c nháº­n máº­t kháº©u má»›i
            </label>
            <input class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-cute-primary focus:outline-none transition-colors duration-200 font-cute" 
                   id="confirmNewPassword" type="password" placeholder="Nháº­p láº¡i máº­t kháº©u má»›i" required>
          </div>
        </form>
      </div>
      
      <div class="p-6 pt-0 flex space-x-3">
        <button class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-cute font-semibold transition-colors duration-200" 
                onclick="closeChangePassModal()">
          <span class="mr-2">âŒ</span>Há»§y
        </button>
        <button class="flex-1 px-6 py-3 bg-gradient-cute text-white rounded-xl font-cute font-semibold hover:shadow-cute transition-all duration-300" 
                onclick="submitChangePassword()">
          <span class="mr-2">ğŸ’¾</span>Äá»•i Máº­t Kháº©u
        </button>
      </div>
    </div>
  </div>

  <script>
    // Navigation Management
    function getPageFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('page') || '/employees';
    }

    function updateURL(page) {
      const newURL = `/dashboard?page=${encodeURIComponent(page)}`;
      window.history.pushState({page: page}, '', newURL);
    }

    function createSafeURL(page) {
      const cleanPage = page.endsWith('/') ? page.slice(0, -1) : page;
      return cleanPage;
    }

    function loadPage(page) {
      const iframe = document.getElementById('mainFrame');
      const safeURL = createSafeURL(page);
      
      // Add loading state
      iframe.classList.add('loading');
      
      // Update iframe
      iframe.src = safeURL;
      
      // Update active state
      document.querySelectorAll('.nav-link').forEach(l => {
        l.classList.remove('bg-gradient-to-r', 'from-cute-primary/10', 'to-cute-secondary/10', 'border-l-4', 'border-cute-primary');
        l.classList.remove('active');
      });
      const activeLink = document.querySelector(`[data-page="${page}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
        activeLink.classList.add('bg-gradient-to-r', 'from-cute-primary/10', 'to-cute-secondary/10', 'border-l-4', 'border-cute-primary');
      }
      
      // Update URL
      updateURL(page);
      
      // Remove loading state when loaded
      iframe.onload = function() {
        iframe.classList.remove('loading');
      };
    }

    // Mobile Menu Management
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');
      
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
    }

    function closeMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');
      
      sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
    }

    // Modal Management
    function openChangePassModal() {
      document.getElementById('changePassForm').reset();
      document.getElementById('changePassModal').classList.remove('hidden');
    }

    function closeChangePassModal() {
      document.getElementById('changePassModal').classList.add('hidden');
    }

    async function submitChangePassword() {
      const oldPass = document.getElementById('oldPassword').value.trim();
      const newPass = document.getElementById('newPassword').value.trim();
      const confirmPass = document.getElementById('confirmNewPassword').value.trim();

      if (!oldPass || !newPass || !confirmPass) {
        alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!");
        return;
      }

      if (newPass !== confirmPass) {
        alert("Máº­t kháº©u má»›i khÃ´ng trÃ¹ng khá»›p!");
        return;
      }

      const payload = { old_password: oldPass, new_password: newPass };

      try {
        const res = await fetch('/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        
        if (result.status === 'success') {
          alert("âœ… Äá»•i máº­t kháº©u thÃ nh cÃ´ng!");
          closeChangePassModal();
        } else {
          alert("âŒ Äá»•i máº­t kháº©u tháº¥t báº¡i: " + (result.message || "KhÃ´ng rÃµ lá»—i"));
        }
      } catch (err) {
        console.error(err);
        alert("âŒ Lá»—i káº¿t ná»‘i server!");
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Navigation
      document.querySelectorAll('.nav-link[data-page]').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = this.getAttribute('data-page');
          loadPage(page);
          closeMobileMenu();
        });
      });

      // Mobile menu
      document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
      document.getElementById('mobileOverlay').addEventListener('click', closeMobileMenu);

      // Modal close on background click
      document.getElementById('changePassModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeChangePassModal();
        }
      });

      // Initialize mobile sidebar state
      const sidebar = document.getElementById('sidebar');
      // Sidebar already has -translate-x-full class for mobile in HTML
      // Just ensure it's properly shown/hidden based on screen size
      function updateSidebarForScreenSize() {
        if (window.innerWidth >= 1024) {
          sidebar.classList.remove('-translate-x-full');
          document.getElementById('mobileOverlay').classList.add('hidden');
        } else {
          // Keep hidden on mobile until menu is clicked
          if (!sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.add('-translate-x-full');
          }
        }
      }
      
      updateSidebarForScreenSize();
      window.addEventListener('resize', updateSidebarForScreenSize);

      // Browser back/forward
      window.addEventListener('popstate', function(e) {
        const page = e.state?.page || getPageFromURL();
        const safeURL = createSafeURL(page);
        document.getElementById('mainFrame').src = safeURL;
        
        document.querySelectorAll('.nav-link').forEach(l => {
          l.classList.remove('bg-gradient-to-r', 'from-cute-primary/10', 'to-cute-secondary/10', 'border-l-4', 'border-cute-primary');
          l.classList.remove('active');
        });
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
          activeLink.classList.add('bg-gradient-to-r', 'from-cute-primary/10', 'to-cute-secondary/10', 'border-l-4', 'border-cute-primary');
        }
      });

      // Initialize
      const currentPage = getPageFromURL();
      const safeURL = createSafeURL(currentPage);
      document.getElementById('mainFrame').src = safeURL;
      
      const activeLink = document.querySelector(`[data-page="${currentPage}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
        activeLink.classList.add('bg-gradient-to-r', 'from-cute-primary/10', 'to-cute-secondary/10', 'border-l-4', 'border-cute-primary');
      }
      
      if (!window.location.search) {
        updateURL(currentPage);
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeMobileMenu();
        closeChangePassModal();
      }
    });
  </script>
</body>
</html>