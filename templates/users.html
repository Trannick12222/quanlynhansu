<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QU·∫¢N L√ù T√ÄI KHO·∫¢N</title>
  
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'neutral': {
              'primary': '#16a34a',
              'secondary': '#6b7280',
              'accent': '#8b9aa8',
              'muted': '#94a3b8',
              'light': '#cbd5e1',
              'lighter': '#e2e8f0',
              'lightest': '#f1f5f9'
            },
            'background': {
              'primary': '#f8fafc',
              'secondary': '#f1f5f9',
              'muted': '#e2e8f0',
              'card': '#ffffff'
            }
          },
          fontFamily: {
            'system': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
          }
        }
      }
    }
  </script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
    }
    .shadow-soft { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
    .shadow-soft-lg { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Modal styling */
    .modal-content {
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    .modal-header {
      background: #16a34a;
      color: white;
      border-bottom: 1px solid #e2e8f0;
      border-radius: 0.75rem 0.75rem 0 0;
    }
    .btn-close {
      filter: brightness(0) invert(1);
    }
  </style>
</head>

<body class="bg-background-primary min-h-screen font-system">
  <div class="container mx-auto px-6 py-6 max-w-full">
    <!-- Header Section -->
    <div class="bg-white rounded-xl shadow-soft-lg border border-neutral-lighter overflow-hidden mb-6">
      <div class="bg-neutral-primary p-6 text-white">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-users text-lg"></i>
            </div>
            <div>
              <h1 class="text-xl font-semibold">Qu·∫£n L√Ω T√†i Kho·∫£n</h1>
              <p class="text-white/80 text-sm">Qu·∫£n l√Ω ng∆∞·ªùi d√πng h·ªá th·ªëng</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-white font-semibold mb-1">T·ªïng: <span id="totalUserCount" class="text-lg">0</span></div>
            <div class="text-white/80 text-sm space-x-3">
              <span>Qu·∫£n Tr·ªã Vi√™n: <span id="adminCount" class="bg-red-500 px-2 py-1 rounded-full text-xs">0</span></span>
              <span>T·ªï Tr∆∞·ªüng: <span id="supervisorCount" class="bg-green-500 px-2 py-1 rounded-full text-xs">0</span></span>
              <span>Gi√°o Vi√™n: <span id="userCount" class="bg-neutral-muted px-2 py-1 rounded-full text-xs">0</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add User Form -->
    <div class="bg-white rounded-xl shadow-soft border border-neutral-lighter mb-6" id="addUserSection">
      <div class="bg-neutral-lightest px-6 py-4 border-b border-neutral-lighter">
        <h3 class="text-neutral-primary font-system font-semibold text-lg flex items-center">
          <span class="mr-2">‚ûï</span>T·∫°o T√†i Kho·∫£n M·ªõi
        </h3>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
          <div>
            <label class="block text-neutral-secondary font-system font-medium text-sm mb-2">T√™n T√†i Kho·∫£n</label>
            <input type="text" id="newUsername" class="w-full p-3 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system" placeholder="Username">
          </div>
          <div>
            <label class="block text-neutral-secondary font-system font-medium text-sm mb-2">M·∫≠t Kh·∫©u</label>
            <input type="password" id="newPassword" class="w-full p-3 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system" placeholder="Password">
          </div>
          <div>
            <label class="block text-neutral-secondary font-system font-medium text-sm mb-2">Quy·ªÅn H·∫°n</label>
            <select id="newRole" class="w-full p-3 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system">
              <option value="user">User</option>
              <option value="supervisor">Supervisor</option>
              <option value="admin">Administrator</option>
            </select>
          </div>
          <div>
            <label class="block text-neutral-secondary font-system font-medium text-sm mb-2">Password Expiry</label>
            <input type="date" id="newPasswordExpiry" class="w-full p-3 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system">
          </div>
          <div>
            <button class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-system font-medium transition-colors duration-200" onclick="addUser()">‚ûï Th√™m</button>
          </div>
          <div>
            <button class="w-full px-4 py-3 bg-neutral-primary hover:bg-neutral-secondary text-white rounded-lg font-system font-medium transition-colors duration-200" onclick="syncUser()">üîÑ ƒê·ªìng B·ªô</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-xl shadow-soft border border-neutral-lighter overflow-hidden">
      <div class="bg-neutral-lightest px-6 py-4 border-b border-neutral-lighter flex items-center justify-between">
        <h3 class="text-neutral-primary font-system font-semibold text-lg flex items-center">
          <span class="mr-2">üë•</span>Danh S√°ch T√†i Kho·∫£n Gi√°o Vi√™n
        </h3>
        <div class="w-64">
          <input type="text" class="w-full p-2 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system text-sm" id="searchUserInput" placeholder="üîç T√¨m ki·∫øm...">
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-neutral-lightest border-b border-neutral-lighter">
            <tr>
              <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" onclick="sortUserTable(0)">
                T√™n TK <span id="sort-icon-0" class="ml-1 text-xs">‚ñ≤</span>
              </th>
              <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" onclick="sortUserTable(1)">
                Quy·ªÅn <span id="sort-icon-1" class="ml-1 text-xs">‚ñ≤</span>
              </th>
              <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" onclick="sortUserTable(2)">
                Ng√†y T·∫°o <span id="sort-icon-2" class="ml-1 text-xs">‚ñ≤</span>
              </th>
              <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" onclick="sortUserTable(3)">
                Ng∆∞·ªùi T·∫°o <span id="sort-icon-3" class="ml-1 text-xs">‚ñ≤</span>
              </th>
              <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" onclick="sortUserTable(4)">
                Ng√†y H·∫øt H·∫°n <span id="sort-icon-4" class="ml-1 text-xs">‚ñ≤</span>
              </th>
              <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center">
                Action
              </th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <!-- Auto load data here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal ƒë·ªïi m·∫≠t kh·∫©u -->
  <div class="modal fade" id="changePassModal" tabindex="-1" aria-labelledby="changePassModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üîê ƒê·ªïi M·∫≠t Kh·∫©u</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="changePassUsername">
          <div class="mb-3">
            <label class="form-label">M·∫≠t Kh·∫©u M·ªõi</label>
            <input type="password" class="form-control" id="newPassInput">
          </div>
          <div class="text-end">
            <button class="btn btn-sm btn-primary" onclick="submitChangePass()">üíæ L∆∞u</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS for Modal -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- SEARCH ENGINE -->
  <script>
    document.getElementById("searchUserInput").addEventListener("keyup", function() {
      const value = this.value.toLowerCase();
      const rows = document.querySelectorAll("#userTableBody tr");
    
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(value) ? "" : "none";
      });
    });
  </script>

  <!--Count Users Realtime -->
  <script>
    function updateUserStats() {
      const rows = document.querySelectorAll("#userTableBody tr");
      let total = rows.length;
      let admin = 0;
      let supervisor = 0;
      let user = 0;

      rows.forEach(row => {
        const select = row.querySelector("select");
        const role = select ? select.value.toLowerCase() : "";

        if (role === "admin") {
          admin++;
        } else if (role === "supervisor") {
          supervisor++;
        } else if (role === "user") {
          user++;
        }
      });

      document.getElementById("totalUserCount").innerText = total;
      document.getElementById("adminCount").innerText = admin;
      document.getElementById("supervisorCount").innerText = supervisor;
      document.getElementById("userCount").innerText = user;
    }
    updateUserStats();
  </script>

  <script>
    let userSortDirection = {};

    function sortUserTable(colIndex, manual = true) {
      const table = document.querySelector("table");
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      const asc = manual ? !userSortDirection[colIndex] : true;
      userSortDirection[colIndex] = asc;

      rows.sort((a, b) => {
        let cellA = a.cells[colIndex].innerText.trim().toLowerCase();
        let cellB = b.cells[colIndex].innerText.trim().toLowerCase();

        const dateRegex = /^\d{1,2}\/\d{1,2}\/\d{4}$/;
        if (dateRegex.test(cellA) && dateRegex.test(cellB)) {
          const [d1, m1, y1] = cellA.split("/");
          const [d2, m2, y2] = cellB.split("/");
          cellA = new Date(`${y1}-${m1}-${d1}`);
          cellB = new Date(`${y2}-${m2}-${d2}`);
        }

        if (cellA < cellB) return asc ? -1 : 1;
        if (cellA > cellB) return asc ? 1 : -1;
        return 0;
      });

      rows.forEach(row => tbody.appendChild(row));

      // C·∫≠p nh·∫≠t icon m≈©i t√™n
      for (let i = 0; i <= 4; i++) {
        const icon = document.getElementById(`sort-icon-${i}`);
        if (icon) {
          if (i === colIndex) icon.innerText = asc ? "‚ñ≤" : "‚ñº";
          else icon.innerText = "‚ñ≤";
        }
      }
    }
  </script>
    
  <script>
    const userRole = '{{ session.get("role", "") }}';

    async function loadUsers() {
      const res = await fetch('/api/users');
      const users = await res.json();

      let html = "";

      if (users.length === 0) {
        html += '<tr><td colspan="6" class="px-4 py-12 text-center text-red-500 font-system">No user found!</td></tr>';
      } else {
        const today = new Date();

        users.forEach(u => {
          const expiryDate = new Date(u.password_expiry);
          const diffTime = expiryDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          const showReset = diffDays <= 7;

          html += `<tr class="hover:bg-neutral-lighter/30 transition-colors duration-200 border-b border-neutral-lighter">
            <td class="px-4 py-3 font-system text-neutral-secondary text-center font-medium">${u.username}</td>
            <td class="px-4 py-3 text-center">
              <select class="p-2 border border-neutral-light rounded font-system text-sm focus:border-neutral-primary focus:outline-none transition-colors duration-200" onchange="updateRole('${u.username}', this.value)" ${userRole !== 'admin' ? 'disabled' : ''}>
                <option value="user" ${u.role === 'user' ? 'selected' : ''}>User</option>
                <option value="supervisor" ${u.role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Administrator</option>
              </select>
            </td>
            <td class="px-4 py-3 font-system text-neutral-secondary text-center">${u.created_date || ''}</td>
            <td class="px-4 py-3 font-system text-neutral-secondary text-center">${u.created_by || ''}</td>
            <td class="px-4 py-3 font-system text-neutral-secondary text-center">${u.password_expiry || ''}</td>
            <td class="px-4 py-3 text-center">
              <div class="space-x-1 space-y-1">
                <button class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded font-system transition-colors duration-200" onclick="deleteUser('${u.username}')" ${userRole !== 'admin' ? 'disabled' : ''}>üóë X√≥a</button>
                ${userRole === 'admin' ? `<button class="px-2 py-1 bg-neutral-muted hover:bg-neutral-secondary text-white text-xs rounded font-system transition-colors duration-200" onclick="openChangePassModal('${u.username}')">üîê ƒê·ªïi MK</button>` : ''}
                ${u.password_expiry !== 'Unexpired' && showReset && userRole === 'admin' ? 
                  `<button class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded font-system transition-colors duration-200" onclick="resetPassword('${u.username}')">üîÅ Kh·ªüi t·∫°o MK</button>` 
                  : ''}
              </div>
            </td>
          </tr>`;
        });
      }

      document.getElementById('userTableBody').innerHTML = html;
      updateUserStats();
    }

    async function addUser() {
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value.trim();
      const role = document.getElementById('newRole').value;
      let passwordExpiry = document.getElementById('newPasswordExpiry').value;

      if (!username || !password) {
        alert('Username and password are required.');
        return;
      }

      if (role === 'admin') {
        passwordExpiry = 'Unexpired';
      } else {
        if (!passwordExpiry) {
          alert('Please select password expiry date for regular users.');
          return;
        }
      }

      const res = await fetch('/api/users/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, role, password_expiry: passwordExpiry })
      });

      const data = await res.json();
      alert(data.message);
      if (data.clear_fields) {
        document.getElementById('newUsername').value = "";
        document.getElementById('newPassword').value = "";
        document.getElementById('newRole').value = "user";
        document.getElementById('newPasswordExpiry').value = "";
      }
      loadUsers(); 
    }

    async function deleteUser(username) {
      if (!confirm(`Confirm delete user "${username}"?`)) return;

      let res = await fetch('/api/users/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ten_tk: username })
      });
      let data = await res.json();

      if (data.status === 'pending') {
        const relatedInfo = JSON.stringify(data.related, null, 2);
        if (!confirm(`User "${username}" has related data:\n\n${relatedInfo}\n\nDo you want to delete everything?`)) {
          alert("Cancelled.");
          return;
        }

        res = await fetch('/api/users/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ten_tk: username, confirm: true })
        });
        data = await res.json();
      }

      alert(data.message);
      loadUsers();
    }

    async function updateRole(username, role) {
      const res = await fetch('/api/users/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, role })
      });

      const data = await res.json();
      alert(data.message);
      loadUsers();
    }

    async function resetPassword(username) {
      if (!confirm(`Reset password for user "${username}"?`)) return;

      const res = await fetch('/api/users/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      });

      const data = await res.json();
      alert(`Password reset successful!\nNew password: ${data.new_pass}`);
      loadUsers();
    }

    function openChangePassModal(username) {
      document.getElementById("changePassUsername").value = username;
      document.getElementById("newPassInput").value = '';
      const modal = new bootstrap.Modal(document.getElementById('changePassModal'));
      modal.show();
    }

    async function submitChangePass() {
      const username = document.getElementById("changePassUsername").value;
      const newPassword = document.getElementById("newPassInput").value;

      if (!newPassword) {
        alert("Please enter a new password.");
        return;
      }

      const res = await fetch('/api/users/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ ten_tk: username, new_password: newPassword })
      });

      const result = await res.json();
      if (res.ok) {
        alert(`Password for "${username}" changed successfully!`);
        bootstrap.Modal.getInstance(document.getElementById('changePassModal')).hide();
      } else {
        alert(`Failed to change password: ${result.error || 'Unknown error'}`);
      }
    }

    async function syncUser() {
      if (!confirm('Sync users from MySQL employees table?')) return;
      const res = await fetch('/api/users/sync', { method: 'POST' });
      const data = await res.json();
      alert(`Synced: Created ${data.created} | Skipped ${data.skipped}`);
      loadUsers();
    }

    window.onload = function () {
      loadUsers();

      if (userRole !== 'admin') {
        document.getElementById('addUserSection').style.display = 'none';
        const userLink = document.getElementById('userLink');
        if (userLink) {
          userLink.classList.add('disabled');
          userLink.setAttribute('aria-disabled', 'true');
          userLink.style.pointerEvents = 'none';
        }
      }
    }
  </script>
</body>
</html>