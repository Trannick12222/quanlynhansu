<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Xu·∫•t D·ªØ Li·ªáu</title>
<link href="{{ url_for('static_files', filename='css/styles.css') }}?v=20250716" rel="stylesheet"/>
<link href="{{ url_for('static_files', filename='css/scrollbar.css') }}" rel="stylesheet"/>
<style>
.nav {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.nav a {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 12px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.nav a:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

.nav a:active {
    transform: translateY(0);
}

.header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.header .school-logo {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid #667eea;
    margin-right: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.header-content h1 {
    color: #2d3748;
    font-size: 24px;
    font-weight: 600;
    margin: 0 0 5px 0;
}

.header-content p {
    color: #6b7280;
    font-size: 14px;
    margin: 0;
}

.form-group {
    margin: 20px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.form-group label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 8px;
    display: block;
}

.form-select {
    padding: 10px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.table-wrapper {
    margin-top: 20px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.table {
    margin: 0;
}

.table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 12px 8px;
    font-size: 13px;
}

.table td {
    padding: 10px 8px;
    font-size: 13px;
    vertical-align: middle;
    border-bottom: 1px solid #e2e8f0;
}

.table tbody tr:hover {
    background-color: #f7fafc;
}

#info-title {
    color: #2d3748;
    font-size: 20px;
    font-weight: 600;
    margin: 25px 0;
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    text-align: center;
}

/* PDF Export specific styles */
#pdf-export {
    font-family: 'Times New Roman', Times, serif !important;
    line-height: 1.2;
}

#pdf-export img {
    max-width: 100%;
    height: auto;
    object-fit: contain;
}

#pdf-export .header-section {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #0d6efd;
    padding-bottom: 15px;
}

#pdf-export table {
    page-break-inside: auto;
    border-collapse: collapse;
    width: 100%;
}

#pdf-export tr {
    page-break-inside: avoid;
    page-break-after: auto;
}

#pdf-export td, #pdf-export th {
    page-break-inside: avoid;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

@media print {
    #pdf-export {
        font-family: 'Times New Roman', Times, serif !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
    
    #pdf-export img {
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
}
</style>
</head>
<body><div class="container-fluid mt-4"><div class="card"><div class="card-body">
<div class="container-fluid">
    
    <div class="header">
        <img src="{{ url_for('static_files', filename='mnhhd.jpg') }}" 
             alt="Logo Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng" 
             class="school-logo">
        <div class="header-content">
            <h1>üì§ Xu·∫•t D·ªØ Li·ªáu</h1>
            <p>Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</p>
        </div>
    </div>
    
    <div class="nav">
        <a href="#" onclick="exportToPDF()">üìÑ Xu·∫•t file PDF</a>
        <a href="#" onclick="exportToExcel()">üìä Xu·∫•t File Excel</a>
        <a href="#" onclick="exportData()">üì§ Xu·∫•t File CSV</a>
        <a href="#" onclick="printData()">üñ®Ô∏è In D·ªØ Li·ªáu</a>
    </div>

    <div class="form-group">
        <label for="deptSelect">Ch·ªçn Th√¥ng Tin:</label>
            <select class="form-select form-select-sm" id="deptSelect" style="width: 250px;" onchange="switchDept()">
                <option value="">-- Ch·ªçn --</option>
                <option value="HS">üëß H·ªçc Sinh</option>
                <option value="GV">üë©‚Äçüè´ Gi√°o Vi√™n</option>
        </select>
    </div>

    <div id="preview">
        <h2 id="info-title" style="text-align:center;">TH√îNG TIN <span id="dept-name-1"></span></h2>
        <div class="table-wrapper">
            <table class="table" id="table_hs" style="display: none;">
            <thead>
                <tr>
                <th>STT</th>
                <th>H·ªç v√† T√™n</th>
                <th>Ng√†y Sinh</th>
                <th>Gi·ªõi T√≠nh</th>
                <th>D√¢n T·ªôc</th>
                <th>M√£ ƒê·ªãnh Danh</th>
                <th>H·ªç T√™n Cha</th>
                <th>Ng√†nh Ngh·ªÅ Cha</th>
                <th>H·ªç T√™n M·∫π</th>
                <th>Ng√†nh Ngh·ªÅ M·∫π</th>
                <th>ƒê·ªãa Ch·ªâ</th>
                <th>S·ªë CMND Cha M·∫π</th>
                <th>S·ªë ƒêi·ªán Tho·∫°i Cha M·∫π</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="13">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                </tr>
            </tbody>
            </table>
        </div>

        <div class="table-wrapper">
            <table class="table" id="table_gv" style="display: none;">
                <thead>
                    <tr>
                    <th>STT</th>
                    <th>M√£ Gi√°o Vi√™n</th>
                    <th>H·ªç v√† T√™n</th>
                    <th>T√™n G·ªçi</th>
                    <th>ƒê·ªôi</th>
                    <th>Ng√†y Sinh</th>
                    <th>Qu√™ Qu√°n</th>
                    <th>CCCD</th>
                    <th>Ng√†y C·∫•p CCCD</th>
                    <th>M√£ S·ªë Thu·∫ø</th>
                    <th>S·ªë CMND</th>
                    <th>S·ªë BHXH</th>
                    <th>S·ªë ƒêi·ªán Tho·∫°i</th>
                    <th>S·ªë T√†i Kho·∫£n</th>
                    <th>Email</th>
                    <th>Nh√≥m M√°u</th>
                    <th>ƒê·ªãa Ch·ªâ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="17">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="pdf-export" style="display:none; font-family: 'Times New Roman', Times, serif; font-size: 13px; padding: 20px;">
        <div class="header-section" style="display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #0d6efd; padding-bottom: 15px;">
            <img src="{{ url_for('static_files', filename='mnhhd.jpg') }}" 
                 style="width: 80px; height: 80px; margin-right: 20px; border-radius: 50%; border: 2px solid #28a745;" 
                 alt="Logo Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng">
            <div style="flex: 1; text-align: center;">
                <h5 style="margin: 0; font-size: 12px; font-weight: normal; color: #6c757d;">UBND X√É ƒêINH VƒÇN - L√ÇM H√Ä</h5>
                <h4 style="margin: 5px 0; font-size: 14px; font-weight: bold; color: #dc3545;">TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG</h4>
                <h3 style="margin: 10px 0; font-size: 16px; font-weight: bold; color: #0d6efd;">DANH S√ÅCH <span id="dept-name"></span></h3>
            </div>
        </div>
        <table style="width:100%; border-collapse: collapse; text-align:center; font-size: 10px;">
            <thead style="background-color: #4472C4; color: #FFFFFF;">
                <tr id="pdf-header-row"></tr>
            </thead>
            <tbody id="pdf-body"></tbody>
        </table>
    <div style="margin-top:10px; text-align:right; font-size:12px; padding-right:40px;">
        <p style="padding-right:60px;">........, Ng√†y .... th√°ng .... nƒÉm 20....</p>
        <p style="margin-top:5px; padding-right:80px;"><b>Ng∆∞·ªùi Xu·∫•t D·ªØ Li·ªáu</b></p>
        <p style="margin-top:5px; padding-right:110px;"><b>K√Ω t√™n</b></p>
        <p style="margin-top:55px; padding-right:100px">.................................</p>
    </div>          
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
        console.log("üöÄ Export Data Script Loaded - Version 5.1 - ExcelJS Fixed Button Issue!");
        console.log("üé® New styling features:", {
            schoolTitle: "Times New Roman 18pt, white on blue",
            headers: "Arial 12pt, white on dark blue", 
            dataRows: "Arial 11pt with borders",
            summary: "Enhanced with colors and borders"
        });
        async function switchDept() {
            console.log("üîÑ switchDept called");
            const dept = document.getElementById("deptSelect").value;
            console.log("üìã Selected dept:", dept);
            
            const containerHS = document.getElementById("table_hs");
            const containerGV = document.getElementById("table_gv");
            
            if (!containerHS || !containerGV) {
                console.error("‚ùå Table containers not found!");
                return;
            }
            
            containerHS.style.display = (dept === "HS") ? "block" : "none";
            containerGV.style.display = (dept === "GV") ? "block" : "none";
            
            console.log("üëÅÔ∏è Table visibility - HS:", containerHS.style.display, "GV:", containerGV.style.display);
            
            // Update both dept name elements
            const deptNameEl1 = document.getElementById("dept-name-1");
            const deptNameEl2 = document.getElementById("dept-name");
            const deptText = dept === "HS" ? "H·ªåC SINH" : dept === "GV" ? "GI√ÅO VI√äN" : "";
            
            if (deptNameEl1) {
                deptNameEl1.textContent = deptText;
                console.log("üìù Dept name 1 updated:", deptNameEl1.textContent);
            }
            if (deptNameEl2) {
                deptNameEl2.textContent = deptText;
                console.log("üìù Dept name 2 updated:", deptNameEl2.textContent);
            }
                
            if (dept) {
                await fetchAndRenderDept(dept);
            }
        }

        async function fetchAndRenderDept(dept) {
            console.log("üåê Fetching data for dept:", dept);
            try {
                const url = `/api/employees?dept=${dept}`;
                console.log("üì° API URL:", url);
                
                const res = await fetch(url);
                console.log("üìä Response status:", res.status);
                
                const result = await res.json();
                console.log("üìã API result:", result);
                
                const rows = result.rows || [];
                console.log("üìù Rows count:", rows.length);
                
                if (dept === "HS") {
                    console.log("üéì Rendering HS table");
                    renderTable("table_hs", rows);
                } else if (dept === "GV") {
                    console.log("üë©‚Äçüè´ Rendering GV table");
                    renderTable("table_gv", rows);
                }
            } catch (error) {
                console.error('‚ùå Error fetching data:', error);
                const tableId = dept === "HS" ? "table_hs" : "table_gv";
                const table = document.getElementById(tableId);
                if (table) {
                    const tbody = table.querySelector("tbody");
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="${dept === "HS" ? 13 : 17}">L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}</td></tr>`;
                    }
                }
            }
        }

        function renderTable(tableId, rows) {
            console.log("üé® renderTable called with:", tableId, "rows:", rows.length);
            
            const table = document.getElementById(tableId);
            if (!table) {
                console.error("‚ùå Table not found:", tableId);
                return;
            }
            
            const tbody = table.querySelector("tbody");
            if (!tbody) {
                console.error("‚ùå Tbody not found in table:", tableId);
                return;
            }
            
            console.log("‚úÖ Table and tbody found, clearing content");
            tbody.innerHTML = "";
            
            if (rows.length === 0) {
                console.log("üì≠ No data, showing empty message");
                tbody.innerHTML = `<tr><td colspan="${tableId === "table_hs" ? 13 : 17}">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`;
                return;
            }
            
            console.log("üìù Rendering", rows.length, "rows");
            rows.forEach((row, idx) => {
                const tr = document.createElement("tr");
                tr.innerHTML = generateRowHtml(tableId, row, idx + 1);
                tbody.appendChild(tr);
            });
        }

        function generateRowHtml(tableId, row, index) {
            if (tableId === "table_hs") {
                return `
                <td>${index}</td>
                <td>${row.ho_va_ten || ""}</td>
                <td>${formatDate(row.ngay_sinh)}</td>
                <td>${row.gioi_tinh || ""}</td>
                <td>${row.dan_toc || ""}</td>
                <td>${row.ma_dinh_danh || ""}</td>
                <td>${row.ho_ten_bo || ""}</td>
                <td>${row.nghe_nghiep_bo || ""}</td>
                <td>${row.ho_ten_me || ""}</td>
                <td>${row.nghe_nghiep_me || ""}</td>
                <td>${row.ho_khau || ""}</td>
                <td>${row.cccd_bo_me || ""}</td>
                <td>${row.sdt || ""}</td>
                `;
            }
            if (tableId === "table_gv") {
                return `
                <td>${index}</td>
                <td>${row.ma_gv || ""}</td>
                <td>${row.ho_va_ten || ""}</td>
                <td>${row.ten_tk || ""}</td>
                <td>${row.chuc_vu || ""}</td>
                <td>${formatDate(row.ngay_sinh)}</td>
                <td>${row.que_quan || ""}</td>
                <td>${row.cccd || ""}</td>
                <td>${formatDate(row.ngay_cap)}</td>
                <td>${row.mst || ""}</td>
                <td>${row.cmnd || ""}</td>
                <td>${row.so_bh || ""}</td>
                <td>${row.sdt || ""}</td>
                <td>${row.tk_nh || ""}</td>
                <td>${row.email || ""}</td>
                <td>${row.nhom_mau || ""}</td>
                <td>${row.dia_chi || ""}</td>
                `;
            }
            return "";
        }

        function formatDate(dateStr) {
            if (!dateStr || isNaN(new Date(dateStr))) return "";
            const d = new Date(dateStr);
            return d.getDate().toString().padStart(2, '0') + "/" +
                   (d.getMonth() + 1).toString().padStart(2, '0') + "/" +
                   d.getFullYear();
        }

        function exportToPDF() {
            const dept = document.getElementById("deptSelect").value;
            if (!dept) {
                alert("Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu.");
                return;
            }

            const sourceTableId = dept === "HS" ? "table_hs" : "table_gv";
            const sourceTable = document.getElementById(sourceTableId);
            const rows = sourceTable.querySelectorAll("tbody tr");

            if (rows.length === 0 || (rows.length === 1 && rows[0].textContent.includes('Ch∆∞a c√≥ d·ªØ li·ªáu'))) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t PDF.");
                return;
            }

            try {
                // Show loading state
                event.target.innerHTML = '‚è≥ ƒêang xu·∫•t PDF...';
                event.target.style.pointerEvents = 'none';

                // Show the hidden element temporarily
                const element = document.getElementById('pdf-export');
                element.style.display = 'block';
                
                // Clear and populate the hidden PDF export element
                const pdfHeaderRow = document.getElementById('pdf-header-row');
                const pdfBody = document.getElementById('pdf-body');
                
                console.log('PDF Export elements found:', {
                    element: !!element,
                    pdfHeaderRow: !!pdfHeaderRow,
                    pdfBody: !!pdfBody,
                    sourceTableRows: rows.length
                });
                
                // Set department name
                const deptNameSpan = document.querySelector('#pdf-export #dept-name');
                if (deptNameSpan) {
                    deptNameSpan.textContent = dept === "HS" ? "H·ªåC SINH" : "GI√ÅO VI√äN";
                } else {
                    console.log('Warning: dept-name span not found');
                }
                
                // Copy header
                const headerCells = sourceTable.querySelectorAll('thead th');
                console.log('Header cells found:', headerCells.length);
                
                pdfHeaderRow.innerHTML = '';
                let headerCount = 0;
                headerCells.forEach((th, index) => {
                    if (dept === "GV" && (th.textContent.includes('M√£ Gi√°o Vi√™n') || th.textContent.includes('T√™n G·ªçi'))) {
                        return; // Skip these columns for better fit
                    }
                    const cell = document.createElement('th');
                    cell.textContent = th.textContent;
                    cell.style.border = '2px solid #000';
                    cell.style.padding = '6px';
                    cell.style.fontSize = '11px';
                    cell.style.fontWeight = 'bold';
                    cell.style.textAlign = 'center';
                    cell.style.backgroundColor = '#4472C4';
                    cell.style.color = '#FFFFFF';
                    pdfHeaderRow.appendChild(cell);
                    headerCount++;
                });
                console.log('Headers added to PDF:', headerCount);
                
                // Copy data rows
                pdfBody.innerHTML = '';
                let rowCount = 0;
                rows.forEach(row => {
                    if (row.textContent.includes('Ch∆∞a c√≥ d·ªØ li·ªáu')) return;
                    
                    const newRow = document.createElement('tr');
                    const cells = row.querySelectorAll('td');
                    let cellCount = 0;
                    
                    cells.forEach((td, index) => {
                        if (dept === "GV" && (index === 1 || index === 3)) {
                            return; // Skip same columns
                        }
                        const cell = document.createElement('td');
                        cell.textContent = td.textContent.trim();
                        cell.style.border = '1px solid #333';
                        cell.style.padding = '4px';
                        cell.style.fontSize = '10px';
                        cell.style.textAlign = 'center';
                        cell.style.backgroundColor = '#FFFFFF';
                        cell.style.color = '#000000';
                        newRow.appendChild(cell);
                        cellCount++;
                    });
                    
                    if (cellCount > 0) {
                        pdfBody.appendChild(newRow);
                        rowCount++;
                    }
                });
                console.log('Data rows added to PDF:', rowCount);

                // Check if we have content to export
                if (rowCount === 0) {
                    element.style.display = 'none';
                    alert('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t PDF. Vui l√≤ng ch·ªçn d·ªØ li·ªáu tr∆∞·ªõc.');
                    return;
                }

                // Wait a bit for DOM to update, then generate PDF
                setTimeout(() => {
                    console.log('Starting PDF generation...');
                    console.log('Element dimensions:', element.offsetWidth, 'x', element.offsetHeight);
                    
                    const opt = {
                        margin: [5, 5, 5, 5],
                        filename: `danh_sach_${dept === 'HS' ? 'hoc_sinh' : 'giao_vien'}_${new Date().toISOString().slice(0,10).replace(/-/g, '')}.pdf`,
                        image: { type: 'jpeg', quality: 0.95 },
                        html2canvas: { 
                            scale: 1.5,
                            useCORS: false,
                            letterRendering: true,
                            allowTaint: false,
                            logging: false,
                            backgroundColor: '#ffffff',
                            removeContainer: false
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a3', 
                            orientation: 'landscape'
                        },
                        pagebreak: { 
                            mode: 'avoid-all',
                            before: '.page-break',
                            after: '.page-break'
                        }
                    };

                    html2pdf().set(opt).from(element).save().then(() => {
                        console.log('PDF generation successful');
                        element.style.display = 'none';
                        alert('‚úÖ ƒê√£ xu·∫•t th√†nh c√¥ng file PDF v·ªõi font ti·∫øng Vi·ªát!');
                    }).catch(error => {
                        console.error('PDF export error:', error);
                        element.style.display = 'none';
                        alert(`‚ùå L·ªói xu·∫•t PDF: ${error.message}`);
                    });
                }, 1000);

            } catch (error) {
                console.error('PDF export error:', error);
                alert(`‚ùå L·ªói xu·∫•t PDF: ${error.message}`);
            } finally {
                // Restore button state
                event.target.innerHTML = 'üìÑ Xu·∫•t file PDF';
                event.target.style.pointerEvents = 'auto';
            }
        }

        function printData() {
            const dept = document.getElementById("deptSelect").value;
            const table = dept === "HS" ? document.getElementById("table_hs") : document.getElementById("table_gv");

            if (!dept || table.style.display === "none") {
                alert("Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu c·∫ßn in.");
                return;
            }

            const printWindow = window.open('', '_blank');
            const style = `
            <style>
                table {
                width: 100%;
                border-collapse: collapse;
                font-family: Arial, sans-serif;
                }
                th, td {
                border: 1px solid #ccc;
                padding: 8px;
                font-size: 10px;
                }
                th {
                background-color: #007bff;
                color: #fff;
                text-align: center;
                }
                tr:nth-child(even) {
                background-color: #f9f9f9;
                }
            </style>
            `;
            printWindow.document.write(`
            <html>
                <head>
                    <title>In D·ªØ Li·ªáu</title>
                    ${style}
                </head>
                <body>
                    <h2>DANH S√ÅCH ${dept === "HS" ? "H·ªåC SINH" : "GI√ÅO VI√äN"}</h2>
                    ${table.outerHTML}
                </body>
            </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        async function exportToExcel() {
            const dept = document.getElementById("deptSelect").value;
            if (!dept) {
                alert("Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu ƒë·ªÉ xu·∫•t Excel.");
                return;
            }
            
            // Get data from the visible table
            const tableId = dept === 'HS' ? 'table_hs' : 'table_gv';
            const table = document.getElementById(tableId);
            const tableRows = table.querySelectorAll('tbody tr');
            
            if (table.style.display === 'none' || tableRows.length === 0) {
                alert("Vui l√≤ng ch·ªçn v√† t·∫£i d·ªØ li·ªáu tr∆∞·ªõc khi xu·∫•t Excel.");
                return;
            }
            
            const button = event.target; // Save button reference
            try {
                // Show loading state
                button.innerHTML = '‚è≥ ƒêang xu·∫•t...';
                button.style.pointerEvents = 'none';
                
                // Use ExcelJS library for client-side Excel generation with full styling support
                if (typeof ExcelJS === 'undefined') {
                    console.log("üì¶ Loading ExcelJS library...");
                    // Load ExcelJS library dynamically - supports full styling
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
                    document.head.appendChild(script);
                    
                    await new Promise((resolve, reject) => {
                        script.onload = () => {
                            console.log("‚úÖ ExcelJS library loaded successfully!");
                            resolve();
                        };
                        script.onerror = () => {
                            console.error("‚ùå Failed to load ExcelJS library!");
                            reject(new Error("Failed to load ExcelJS library"));
                        };
                        // Timeout after 10 seconds
                        setTimeout(() => {
                            reject(new Error("ExcelJS library load timeout"));
                        }, 10000);
                    });
                }
                
                // Verify ExcelJS is available
                if (typeof ExcelJS === 'undefined') {
                    throw new Error("ExcelJS library is not available");
                }
                console.log("üìö ExcelJS library ready - supports full styling!");
                
                // Prepare data
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
                const dataRows = [];
                
                Array.from(tableRows).forEach(row => {
                    const rowData = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                    if (rowData.length > 0 && !rowData[0].includes('Ch∆∞a c√≥ d·ªØ li·ªáu')) {
                        dataRows.push(rowData);
                    }
                });
                
                // Create workbook with ExcelJS for full styling support
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet(dept === 'HS' ? 'Danh S√°ch H·ªçc Sinh' : 'Danh S√°ch Gi√°o Vi√™n');
                
                console.log("üé® Creating Excel with ExcelJS - full styling support!");
                
                // Add school header information
                worksheet.addRow(['TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG']);
                worksheet.addRow(['H·ªÜ TH·ªêNG QU·∫¢N L√ù NH√ÇN S·ª∞']);
                worksheet.addRow([]);
                worksheet.addRow([`B√ÅO C√ÅO: ${dept === 'HS' ? 'DANH S√ÅCH H·ªåC SINH' : 'DANH S√ÅCH GI√ÅO VI√äN'}`]);
                worksheet.addRow([`Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}`]);
                worksheet.addRow([`Th·ªùi gian: ${new Date().toLocaleTimeString('vi-VN')}`]);
                worksheet.addRow([]);
                
                // Add headers
                const headerRow = worksheet.addRow(headers);
                const headerRowIndex = 8; // 1-indexed
                
                // Add data rows
                dataRows.forEach(rowData => {
                    worksheet.addRow(rowData);
                });
                
                // Add summary
                worksheet.addRow([]);
                worksheet.addRow(['TH·ªêNG K√ä T·ªîNG H·ª¢P']);
                worksheet.addRow([`T·ªïng s·ªë ${dept === 'HS' ? 'h·ªçc sinh' : 'gi√°o vi√™n'}: ${dataRows.length}`]);
                worksheet.addRow([`Xu·∫•t b·ªüi: ${document.querySelector('.user-name')?.textContent || 'Admin'}`]);
                worksheet.addRow([`H·ªá th·ªëng: Qu·∫£n l√Ω nh√¢n s·ª± - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng`]);
                
                console.log("üìä Added all data to worksheet, now applying styling...");
                
                // Apply ExcelJS styling - much more powerful than SheetJS
                
                // Style school title (Row 1)
                const schoolTitleCell = worksheet.getCell('A1');
                schoolTitleCell.font = { name: 'Times New Roman', size: 18, bold: true, color: { argb: 'FFFFFFFF' } };
                schoolTitleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2E5090' } };
                schoolTitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
                schoolTitleCell.border = {
                    top: { style: 'thick' }, bottom: { style: 'thick' },
                    left: { style: 'thick' }, right: { style: 'thick' }
                };
                worksheet.mergeCells(`A1:${String.fromCharCode(64 + headers.length)}1`);
                
                // Style subtitle (Row 2)
                const subtitleCell = worksheet.getCell('A2');
                subtitleCell.font = { name: 'Times New Roman', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
                subtitleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };
                subtitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
                subtitleCell.border = {
                    top: { style: 'medium' }, bottom: { style: 'medium' },
                    left: { style: 'thick' }, right: { style: 'thick' }
                };
                worksheet.mergeCells(`A2:${String.fromCharCode(64 + headers.length)}2`);
                
                // Style report title (Row 4)
                const reportTitleCell = worksheet.getCell('A4');
                reportTitleCell.font = { name: 'Times New Roman', size: 16, bold: true, color: { argb: 'FFC5504B' } };
                reportTitleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF2CC' } };
                reportTitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
                reportTitleCell.border = {
                    top: { style: 'medium', color: { argb: 'FFC5504B' } },
                    bottom: { style: 'medium', color: { argb: 'FFC5504B' } },
                    left: { style: 'medium', color: { argb: 'FFC5504B' } },
                    right: { style: 'medium', color: { argb: 'FFC5504B' } }
                };
                worksheet.mergeCells(`A4:${String.fromCharCode(64 + headers.length)}4`);
                
                console.log("‚ú® Applied header styling with ExcelJS!");
                
                // Style date/time info (Rows 5-6)
                ['A5', 'A6'].forEach(cellAddr => {
                    const cell = worksheet.getCell(cellAddr);
                    cell.font = { name: 'Arial', size: 11, italic: true, color: { argb: 'FF666666' } };
                    cell.alignment = { horizontal: 'left', vertical: 'middle' };
                });
                
                // Style column headers (Row 8)
                headers.forEach((header, colIndex) => {
                    const cell = worksheet.getCell(headerRowIndex, colIndex + 1);
                    cell.font = { name: 'Arial', size: 12, bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2E5090' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                    cell.border = {
                        top: { style: 'medium' }, bottom: { style: 'medium' },
                        left: { style: 'medium' }, right: { style: 'medium' }
                    };
                });
                
                // Style data rows with alternating colors
                dataRows.forEach((rowData, rowIndex) => {
                    const actualRowIndex = headerRowIndex + 1 + rowIndex;
                    const isEvenRow = rowIndex % 2 === 0;
                    const fillColor = isEvenRow ? 'FFF8F9FA' : 'FFFFFFFF';
                    
                    rowData.forEach((cellData, colIndex) => {
                        const cell = worksheet.getCell(actualRowIndex, colIndex + 1);
                        cell.font = { name: 'Arial', size: 11, color: { argb: 'FF333333' } };
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
                        cell.alignment = { 
                            horizontal: colIndex === 0 ? 'center' : 'left', 
                            vertical: 'middle',
                            wrapText: true 
                        };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                        };
                    });
                });
                
                console.log("üé® Applied data row styling with alternating colors!");
                
                // Set column widths
                headers.forEach((header, index) => {
                    let maxLength = header.length;
                    dataRows.forEach(row => {
                        if (row[index] && row[index].toString().length > maxLength) {
                            maxLength = row[index].toString().length;
                        }
                    });
                    const width = Math.min(Math.max(maxLength + 3, 12), 60);
                    worksheet.getColumn(index + 1).width = width;
                });
                
                // Set row heights
                worksheet.getRow(1).height = 35; // School name
                worksheet.getRow(2).height = 25; // Subtitle
                worksheet.getRow(4).height = 30; // Report title
                worksheet.getRow(5).height = 18; // Date
                worksheet.getRow(6).height = 18; // Time
                worksheet.getRow(headerRowIndex).height = 35; // Headers
                
                // Set data row heights
                for (let i = 0; i < dataRows.length; i++) {
                    worksheet.getRow(headerRowIndex + 1 + i).height = 22;
                }
                
                // Generate filename
                const now = new Date();
                const dateStr = now.toLocaleDateString('vi-VN').replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('vi-VN', { hour12: false }).replace(/:/g, '');
                const typeStr = dept === 'HS' ? 'HocSinh' : 'GiaoVien';
                const filename = `BaoCao_${typeStr}_${dateStr}_${timeStr}.xlsx`;
                
                // Save file with ExcelJS
                console.log("üíæ Saving Excel file with ExcelJS enhanced formatting:", filename);
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
                
                console.log("‚ú® ExcelJS styling applied successfully!");
                
                // Show enhanced success message
                const successMsg = `‚úÖ Xu·∫•t Excel th√†nh c√¥ng v·ªõi ExcelJS!\n\n` +
                    `üìÅ File: ${filename}\n` +
                    `üìä Lo·∫°i d·ªØ li·ªáu: ${dept === 'HS' ? 'H·ªçc sinh' : 'Gi√°o vi√™n'}\n` +
                    `üìà S·ªë b·∫£n ghi: ${dataRows.length}\n` +
                    `‚è∞ Th·ªùi gian: ${now.toLocaleString('vi-VN')}\n\n` +
                    `üí° File ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng chuy√™n nghi·ªáp v·ªõi ExcelJS:\n` +
                    `‚Ä¢ Header tr∆∞·ªùng v·ªõi m√†u xanh ƒë·∫≠m v√† ch·ªØ tr·∫Øng\n` +
                    `‚Ä¢ B·∫£ng d·ªØ li·ªáu v·ªõi khung v√† m√†u xen k·∫Ω\n` +
                    `‚Ä¢ Font ch·ªØ Times New Roman cho ti√™u ƒë·ªÅ, Arial cho d·ªØ li·ªáu\n` +
                    `‚Ä¢ Row heights v√† column widths t·ªëi ∆∞u\n` +
                    `‚Ä¢ Th·ªëng k√™ t·ªïng h·ª£p v·ªõi styling`;
                
                alert(successMsg);
                
            } catch (error) {
                console.error('Excel export error:', error);
                alert(`‚ùå L·ªói xu·∫•t Excel: ${error.message}`);
            } finally {
                // Restore button state
                button.innerHTML = 'üìä Xu·∫•t File Excel';
                button.style.pointerEvents = 'auto';
            }
        }

        function exportData() {
            const dataType = document.getElementById('deptSelect').value;
            let csvContent = '';
            let filename = '';
            let rows = [];
            // Get data from the visible table
            const tableId = dataType === 'HS' ? 'table_hs' : 'table_gv';
            const table = document.getElementById(tableId).querySelector('tbody');
            const tableRows = table.querySelectorAll('tr');
            if (dataType === 'HS') {
                filename = 'student_data.csv';
                csvContent = [
                    'STT,H·ªç v√† T√™n,Ng√†y Sinh,Gi·ªõi T√≠nh,D√¢n T·ªôc,M√£ ƒê·ªãnh Danh,H·ªç T√™n Cha,Ng√†nh Ngh·ªÅ Cha,H·ªç T√™n M·∫π,Ng√†nh Ngh·ªÅ M·∫π,ƒê·ªãa Ch·ªâ,CMND Cha M·∫π, SƒêT PH',
                    ...Array.from(tableRows).map((row, idx) => {
                        const cells = row.querySelectorAll('td');
                        return [
                            cells[0].textContent,
                            `"${cells[1].textContent}"`,
                            cells[2].textContent,
                            cells[3].textContent,
                            cells[4].textContent,
                            cells[5].textContent,
                            `"${cells[6].textContent}"`,
                            `"${cells[7].textContent}"`,
                            `"${cells[8].textContent}"`,
                            `"${cells[9].textContent}"`,
                            `"${cells[10].textContent}"`,
                            cells[11].textContent,
                            cells[12].textContent
                        ].join(',');
                    })
                ].join('\n');
            } else if (dataType === 'GV') {
                filename = 'teacher_data.csv';
                csvContent = [
                    'STT,M√£ Gi√°o Vi√™n,H·ªç v√† T√™n,T√™n G·ªçi,ƒê·ªôi,Ng√†y Sinh,Qu√™ Qu√°n,CCCD,Ng√†y C·∫•p CCCD,M√£ S·ªë Thu·∫ø,S·ªë CMND,S·ªë BHXH,S·ªë ƒêi·ªán Tho·∫°i,S·ªë T√†i Kho·∫£n,Email,Nh√≥m M√°u,ƒê·ªãa Ch·ªâ',
                    ...Array.from(tableRows).map((row, idx) => {
                        const cells = row.querySelectorAll('td');
                        return [
                            cells[0].textContent,
                            cells[1].textContent,
                            `"${cells[2].textContent}"`,
                            `"${cells[3].textContent}"`,
                            `"${cells[4].textContent}"`,
                            cells[5].textContent,
                            `"${cells[6].textContent}"`,
                            cells[7].textContent,
                            cells[8].textContent,
                            cells[9].textContent,
                            cells[10].textContent,
                            cells[11].textContent,
                            cells[12].textContent,
                            cells[13].textContent,
                            cells[14].textContent,
                            cells[15].textContent,
                            `"${cells[16].textContent}"`
                        ].join(',');
                    })
                ].join('\n');
            }
            if (csvContent && dataType) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            } else {
                alert('Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu tr∆∞·ªõc khi xu·∫•t.');
            }
        }

        function closePreview() {
            document.getElementById('preview').style.display = 'none';
            document.getElementById('data-type').value = '';
            document.getElementById('table_hs').style.display = 'none';
            document.getElementById('table_gv').style.display = 'none';
        }
    </script>
</div>
</div>
</div>
</body>
</html>