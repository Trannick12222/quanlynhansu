<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>üå∏ Xu·∫•t D·ªØ Li·ªáu - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'kindergarten': {
            'pink': '#d1fae5',
            'yellow': '#f0fdf4',
            'blue': '#ecfdf5',
            'green': '#16a34a',
            'orange': '#15803d',
            'purple': '#166534',
            'coral': '#14532d'
          },
          'cute': {
            'primary': '#16a34a',
            'secondary': '#15803d', 
            'success': '#16a34a',
            'warning': '#fef3c7',
            'danger': '#dc2626',
            'info': '#d1fae5',
            'light': '#FFF8DC',
            'dark': '#4A4A4A'
          }
        },
        fontFamily: {
          'cute': ['Fredoka', 'Comic Sans MS', 'cursive', 'sans-serif'],
          'inter': ['Inter', 'system-ui', 'sans-serif']
        },
        animation: {
          'bounce-slow': 'bounce 2s infinite',
          'wiggle': 'wiggle 1s ease-in-out infinite',
          'float': 'float 3s ease-in-out infinite',
          'pulse-slow': 'pulse 3s infinite'
        },
        keyframes: {
          wiggle: {
            '0%, 100%': { transform: 'rotate(-3deg)' },
            '50%': { transform: 'rotate(3deg)' },
          },
          float: {
            '0%, 100%': { transform: 'translateY(0px)' },
            '50%': { transform: 'translateY(-10px)' },
          }
        }
      }
    }
  }
</script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
.font-cute { font-family: 'Fredoka', 'Comic Sans MS', cursive, sans-serif; }
.shadow-cute { box-shadow: 0 10px 25px -5px rgba(22, 163, 74, 0.3), 0 4px 6px -2px rgba(22, 163, 74, 0.05); }
.shadow-cute-lg { box-shadow: 0 20px 40px -12px rgba(22, 163, 74, 0.4), 0 8px 16px -4px rgba(22, 163, 74, 0.1); }
.gradient-cute { background: linear-gradient(135deg, #16a34a 0%, #15803d 50%, #14532d 100%); }
.gradient-cute-blue { background: linear-gradient(135deg, #15803d 0%, #16a34a 100%); }
.gradient-cute-pink { background: linear-gradient(135deg, #16a34a 0%, #d1fae5 100%); }
.gradient-cute-yellow { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }

/* Custom scrollbar */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #d1fae5; border-radius: 10px; }
::-webkit-scrollbar-thumb { background: #16a34a; border-radius: 10px; border: 2px solid #d1fae5; }
::-webkit-scrollbar-thumb:hover { background: #15803d; }

/* PDF Export specific styles */
#pdf-export {
    font-family: 'Times New Roman', Times, serif !important;
    line-height: 1.2;
}

#pdf-export img {
    max-width: 100%;
    height: auto;
    object-fit: contain;
}

#pdf-export .header-section {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #0d6efd;
    padding-bottom: 15px;
}

#pdf-export table {
    page-break-inside: auto;
    border-collapse: collapse;
    width: 100%;
}

#pdf-export tr {
    page-break-inside: avoid;
    page-break-after: auto;
}

#pdf-export td, #pdf-export th {
    page-break-inside: avoid;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

@media print {
    #pdf-export {
        font-family: 'Times New Roman', Times, serif !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
    
    #pdf-export img {
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
}
</style>
</head>
<body class="bg-gradient-to-br from-kindergarten-pink/20 via-kindergarten-blue/20 to-kindergarten-green/20 min-h-screen font-inter">
<div class="container mx-auto p-4 max-w-full">
  <div class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-cute-lg border border-white/60 overflow-hidden">
    <div class="p-6">
      <!-- Header Section -->
      <div class="gradient-cute p-6 rounded-2xl mb-8 text-center relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-white/20 to-transparent"></div>
        <div class="relative z-10 flex items-center justify-center space-x-6">
          <div class="w-20 h-20 rounded-full border-4 border-white/30 shadow-cute-lg overflow-hidden animate-float">
            <img src="{{ url_for('static_files', filename='mnhhd.jpg') }}" 
                 alt="üå∏" 
                 class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
          </div>
          <div>
            <h1 class="text-white font-cute font-bold text-3xl leading-tight mb-2 animate-pulse-slow">
              üì§ XU·∫§T D·ªÆ LI·ªÜU
            </h1>
            <p class="text-white/90 text-sm font-semibold tracking-wider font-cute animate-bounce-slow">
              ‚ú® TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG ‚ú®
            </p>
          </div>
        </div>
        <!-- Decorative elements -->
        <div class="absolute top-2 left-2 text-white/20 text-2xl animate-spin-slow">üåü</div>
        <div class="absolute top-4 right-4 text-white/20 text-xl animate-bounce">ü¶ã</div>
        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-white/20 text-lg animate-wiggle">üåà</div>
      </div>
    
      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-4 mb-8">
        <button onclick="exportToPDF()" class="px-6 py-3 bg-gradient-to-r from-red-400 to-red-500 text-white rounded-xl font-cute font-bold hover:shadow-cute transition-all duration-300 group hover:from-red-500 hover:to-red-600">
          <i class="fas fa-file-pdf group-hover:animate-bounce mr-2"></i>Xu·∫•t file PDF
        </button>
        <button onclick="exportToExcel()" class="px-6 py-3 bg-gradient-to-r from-kindergarten-green to-cute-success text-white rounded-xl font-cute font-bold hover:shadow-cute transition-all duration-300 group">
          <i class="fas fa-file-excel group-hover:animate-bounce mr-2"></i>Xu·∫•t File Excel
        </button>

        <button onclick="printData()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-cute font-bold hover:shadow-cute hover:from-blue-600 hover:to-blue-700 transition-all duration-300 group">
          <i class="fas fa-print group-hover:animate-wiggle mr-2"></i>In D·ªØ Li·ªáu
        </button>
      </div>

      <!-- Form Group -->
      <div class="bg-gradient-to-r from-cute-light/50 to-white/50 p-6 rounded-2xl border-l-4 border-cute-primary shadow-cute mb-8">
        <label for="deptSelect" class="block text-gray-700 font-cute font-bold text-lg mb-4">
          <span class="mr-2">üéØ</span>Ch·ªçn Th√¥ng Tin:
        </label>
        <select class="w-full max-w-xs p-4 border-2 border-gray-200 rounded-xl focus:border-cute-primary focus:outline-none transition-colors duration-200 font-cute font-semibold bg-white shadow-cute" 
                id="deptSelect" onchange="switchDept()">
          <option value="">-- Ch·ªçn lo·∫°i d·ªØ li·ªáu --</option>
          <option value="HS">üë∂ H·ªçc Sinh</option>
          <option value="GV">üë©‚Äçüè´ Gi√°o Vi√™n</option>
        </select>
      </div>

      <!-- Preview Section -->
      <div id="preview">
        <div class="gradient-cute-blue p-4 rounded-2xl mb-6 text-center">
          <h2 class="text-white font-cute font-bold text-2xl" id="info-title">
            üåü TH√îNG TIN <span id="dept-name-1"></span> üåü
          </h2>
        </div>
        
        <!-- Student Table -->
        <div class="bg-white/80 backdrop-blur-lg rounded-2xl shadow-cute-lg border border-white/60 overflow-x-auto mb-6" style="display: none;" id="table_hs_wrapper">
          <div class="text-center text-xs text-gray-500 font-cute py-2 bg-gradient-to-r from-kindergarten-pink/10 to-kindergarten-blue/10">
            <i class="fas fa-arrows-alt-h mr-1"></i>Cu·ªôn ngang ƒë·ªÉ xem t·∫•t c·∫£ th√¥ng tin üëÜ
          </div>
          <div class="min-w-max">
            <table class="w-full" id="table_hs">
            <thead class="gradient-cute">
              <tr>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-16">STT</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-48">H·ªç v√† T√™n</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-32">Ng√†y Sinh</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-28">Gi·ªõi T√≠nh</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-24">D√¢n T·ªôc</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-36">M√£ ƒê·ªãnh Danh</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-40">H·ªç T√™n Cha</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-40">Ng√†nh Ngh·ªÅ Cha</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-40">H·ªç T√™n M·∫π</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-40">Ng√†nh Ngh·ªÅ M·∫π</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-60">ƒê·ªãa Ch·ªâ</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-36">S·ªë CMND Cha M·∫π</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-40">S·ªë ƒêi·ªán Tho·∫°i Cha M·∫π</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="13" class="px-6 py-12 text-center text-gray-500">
                  <div class="flex flex-col items-center space-y-4">
                    <span class="text-6xl animate-bounce">üë∂</span>
                    <div class="font-cute text-lg">Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc sinh</div>
                  </div>
                </td>
              </tr>
            </tbody>
            </table>
          </div>
        </div>

        <!-- Teacher Table -->
        <div class="bg-white/80 backdrop-blur-lg rounded-2xl shadow-cute-lg border border-white/60 overflow-x-auto" style="display: none;" id="table_gv_wrapper">
          <div class="text-center text-xs text-gray-500 font-cute py-2 bg-gradient-to-r from-kindergarten-green/10 to-kindergarten-yellow/10">
            <i class="fas fa-arrows-alt-h mr-1"></i>Cu·ªôn ngang ƒë·ªÉ xem t·∫•t c·∫£ th√¥ng tin üëÜ
          </div>
          <div class="min-w-max">
            <table class="w-full" id="table_gv">
            <thead class="gradient-cute">
              <tr>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-16">STT</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-32">M√£ Gi√°o Vi√™n</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-48">H·ªç v√† T√™n</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-32">T√™n G·ªçi</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-32">ƒê·ªôi</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-32">Ng√†y Sinh</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-48">Qu√™ Qu√°n</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-36">CCCD</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-36">Ng√†y C·∫•p CCCD</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-32">M√£ S·ªë Thu·∫ø</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-32">S·ªë CMND</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-32">S·ªë BHXH</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-36">S·ªë ƒêi·ªán Tho·∫°i</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-40">S·ªë T√†i Kho·∫£n</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-48">Email</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-28">Nh√≥m M√°u</th>
                <th class="px-4 py-3 text-white font-cute font-bold text-sm text-center min-w-60">ƒê·ªãa Ch·ªâ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="17" class="px-6 py-12 text-center text-gray-500">
                  <div class="flex flex-col items-center space-y-4">
                    <span class="text-6xl animate-bounce">üë©‚Äçüè´</span>
                    <div class="font-cute text-lg">Ch∆∞a c√≥ d·ªØ li·ªáu gi√°o vi√™n</div>
                  </div>
                </td>
              </tr>
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="pdf-export" style="display:none; font-family: 'Times New Roman', Times, serif; font-size: 13px; padding: 20px;">
        <div class="header-section" style="display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #0d6efd; padding-bottom: 15px;">
            <img src="{{ url_for('static_files', filename='mnhhd.jpg') }}" 
                 style="width: 80px; height: 80px; margin-right: 20px; border-radius: 50%; border: 2px solid #28a745;" 
                 alt="Logo Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng">
            <div style="flex: 1; text-align: center;">
                <h5 style="margin: 0; font-size: 12px; font-weight: normal; color: #6c757d;">UBND X√É ƒêINH VƒÇN - L√ÇM H√Ä</h5>
                <h4 style="margin: 5px 0; font-size: 14px; font-weight: bold; color: #dc3545;">TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG</h4>
                <h3 style="margin: 10px 0; font-size: 16px; font-weight: bold; color: #0d6efd;">DANH S√ÅCH <span id="dept-name"></span></h3>
            </div>
        </div>
        <table style="width:100%; border-collapse: collapse; text-align:center; font-size: 10px;">
            <thead style="background-color: #4472C4; color: #FFFFFF;">
                <tr id="pdf-header-row"></tr>
            </thead>
            <tbody id="pdf-body"></tbody>
        </table>
    <div style="margin-top:10px; text-align:right; font-size:12px; padding-right:40px;">
        <p style="padding-right:60px;">........, Ng√†y .... th√°ng .... nƒÉm 20....</p>
        <p style="margin-top:5px; padding-right:80px;"><b>Ng∆∞·ªùi Xu·∫•t D·ªØ Li·ªáu</b></p>
        <p style="margin-top:5px; padding-right:110px;"><b>K√Ω t√™n</b></p>
        <p style="margin-top:55px; padding-right:100px">.................................</p>
    </div>          
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
        console.log("üöÄ Export Data Script Loaded - Version 5.1 - ExcelJS Fixed Button Issue!");
        console.log("üé® New styling features:", {
            schoolTitle: "Times New Roman 18pt, white on blue",
            headers: "Arial 12pt, white on dark blue", 
            dataRows: "Arial 11pt with borders",
            summary: "Enhanced with colors and borders"
        });
        async function switchDept() {
            console.log("üîÑ switchDept called");
            const dept = document.getElementById("deptSelect").value;
            console.log("üìã Selected dept:", dept);
            
            const containerHS = document.getElementById("table_hs");
            const containerGV = document.getElementById("table_gv");
            
            if (!containerHS || !containerGV) {
                console.error("‚ùå Table containers not found!");
                return;
            }
            
            const wrapperHS = document.getElementById("table_hs_wrapper");
            const wrapperGV = document.getElementById("table_gv_wrapper");
            
            if (wrapperHS) wrapperHS.style.display = (dept === "HS") ? "block" : "none";
            if (wrapperGV) wrapperGV.style.display = (dept === "GV") ? "block" : "none";
            
            containerHS.style.display = (dept === "HS") ? "table" : "none";
            containerGV.style.display = (dept === "GV") ? "table" : "none";
            
            console.log("üëÅÔ∏è Table visibility - HS:", containerHS.style.display, "GV:", containerGV.style.display);
            
            // Update both dept name elements
            const deptNameEl1 = document.getElementById("dept-name-1");
            const deptNameEl2 = document.getElementById("dept-name");
            const deptText = dept === "HS" ? "H·ªåC SINH" : dept === "GV" ? "GI√ÅO VI√äN" : "";
            
            if (deptNameEl1) {
                deptNameEl1.textContent = deptText;
                console.log("üìù Dept name 1 updated:", deptNameEl1.textContent);
            }
            if (deptNameEl2) {
                deptNameEl2.textContent = deptText;
                console.log("üìù Dept name 2 updated:", deptNameEl2.textContent);
            }
                
            if (dept) {
                await fetchAndRenderDept(dept);
            }
        }

        async function fetchAndRenderDept(dept) {
            console.log("üåê Fetching data for dept:", dept);
            try {
                const url = `/api/employees?dept=${dept}`;
                console.log("üì° API URL:", url);
                
                const res = await fetch(url);
                console.log("üìä Response status:", res.status);
                
                const result = await res.json();
                console.log("üìã API result:", result);
                
                const rows = result.rows || [];
                console.log("üìù Rows count:", rows.length);
                
                if (dept === "HS") {
                    console.log("üéì Rendering HS table");
                    renderTable("table_hs", rows);
                } else if (dept === "GV") {
                    console.log("üë©‚Äçüè´ Rendering GV table");
                    renderTable("table_gv", rows);
                }
            } catch (error) {
                console.error('‚ùå Error fetching data:', error);
                const tableId = dept === "HS" ? "table_hs" : "table_gv";
                const table = document.getElementById(tableId);
                if (table) {
                    const tbody = table.querySelector("tbody");
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="${dept === "HS" ? 13 : 17}">L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}</td></tr>`;
                    }
                }
            }
        }

        function renderTable(tableId, rows) {
            console.log("üé® renderTable called with:", tableId, "rows:", rows.length);
            
            const table = document.getElementById(tableId);
            if (!table) {
                console.error("‚ùå Table not found:", tableId);
                return;
            }
            
            const tbody = table.querySelector("tbody");
            if (!tbody) {
                console.error("‚ùå Tbody not found in table:", tableId);
                return;
            }
            
            console.log("‚úÖ Table and tbody found, clearing content");
            tbody.innerHTML = "";
            
            if (rows.length === 0) {
                console.log("üì≠ No data, showing empty message");
                tbody.innerHTML = `<tr><td colspan="${tableId === "table_hs" ? 13 : 17}">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`;
                return;
            }
            
            console.log("üìù Rendering", rows.length, "rows");
            rows.forEach((row, idx) => {
                const tr = document.createElement("tr");
                tr.className = "hover:bg-kindergarten-pink/10 transition-colors duration-200 border-b border-gray-100";
                tr.innerHTML = generateRowHtml(tableId, row, idx + 1);
                tbody.appendChild(tr);
            });
        }

        function generateRowHtml(tableId, row, index) {
            if (tableId === "table_hs") {
                return `
                <td class="px-4 py-3 font-cute font-semibold text-gray-600 text-center min-w-16">${index}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-48">${row.ho_va_ten || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-32">${formatDate(row.ngay_sinh)}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-28">${row.gioi_tinh === 'N·ªØ' ? 'üëß N·ªØ' : 'üë¶ ' + (row.gioi_tinh || '')}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-24">${row.dan_toc || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-36">${row.ma_dinh_danh || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-40">${row.ho_ten_bo || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-40">${row.nghe_nghiep_bo || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-40">${row.ho_ten_me || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-40">${row.nghe_nghiep_me || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-60">${row.ho_khau || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-36">${row.cccd_bo_me || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-40">${row.sdt || ""}</td>
                `;
            }
            if (tableId === "table_gv") {
                return `
                <td class="px-4 py-3 font-cute font-semibold text-gray-600 text-center min-w-16">${index}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-32">${row.ma_gv || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-48">${row.ho_va_ten || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-32">${row.ten_tk || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-32">${row.chuc_vu || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-32">${formatDate(row.ngay_sinh)}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-48">${row.que_quan || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-36">${row.cccd || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-36">${formatDate(row.ngay_cap)}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-32">${row.mst || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-32">${row.cmnd || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-32">${row.so_bh || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-36">${row.sdt || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-40">${row.tk_nh || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-48">${row.email || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 text-center min-w-28">${row.nhom_mau || ""}</td>
                <td class="px-4 py-3 font-cute text-gray-700 min-w-60">${row.dia_chi || ""}</td>
                `;
            }
            return "";
        }

        function formatDate(dateStr) {
            if (!dateStr || isNaN(new Date(dateStr))) return "";
            const d = new Date(dateStr);
            return d.getDate().toString().padStart(2, '0') + "/" +
                   (d.getMonth() + 1).toString().padStart(2, '0') + "/" +
                   d.getFullYear();
        }

        function exportToPDF() {
            const dept = document.getElementById("deptSelect").value;
            if (!dept) {
                alert("Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu.");
                return;
            }

            const sourceTableId = dept === "HS" ? "table_hs" : "table_gv";
            const sourceTable = document.getElementById(sourceTableId);
            const rows = sourceTable.querySelectorAll("tbody tr");

            if (rows.length === 0 || (rows.length === 1 && rows[0].textContent.includes('Ch∆∞a c√≥ d·ªØ li·ªáu'))) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t PDF.");
                return;
            }

            try {
                // Show loading state
                event.target.innerHTML = '‚è≥ ƒêang xu·∫•t PDF...';
                event.target.style.pointerEvents = 'none';

                // Show the hidden element temporarily
                const element = document.getElementById('pdf-export');
                element.style.display = 'block';
                
                // Clear and populate the hidden PDF export element
                const pdfHeaderRow = document.getElementById('pdf-header-row');
                const pdfBody = document.getElementById('pdf-body');
                
                console.log('PDF Export elements found:', {
                    element: !!element,
                    pdfHeaderRow: !!pdfHeaderRow,
                    pdfBody: !!pdfBody,
                    sourceTableRows: rows.length
                });
                
                // Set department name
                const deptNameSpan = document.querySelector('#pdf-export #dept-name');
                if (deptNameSpan) {
                    deptNameSpan.textContent = dept === "HS" ? "H·ªåC SINH" : "GI√ÅO VI√äN";
                } else {
                    console.log('Warning: dept-name span not found');
                }
                
                // Copy header
                const headerCells = sourceTable.querySelectorAll('thead th');
                console.log('Header cells found:', headerCells.length);
                
                pdfHeaderRow.innerHTML = '';
                let headerCount = 0;
                headerCells.forEach((th, index) => {
                    if (dept === "GV" && (th.textContent.includes('M√£ Gi√°o Vi√™n') || th.textContent.includes('T√™n G·ªçi'))) {
                        return; // Skip these columns for better fit
                    }
                    const cell = document.createElement('th');
                    cell.textContent = th.textContent;
                    cell.style.border = '2px solid #000';
                    cell.style.padding = '6px';
                    cell.style.fontSize = '11px';
                    cell.style.fontWeight = 'bold';
                    cell.style.textAlign = 'center';
                    cell.style.backgroundColor = '#4472C4';
                    cell.style.color = '#FFFFFF';
                    pdfHeaderRow.appendChild(cell);
                    headerCount++;
                });
                console.log('Headers added to PDF:', headerCount);
                
                // Copy data rows
                pdfBody.innerHTML = '';
                let rowCount = 0;
                rows.forEach(row => {
                    if (row.textContent.includes('Ch∆∞a c√≥ d·ªØ li·ªáu')) return;
                    
                    const newRow = document.createElement('tr');
                    const cells = row.querySelectorAll('td');
                    let cellCount = 0;
                    
                    cells.forEach((td, index) => {
                        if (dept === "GV" && (index === 1 || index === 3)) {
                            return; // Skip same columns
                        }
                        const cell = document.createElement('td');
                        cell.textContent = td.textContent.trim();
                        cell.style.border = '1px solid #333';
                        cell.style.padding = '4px';
                        cell.style.fontSize = '10px';
                        cell.style.textAlign = 'center';
                        cell.style.backgroundColor = '#FFFFFF';
                        cell.style.color = '#000000';
                        newRow.appendChild(cell);
                        cellCount++;
                    });
                    
                    if (cellCount > 0) {
                        pdfBody.appendChild(newRow);
                        rowCount++;
                    }
                });
                console.log('Data rows added to PDF:', rowCount);

                // Check if we have content to export
                if (rowCount === 0) {
                    element.style.display = 'none';
                    alert('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t PDF. Vui l√≤ng ch·ªçn d·ªØ li·ªáu tr∆∞·ªõc.');
                    return;
                }

                // Wait a bit for DOM to update, then generate PDF
                setTimeout(() => {
                    console.log('Starting PDF generation...');
                    console.log('Element dimensions:', element.offsetWidth, 'x', element.offsetHeight);
                    
                    const opt = {
                        margin: [5, 5, 5, 5],
                        filename: `danh_sach_${dept === 'HS' ? 'hoc_sinh' : 'giao_vien'}_${new Date().toISOString().slice(0,10).replace(/-/g, '')}.pdf`,
                        image: { type: 'jpeg', quality: 0.95 },
                        html2canvas: { 
                            scale: 1.5,
                            useCORS: false,
                            letterRendering: true,
                            allowTaint: false,
                            logging: false,
                            backgroundColor: '#ffffff',
                            removeContainer: false
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a3', 
                            orientation: 'landscape'
                        },
                        pagebreak: { 
                            mode: 'avoid-all',
                            before: '.page-break',
                            after: '.page-break'
                        }
                    };

                    html2pdf().set(opt).from(element).save().then(() => {
                        console.log('PDF generation successful');
                        element.style.display = 'none';
                        alert('‚úÖ ƒê√£ xu·∫•t th√†nh c√¥ng file PDF v·ªõi font ti·∫øng Vi·ªát!');
                    }).catch(error => {
                        console.error('PDF export error:', error);
                        element.style.display = 'none';
                        alert(`‚ùå L·ªói xu·∫•t PDF: ${error.message}`);
                    });
                }, 1000);

            } catch (error) {
                console.error('PDF export error:', error);
                alert(`‚ùå L·ªói xu·∫•t PDF: ${error.message}`);
            } finally {
                // Restore button state
                event.target.innerHTML = 'üìÑ Xu·∫•t file PDF';
                event.target.style.pointerEvents = 'auto';
            }
        }

        function printData() {
            const dept = document.getElementById("deptSelect").value;
            const table = dept === "HS" ? document.getElementById("table_hs") : document.getElementById("table_gv");
            const wrapper = dept === "HS" ? document.getElementById("table_hs_wrapper") : document.getElementById("table_gv_wrapper");

            if (!dept || wrapper.style.display === "none") {
                alert("Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu c·∫ßn in.");
                return;
            }

            const printWindow = window.open('', '_blank');
            const style = `
            <style>
                table {
                width: 100%;
                border-collapse: collapse;
                font-family: Arial, sans-serif;
                }
                th, td {
                border: 1px solid #ccc;
                padding: 8px;
                font-size: 10px;
                }
                th {
                background-color: #007bff;
                color: #fff;
                text-align: center;
                }
                tr:nth-child(even) {
                background-color: #f9f9f9;
                }
            </style>
            `;
            printWindow.document.write(`
            <html>
                <head>
                    <title>In D·ªØ Li·ªáu</title>
                    ${style}
                </head>
                <body>
                    <h2>DANH S√ÅCH ${dept === "HS" ? "H·ªåC SINH" : "GI√ÅO VI√äN"}</h2>
                    ${table.outerHTML}
                </body>
            </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        async function exportToExcel() {
            const dept = document.getElementById("deptSelect").value;
            if (!dept) {
                alert("Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu ƒë·ªÉ xu·∫•t Excel.");
                return;
            }
            
            // Get data from the visible table
            const tableId = dept === 'HS' ? 'table_hs' : 'table_gv';
            const table = document.getElementById(tableId);
            const tableRows = table.querySelectorAll('tbody tr');
            
            const wrapper = dept === 'HS' ? document.getElementById('table_hs_wrapper') : document.getElementById('table_gv_wrapper');
            if (wrapper.style.display === 'none' || tableRows.length === 0) {
                alert("Vui l√≤ng ch·ªçn v√† t·∫£i d·ªØ li·ªáu tr∆∞·ªõc khi xu·∫•t Excel.");
                return;
            }
            
            const button = event.target; // Save button reference
            try {
                // Show loading state
                button.innerHTML = '‚è≥ ƒêang xu·∫•t...';
                button.style.pointerEvents = 'none';
                
                // Use ExcelJS library for client-side Excel generation with full styling support
                if (typeof ExcelJS === 'undefined') {
                    console.log("üì¶ Loading ExcelJS library...");
                    // Load ExcelJS library dynamically - supports full styling
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
                    document.head.appendChild(script);
                    
                    await new Promise((resolve, reject) => {
                        script.onload = () => {
                            console.log("‚úÖ ExcelJS library loaded successfully!");
                            resolve();
                        };
                        script.onerror = () => {
                            console.error("‚ùå Failed to load ExcelJS library!");
                            reject(new Error("Failed to load ExcelJS library"));
                        };
                        // Timeout after 10 seconds
                        setTimeout(() => {
                            reject(new Error("ExcelJS library load timeout"));
                        }, 10000);
                    });
                }
                
                // Verify ExcelJS is available
                if (typeof ExcelJS === 'undefined') {
                    throw new Error("ExcelJS library is not available");
                }
                console.log("üìö ExcelJS library ready - supports full styling!");
                
                // Prepare data
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
                const dataRows = [];
                
                Array.from(tableRows).forEach(row => {
                    const rowData = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                    if (rowData.length > 0 && !rowData[0].includes('Ch∆∞a c√≥ d·ªØ li·ªáu')) {
                        dataRows.push(rowData);
                    }
                });
                
                // Create workbook with ExcelJS for full styling support
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet(dept === 'HS' ? 'Danh S√°ch H·ªçc Sinh' : 'Danh S√°ch Gi√°o Vi√™n');
                
                console.log("üé® Creating Excel with ExcelJS - full styling support!");
                
                // Add school header information
                worksheet.addRow(['TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG']);
                worksheet.addRow(['H·ªÜ TH·ªêNG QU·∫¢N L√ù NH√ÇN S·ª∞']);
                worksheet.addRow([]);
                worksheet.addRow([`B√ÅO C√ÅO: ${dept === 'HS' ? 'DANH S√ÅCH H·ªåC SINH' : 'DANH S√ÅCH GI√ÅO VI√äN'}`]);
                worksheet.addRow([`Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}`]);
                worksheet.addRow([`Th·ªùi gian: ${new Date().toLocaleTimeString('vi-VN')}`]);
                worksheet.addRow([]);
                
                // Add headers
                const headerRow = worksheet.addRow(headers);
                const headerRowIndex = 8; // 1-indexed
                
                // Add data rows
                dataRows.forEach(rowData => {
                    worksheet.addRow(rowData);
                });
                
                // Add summary
                worksheet.addRow([]);
                worksheet.addRow(['TH·ªêNG K√ä T·ªîNG H·ª¢P']);
                worksheet.addRow([`T·ªïng s·ªë ${dept === 'HS' ? 'h·ªçc sinh' : 'gi√°o vi√™n'}: ${dataRows.length}`]);
                worksheet.addRow([`Xu·∫•t b·ªüi: ${document.querySelector('.user-name')?.textContent || 'Admin'}`]);
                worksheet.addRow([`H·ªá th·ªëng: Qu·∫£n l√Ω nh√¢n s·ª± - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng`]);
                
                console.log("üìä Added all data to worksheet, now applying styling...");
                
                // Apply ExcelJS styling - much more powerful than SheetJS
                
                // Style school title (Row 1)
                const schoolTitleCell = worksheet.getCell('A1');
                schoolTitleCell.font = { name: 'Times New Roman', size: 18, bold: true, color: { argb: 'FFFFFFFF' } };
                schoolTitleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2E5090' } };
                schoolTitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
                schoolTitleCell.border = {
                    top: { style: 'thick' }, bottom: { style: 'thick' },
                    left: { style: 'thick' }, right: { style: 'thick' }
                };
                worksheet.mergeCells(`A1:${String.fromCharCode(64 + headers.length)}1`);
                
                // Style subtitle (Row 2)
                const subtitleCell = worksheet.getCell('A2');
                subtitleCell.font = { name: 'Times New Roman', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
                subtitleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };
                subtitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
                subtitleCell.border = {
                    top: { style: 'medium' }, bottom: { style: 'medium' },
                    left: { style: 'thick' }, right: { style: 'thick' }
                };
                worksheet.mergeCells(`A2:${String.fromCharCode(64 + headers.length)}2`);
                
                // Style report title (Row 4)
                const reportTitleCell = worksheet.getCell('A4');
                reportTitleCell.font = { name: 'Times New Roman', size: 16, bold: true, color: { argb: 'FFC5504B' } };
                reportTitleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF2CC' } };
                reportTitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
                reportTitleCell.border = {
                    top: { style: 'medium', color: { argb: 'FFC5504B' } },
                    bottom: { style: 'medium', color: { argb: 'FFC5504B' } },
                    left: { style: 'medium', color: { argb: 'FFC5504B' } },
                    right: { style: 'medium', color: { argb: 'FFC5504B' } }
                };
                worksheet.mergeCells(`A4:${String.fromCharCode(64 + headers.length)}4`);
                
                console.log("‚ú® Applied header styling with ExcelJS!");
                
                // Style date/time info (Rows 5-6)
                ['A5', 'A6'].forEach(cellAddr => {
                    const cell = worksheet.getCell(cellAddr);
                    cell.font = { name: 'Arial', size: 11, italic: true, color: { argb: 'FF666666' } };
                    cell.alignment = { horizontal: 'left', vertical: 'middle' };
                });
                
                // Style column headers (Row 8)
                headers.forEach((header, colIndex) => {
                    const cell = worksheet.getCell(headerRowIndex, colIndex + 1);
                    cell.font = { name: 'Arial', size: 12, bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2E5090' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                    cell.border = {
                        top: { style: 'medium' }, bottom: { style: 'medium' },
                        left: { style: 'medium' }, right: { style: 'medium' }
                    };
                });
                
                // Style data rows with alternating colors
                dataRows.forEach((rowData, rowIndex) => {
                    const actualRowIndex = headerRowIndex + 1 + rowIndex;
                    const isEvenRow = rowIndex % 2 === 0;
                    const fillColor = isEvenRow ? 'FFF8F9FA' : 'FFFFFFFF';
                    
                    rowData.forEach((cellData, colIndex) => {
                        const cell = worksheet.getCell(actualRowIndex, colIndex + 1);
                        cell.font = { name: 'Arial', size: 11, color: { argb: 'FF333333' } };
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
                        cell.alignment = { 
                            horizontal: colIndex === 0 ? 'center' : 'left', 
                            vertical: 'middle',
                            wrapText: true 
                        };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                        };
                    });
                });
                
                console.log("üé® Applied data row styling with alternating colors!");
                
                // Set column widths
                headers.forEach((header, index) => {
                    let maxLength = header.length;
                    dataRows.forEach(row => {
                        if (row[index] && row[index].toString().length > maxLength) {
                            maxLength = row[index].toString().length;
                        }
                    });
                    const width = Math.min(Math.max(maxLength + 3, 12), 60);
                    worksheet.getColumn(index + 1).width = width;
                });
                
                // Set row heights
                worksheet.getRow(1).height = 35; // School name
                worksheet.getRow(2).height = 25; // Subtitle
                worksheet.getRow(4).height = 30; // Report title
                worksheet.getRow(5).height = 18; // Date
                worksheet.getRow(6).height = 18; // Time
                worksheet.getRow(headerRowIndex).height = 35; // Headers
                
                // Set data row heights
                for (let i = 0; i < dataRows.length; i++) {
                    worksheet.getRow(headerRowIndex + 1 + i).height = 22;
                }
                
                // Generate filename
                const now = new Date();
                const dateStr = now.toLocaleDateString('vi-VN').replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('vi-VN', { hour12: false }).replace(/:/g, '');
                const typeStr = dept === 'HS' ? 'HocSinh' : 'GiaoVien';
                const filename = `BaoCao_${typeStr}_${dateStr}_${timeStr}.xlsx`;
                
                // Save file with ExcelJS
                console.log("üíæ Saving Excel file with ExcelJS enhanced formatting:", filename);
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
                
                console.log("‚ú® ExcelJS styling applied successfully!");
                
                // Show simple success message
                const successMsg = `‚úÖ Xu·∫•t Excel th√†nh c√¥ng!\n\n` +
                    `üìÅ File: ${filename}\n` +
                    `üìä Lo·∫°i d·ªØ li·ªáu: ${dept === 'HS' ? 'H·ªçc sinh' : 'Gi√°o vi√™n'}\n` +
                    `üìà S·ªë b·∫£n ghi: ${dataRows.length}\n` +
                    `‚è∞ Th·ªùi gian: ${now.toLocaleString('vi-VN')}`;
                
                alert(successMsg);
                
            } catch (error) {
                console.error('Excel export error:', error);
                alert(`‚ùå L·ªói xu·∫•t Excel: ${error.message}`);
            } finally {
                // Restore button state
                button.innerHTML = 'üìä Xu·∫•t File Excel';
                button.style.pointerEvents = 'auto';
            }
        }

        function exportData() {
            const dataType = document.getElementById('deptSelect').value;
            let csvContent = '';
            let filename = '';
            let rows = [];
            // Get data from the visible table
            const tableId = dataType === 'HS' ? 'table_hs' : 'table_gv';
            const table = document.getElementById(tableId).querySelector('tbody');
            const tableRows = table.querySelectorAll('tr');
            if (dataType === 'HS') {
                filename = 'student_data.csv';
                csvContent = [
                    'STT,H·ªç v√† T√™n,Ng√†y Sinh,Gi·ªõi T√≠nh,D√¢n T·ªôc,M√£ ƒê·ªãnh Danh,H·ªç T√™n Cha,Ng√†nh Ngh·ªÅ Cha,H·ªç T√™n M·∫π,Ng√†nh Ngh·ªÅ M·∫π,ƒê·ªãa Ch·ªâ,CMND Cha M·∫π, SƒêT PH',
                    ...Array.from(tableRows).map((row, idx) => {
                        const cells = row.querySelectorAll('td');
                        return [
                            cells[0].textContent,
                            `"${cells[1].textContent}"`,
                            cells[2].textContent,
                            cells[3].textContent,
                            cells[4].textContent,
                            cells[5].textContent,
                            `"${cells[6].textContent}"`,
                            `"${cells[7].textContent}"`,
                            `"${cells[8].textContent}"`,
                            `"${cells[9].textContent}"`,
                            `"${cells[10].textContent}"`,
                            cells[11].textContent,
                            cells[12].textContent
                        ].join(',');
                    })
                ].join('\n');
            } else if (dataType === 'GV') {
                filename = 'teacher_data.csv';
                csvContent = [
                    'STT,M√£ Gi√°o Vi√™n,H·ªç v√† T√™n,T√™n G·ªçi,ƒê·ªôi,Ng√†y Sinh,Qu√™ Qu√°n,CCCD,Ng√†y C·∫•p CCCD,M√£ S·ªë Thu·∫ø,S·ªë CMND,S·ªë BHXH,S·ªë ƒêi·ªán Tho·∫°i,S·ªë T√†i Kho·∫£n,Email,Nh√≥m M√°u,ƒê·ªãa Ch·ªâ',
                    ...Array.from(tableRows).map((row, idx) => {
                        const cells = row.querySelectorAll('td');
                        return [
                            cells[0].textContent,
                            cells[1].textContent,
                            `"${cells[2].textContent}"`,
                            `"${cells[3].textContent}"`,
                            `"${cells[4].textContent}"`,
                            cells[5].textContent,
                            `"${cells[6].textContent}"`,
                            cells[7].textContent,
                            cells[8].textContent,
                            cells[9].textContent,
                            cells[10].textContent,
                            cells[11].textContent,
                            cells[12].textContent,
                            cells[13].textContent,
                            cells[14].textContent,
                            cells[15].textContent,
                            `"${cells[16].textContent}"`
                        ].join(',');
                    })
                ].join('\n');
            }
            if (csvContent && dataType) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            } else {
                alert('Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu tr∆∞·ªõc khi xu·∫•t.');
            }
        }

        function closePreview() {
            document.getElementById('preview').style.display = 'none';
            document.getElementById('data-type').value = '';
            document.getElementById('table_hs').style.display = 'none';
            document.getElementById('table_gv').style.display = 'none';
        }
    </script>
</body>
</html>