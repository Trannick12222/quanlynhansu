<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>üë∂ Ph√¢n L·ªõp H·ªçc Sinh - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'neutral': {
            'primary': '#16a34a',
            'secondary': '#6b7280',
            'accent': '#8b9aa8',
            'muted': '#94a3b8',
            'light': '#cbd5e1',
            'lighter': '#e2e8f0',
            'lightest': '#f1f5f9'
          },
          'background': {
            'primary': '#f8fafc',
            'secondary': '#f1f5f9',
            'muted': '#e2e8f0',
            'card': '#ffffff'
          }
        },
        fontFamily: {
          'system': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
        }
      }
    }
  }
</script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-background-primary min-h-screen font-system">

<style>
.shadow-soft { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
.shadow-soft-lg { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }

/* Custom scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #f1f5f9; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

<div class="container mx-auto p-4 max-w-full">
  <div class="bg-white rounded-xl shadow-soft-lg border border-neutral-lighter overflow-hidden">
    <!-- Header Section -->
    <div class="bg-neutral-primary p-6 text-white">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
            <i class="fas fa-users text-lg"></i>
          </div>
          <div>
            <h1 class="text-xl font-semibold">Ph√¢n L·ªõp H·ªçc Sinh</h1>
            <p class="text-white/80 text-sm">Danh s√°ch h·ªçc sinh theo l·ªõp</p>
          </div>
        </div>
        <div class="bg-white/20 px-3 py-1 rounded-full text-sm font-medium">
          #PhanLop
        </div>
      </div>
    </div>
    
    <div class="p-6">
      <!-- Class Filter Section -->
      <div class="bg-background-secondary/50 p-6 rounded-xl border border-neutral-lighter mb-6">
        <label class="block text-neutral-secondary font-system font-semibold text-sm mb-3" for="selectClass">
          <span class="mr-2">üè∑Ô∏è</span>Ch·ªçn M√£ L·ªõp:
        </label>
        <select class="w-full max-w-md p-3 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system bg-white" 
                id="selectClass" onchange="filterByClass()">
          <option value="All">üè† -- T·∫•t c·∫£ h·ªçc sinh --</option>
        </select>
      </div>
      
      <!-- Students Table -->
      <div class="bg-white rounded-xl shadow-soft border border-neutral-lighter overflow-hidden">
        <div class="text-center text-xs text-neutral-muted py-2 bg-background-secondary border-b border-neutral-lighter">
          <i class="fas fa-arrows-alt-h mr-1"></i>Cu·ªôn ngang ƒë·ªÉ xem t·∫•t c·∫£ th√¥ng tin üëÜ
        </div>
        <div class="overflow-x-auto">
          <div class="min-w-max">
            <table class="w-full">
              <thead class="bg-neutral-lightest">
                <tr>
                  <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center min-w-16 border-b border-neutral-lighter">STT</th>
                  <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center min-w-28 border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" 
                      onclick="sortBy('ma_hs')">
                    <span class="mr-1">üè∑Ô∏è</span>M√£ HS 
                    <i class="fas fa-sort ml-1 opacity-60"></i>
                  </th>
                  <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center min-w-48 border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" 
                      onclick="sortBy('ho_va_ten')">
                    <span class="mr-1">üë∂</span>H·ªç v√† T√™n 
                    <i class="fas fa-sort ml-1 opacity-60"></i>
                  </th>
                  <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center min-w-40 border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" 
                      onclick="sortBy('ma_lop')">
                    <span class="mr-1">üè†</span>M√£ L·ªõp 
                    <i class="fas fa-sort ml-1 opacity-60"></i>
                  </th>
                  <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center min-w-48 border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" 
                      onclick="sortBy('ten_lop')">
                    <span class="mr-1">üè´</span>T√™n L·ªõp 
                    <i class="fas fa-sort ml-1 opacity-60"></i>
                  </th>
                  <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center min-w-32 border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" 
                      onclick="sortBy('ngay_sinh')">
                    <span class="mr-1">üéÇ</span>Ng√†y Sinh 
                    <i class="fas fa-sort ml-1 opacity-60"></i>
                  </th>
                  <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center min-w-28 border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" 
                      onclick="sortBy('gioi_tinh')">
                    <span class="mr-1">‚ôÇÔ∏è‚ôÄÔ∏è</span>Gi·ªõi T√≠nh 
                    <i class="fas fa-sort ml-1 opacity-60"></i>
                  </th>
                  <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center min-w-40 border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50 transition-colors duration-200" 
                      onclick="sortBy('ma_dinh_danh')">
                    <span class="mr-1">üÜî</span>M√£ ƒê·ªãnh Danh 
                    <i class="fas fa-sort ml-1 opacity-60"></i>
                  </th>
                </tr>
              </thead>
              <tbody id="studentTableBody">
                <tr>
                  <td colspan="8" class="px-6 py-12 text-center text-neutral-muted">
                    <div class="flex flex-col items-center space-y-4">
                      <span class="text-4xl">üë∂</span>
                      <div class="font-system text-sm">ƒêang t·∫£i d·ªØ li·ªáu h·ªçc sinh...</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    let allStudents = [];
    let classList = [];
    let currentSort = {
      key: null,
      direction: 'asc'
    };

    function sortBy(columnKey) {
      if (currentSort.key === columnKey) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.key = columnKey;
        currentSort.direction = 'asc';
      }

      const sorted = [...allStudents].sort((a, b) => {
        let valA = a[columnKey] || "";
        let valB = b[columnKey] || "";

        if (columnKey === 'ngay_sinh') {
          valA = new Date(valA);
          valB = new Date(valB);
        } else {
          valA = valA.toString().toLowerCase();
          valB = valB.toString().toLowerCase();
        }

        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      renderStudents(sorted);
    }
    
    function populateClassDropdown() {
      const select = document.getElementById("selectClass");
      classList.forEach(cls => {
        const option = document.createElement("option");
        option.value = cls.ma_lop;
        option.textContent = cls.ma_lop;
        select.appendChild(option);
      });
    }

    function filterByClass() {
      const selectedMaLop = document.getElementById("selectClass").value;
      if (selectedMaLop === "All") {
        renderStudents(allStudents);
      } else {
        const filtered = allStudents.filter(s => s.ma_lop === selectedMaLop);
        renderStudents(filtered);
      }
    }

    function renderStudents(data) {
      const tbody = document.getElementById("studentTableBody");
      tbody.innerHTML = data.map((s, index) => {
        const options = classList.map(c => `
          <option value="${c.ma_lop}" ${s.ma_lop === c.ma_lop ? "selected" : ""}>${c.ma_lop}</option>
        `).join("");

        return `
          <tr class="hover:bg-neutral-lighter/30 transition-colors duration-200 border-b border-neutral-lighter" data-ma-hs="${s.ma_hs}">
            <td class="px-4 py-3 font-system font-semibold text-neutral-muted text-center min-w-16">${index + 1}</td>
            <td class="px-4 py-3 font-system text-neutral-secondary text-center font-semibold min-w-28">${s.ma_hs}</td>
            <td class="px-4 py-3 font-system text-neutral-secondary min-w-48">${s.ho_va_ten}</td>
            <td class="px-4 py-3 min-w-40">
              <select class="w-full p-2 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system text-sm bg-white editable-ma-lop" 
                      onchange="updateStudentClass(this)" data-old-value="${s.ma_lop}">
                ${options}
              </select>
            </td>
            <td class="px-4 py-3 font-system text-neutral-secondary min-w-48 ten-lop-cell">${s.ten_lop || ""}</td>
            <td class="px-4 py-3 font-system text-neutral-secondary text-center min-w-32">${s.ngay_sinh || ""}</td>
            <td class="px-4 py-3 font-system text-neutral-secondary text-center min-w-28">${s.gioi_tinh === 'N·ªØ' ? 'üëß N·ªØ' : 'üë¶ ' + (s.gioi_tinh || '')}</td>
            <td class="px-4 py-3 font-system text-neutral-secondary text-center min-w-40">${s.ma_dinh_danh || ""}</td>
          </tr>
        `;
      }).join("");
    }

    async function updateStudentClass(selectEl) {
      const newMaLop = selectEl.value;
      const oldMaLop = selectEl.dataset.oldValue;
      const row = selectEl.closest("tr");
      const ma_hs = row.dataset.maHs;

      const lop = classList.find(c => c.ma_lop === newMaLop);
      if (!lop) {
        alert("‚ùå M√£ l·ªõp kh√¥ng h·ª£p l·ªá!");
        selectEl.value = oldMaLop;
        return;
      }

      const confirmChange = confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªïi m√£ l·ªõp c·ªßa h·ªçc sinh ${ma_hs} th√†nh ${newMaLop} kh√¥ng?`);
      if (!confirmChange) {
        selectEl.value = oldMaLop;
        return;
      }

      const res = await fetch("/api/update-student-class", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ma_hs, ma_lop: newMaLop })
      });

      if (res.ok) {
        alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t l·ªõp cho ${ma_hs} th√†nh c√¥ng`);
        await loadData();
        filterByClass();
      } else {
        alert("‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t v√†o c∆° s·ªü d·ªØ li·ªáu.");
        selectEl.value = oldMaLop;
      }
    }

    async function loadData() {
      const [studentsRes, classesRes] = await Promise.all([
        fetch("/api/students"),
        fetch("/api/classes")
      ]);
      allStudents = await studentsRes.json();
      classList = await classesRes.json();
      
      const select = document.getElementById("selectClass");
      const currentSelected = select.value || "All";
      select.innerHTML = `<option value="All">-- T·∫•t c·∫£ h·ªçc sinh --</option>`;
      classList.forEach(cls => {
        const opt = document.createElement("option");
        opt.value = cls.ma_lop;
        opt.textContent = cls.ma_lop;
        if (cls.ma_lop === currentSelected) opt.selected = true;
        select.appendChild(opt);
      });

      filterByClass();
    }

    window.onload = loadData;
</script>
</body>
</html>