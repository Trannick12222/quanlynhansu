<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ª± ƒê√°nh Gi√° EPA</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
        }
        h1::before {
            content: "üìù";
            margin-right: 10px;
        }
        h2 {
            font-size: 22px;
            display: flex;
            align-items: center;
        }
        h2::before {
            content: "üìã";
            margin-right: 10px;
        }
        .question {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .question p {
            margin: 0 0 10px;
        }
        .question input, .question textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
            margin-top: 5px;
        }
        .question textarea {
            resize: vertical;
            min-height: 60px;
        }
        .score-inputs, .comment-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        .score-inputs div, .comment-inputs div {
            flex: 1;
        }
        .score-inputs label, .comment-inputs label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .error {
            color: #e74c3c;
            font-style: italic;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .assessment-entry {
            background: #ecf0f1;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #e67e22;
        }
        hr {
            border: 0;
            border-top: 1px dashed #bdc3c7;
            margin: 15px 0;
        }
        .highlight {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .total-score {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!--<h1>T·ª± ƒê√°nh Gi√° EPA - {{month}} - {{ user }}</h1> -->
        <h1 id="epa-title">T·ª± ƒê√°nh Gi√° EPA</h1>
        
        <!-- Period Check -->
        <div id="period-message"></div>

        <!-- Last Assessment -->
        <h2>K·∫øt Qu·∫£ T·ª± ƒê√°nh Gi√° Tr∆∞·ªõc ƒê√¢y</h2>
        <div id="last-assessment"></div>

        <!-- Total Score Table -->
        <h2>T·ªïng ƒêi·ªÉm ƒê√°nh Gi√°</h2>
        <table id="total-score-table">
            <thead>
                <tr>
                    <th>NƒÉm</th>
                    <th>Th√°ng</th>
                    <th>T·ªïng ƒëi·ªÉm t·ª± ƒë√°nh gi√°</th>
                    <th>T·ªïng ƒëi·ªÉm gi√°m s√°t</th>
                    <th>ƒêi·ªÉm c·∫•p tr√™n</th>
                    <th>Nh·∫≠n x√©t c·∫•p tr√™n</th>
                </tr>
            </thead>
            <tbody id="total-score-table-body"></tbody>
        </table>

        <!-- Assessment Form -->
        <h2>G·ª≠i ƒê√°nh Gi√° EPA M·ªõi</h2>
        <div class="total-score" id="total-score-display">
            T·ªïng ƒëi·ªÉm t·ª± ƒë√°nh gi√°: 0 | T·ªïng ƒëi·ªÉm gi√°m s√°t: 0
        </div>
        <div id="assessment-form"></div>

        <button id="submit-btn" disabled>G·ª≠i</button>
        <div id="form-message"></div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        const tenTk = '{{ user }}';
        const userRole = '{{ role }}';

        function debugLog(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        async function checkAssessmentPeriod() {
            try {
                const response = await fetch(`${API_BASE_URL}/assessment-period`);
                const data = await response.json();
                debugLog('Ki·ªÉm tra th·ªùi gian:', data);
                if (!response.ok) throw new Error(data.message || 'L·ªói khi ki·ªÉm tra th·ªùi gian');
                document.getElementById('period-message').innerHTML = data.isOpen
                    ? '<p class="success">Th·ªùi gian ƒë√°nh gi√° ƒëang m·ªü!</p>'
                    : '<p class="error">Th·ªùi gian ƒë√°nh gi√° ƒë√£ ƒë√≥ng. M·ªü t·ª´ ng√†y ' + data.startDate + ' ƒë·∫øn cu·ªëi th√°ng.</p>';
                document.getElementById('submit-btn').disabled = !data.isOpen;
                return data.isOpen;
            } catch (error) {
                debugLog('L·ªói ki·ªÉm tra th·ªùi gian:', error);
                document.getElementById('period-message').innerHTML = '<p class="error">L·ªói khi ki·ªÉm tra th·ªùi gian.</p>';
                return false;
            }
        }

        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE_URL}/epa-questions`);
                const data = await response.json();
                debugLog('Danh s√°ch c√¢u h·ªèi:', data);
                if (!response.ok) throw new Error(data.message || 'L·ªói khi t·∫£i c√¢u h·ªèi');
                const formDiv = document.getElementById('assessment-form');
                const isSupervisorOrAdmin = userRole === 'supervisor' || userRole === 'admin';
                formDiv.innerHTML = data.questions.slice(0, 10).map((q, index) => `
                    <div class="question">
                        <p><strong>${index + 1}. ${q.translate}</strong></p>
                        <div class="score-inputs">
                            <div>
                                <label>ƒêi·ªÉm t·ª± ch·∫•m:</label>
                                <input type="number" min="0" max="30" id="score-${q.id}" placeholder="Nh·∫≠p ƒëi·ªÉm (0-30)">
                            </div>
                            <div>
                                <label>ƒêi·ªÉm t·ª´ Supervisor:</label>
                                <input type="number" min="0" max="30" id="sup-score-${q.id}" placeholder="Nh·∫≠p ƒëi·ªÉm (0-30)" ${isSupervisorOrAdmin ? '' : 'disabled'}>
                            </div>
                        </div>
                        <div class="comment-inputs">
                            <div>
                                <label>√ù ki·∫øn t·ª± ƒë√°nh gi√°:</label>
                                <textarea id="user-comment-${q.id}" placeholder="Nh·∫≠p √Ω ki·∫øn c·ªßa b·∫°n cho c√¢u h·ªèi n√†y..."></textarea>
                            </div>
                            <div>
                                <label>√ù ki·∫øn t·ª´ Supervisor:</label>
                                <textarea id="sup-comment-${q.id}" placeholder="Nh·∫≠p √Ω ki·∫øn ƒë√°nh gi√° (Supervisor)" ${isSupervisorOrAdmin ? '' : 'disabled'}></textarea>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Add event listeners for real-time total score update
                const scoreInputs = document.querySelectorAll('input[type="number"][id^="score-"]');
                const supScoreInputs = document.querySelectorAll('input[type="number"][id^="sup-score-"]');
                scoreInputs.forEach(input => input.addEventListener('input', updateTotalScore));
                supScoreInputs.forEach(input => input.addEventListener('input', updateTotalScore));
                updateTotalScore();
            } catch (error) {
                debugLog('L·ªói t·∫£i c√¢u h·ªèi:', error);
                document.getElementById('assessment-form').innerHTML = '<p class="error">Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi.</p>';
            }
        }

        function updateTotalScore() {
            const scoreInputs = document.querySelectorAll('input[type="number"][id^="score-"]');
            const supScoreInputs = document.querySelectorAll('input[type="number"][id^="sup-score-"]');
            let userTotal = 0;
            let supTotal = 0;
            scoreInputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value >= 0 && value <= 30) userTotal += value;
            });
            supScoreInputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value >= 0 && value <= 30) supTotal += value;
            });
            document.getElementById('total-score-display').textContent = `T·ªïng ƒëi·ªÉm t·ª± ƒë√°nh gi√°: ${userTotal} | T·ªïng ƒëi·ªÉm gi√°m s√°t: ${supTotal}`;
        }

        async function loadLastAssessment() {
            try {
                const response = await fetch(`${API_BASE_URL}/last-assessment`);
                const data = await response.json();
                debugLog('K·∫øt qu·∫£ ƒë√°nh gi√° tr∆∞·ªõc:', data);
                if (!response.ok) throw new Error(data.message || 'L·ªói khi t·∫£i ƒë√°nh gi√°');
                const assessmentDiv = document.getElementById('last-assessment');
                const totalScoreTableBody = document.getElementById('total-score-table-body');

                // Load individual assessments
                if (data.assessments && data.assessments.length === 0) {
                    assessmentDiv.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ƒë√°nh gi√° tr∆∞·ªõc ƒë√¢y.</p>';
                } else {
                    assessmentDiv.innerHTML = (data.assessments || data).map(a => `
                        <div class="assessment-entry">
                            <p class="highlight">NƒÉm: ${a.year}, Th√°ng: ${a.month}</p>
                            <p><strong>C√¢u h·ªèi:</strong> ${a.translate}</p>
                            <p><strong>ƒêi·ªÉm t·ª± ch·∫•m:</strong> ${a.user_score || 'N/A'}</p>
                            <p><strong>ƒêi·ªÉm t·ª´ Supervisor:</strong> ${a.sup_score || 'Ch∆∞a ch·∫•m'}</p>
                            <p><strong>√ù ki·∫øn t·ª± ƒë√°nh gi√°:</strong> ${a.user_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
                            <p><strong>√ù ki·∫øn t·ª´ Supervisor:</strong> ${a.sup_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
                        </div>
                    `).join('<hr>');
                }

                // Load total scores
                if (data.total_score) {
                    totalScoreTableBody.innerHTML = `
                        <tr>
                            <td>${data.total_score.year}</td>
                            <td>${data.total_score.month}</td>
                            <td>${data.total_score.user_total_score || 0}</td>
                            <td>${data.total_score.sup_total_score || 0}</td>
                            <td>${data.total_score.pri_total_score || 'Ch∆∞a c√≥'}</td>
                            <td>${data.total_score.pri_comment || 'Ch∆∞a c√≥'}</td>
                        </tr>
                    `;
                } else {
                    totalScoreTableBody.innerHTML = '<tr><td colspan="6">Kh√¥ng t√¨m th·∫•y t·ªïng ƒëi·ªÉm.</td></tr>';
                }
            } catch (error) {
                debugLog('L·ªói t·∫£i ƒë√°nh gi√° tr∆∞·ªõc:', error);
                document.getElementById('last-assessment').innerHTML = '<p class="error">H√£y ho√†n th√†nh b·∫£ng ƒë√°nh gi√° th√°ngth√°ng.</p>';
                document.getElementById('total-score-table-body').innerHTML = '<tr><td colspan="6">L·ªói khi t·∫£i t·ªïng ƒëi·ªÉm.</td></tr>';
            }
        }

        async function submitAssessment() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const scores = [];
            const questionInputs = document.querySelectorAll('#assessment-form .question');
            let userTotalScore = 0;
            let supTotalScore = 0;

            questionInputs.forEach(inputGroup => {
                const questionId = inputGroup.querySelector('input[type="number"]').id.split('-')[1];
                const user_score = parseInt(inputGroup.querySelector(`#score-${questionId}`).value);
                const supScoreInput = inputGroup.querySelector(`#sup-score-${questionId}`);
                const sup_score = supScoreInput.disabled ? null : parseInt(supScoreInput.value);
                const user_comment = inputGroup.querySelector(`#user-comment-${questionId}`).value.trim();
                const supCommentInput = inputGroup.querySelector(`#sup-comment-${questionId}`);
                const sup_comment = supCommentInput.disabled ? '' : supCommentInput.value.trim();
                if (!isNaN(user_score)) {
                    scores.push({ 
                        questionId, 
                        score: user_score, 
                        sup_score: isNaN(sup_score) ? null : sup_score,
                        user_comment,
                        sup_comment
                    });
                    if (user_score >= 0 && user_score <= 30) userTotalScore += user_score;
                    if (sup_score >= 0 && sup_score <= 30) supTotalScore += sup_score;
                }
            });
            debugLog('G·ª≠i d·ªØ li·ªáu:', { ten_tk: tenTk, year, month, scores, user_total_score: userTotalScore, sup_total_score: supTotalScore });
            if (scores.length === 0) {
                document.getElementById('form-message').innerHTML = '<p class="error">Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt ƒëi·ªÉm s·ªë.</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/submit-assessment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ten_tk: tenTk, 
                        year, 
                        month, 
                        scores,
                        user_total_score: userTotalScore,
                        sup_total_score: supTotalScore
                    })
                });
                const data = await response.json();
                debugLog('K·∫øt qu·∫£ g·ª≠i:', data);
                if (!response.ok) throw new Error(data.message || 'L·ªói khi g·ª≠i ƒë√°nh gi√°');
                document.getElementById('form-message').innerHTML = '<p class="success">ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!</p>';
                questionInputs.forEach(inputGroup => {
                    const questionId = inputGroup.querySelector('input[type="number"]').id.split('-')[1];
                    inputGroup.querySelector(`#score-${questionId}`).value = '';
                    inputGroup.querySelector(`#sup-score-${questionId}`).value = '';
                    inputGroup.querySelector(`#user-comment-${questionId}`).value = '';
                    const supCommentInput = inputGroup.querySelector(`#sup-comment-${questionId}`);
                    if (!supCommentInput.disabled) supCommentInput.value = '';
                });
                updateTotalScore();
                loadLastAssessment();
            } catch (error) {
                debugLog('L·ªói g·ª≠i ƒë√°nh gi√°:', error);
                document.getElementById('form-message').innerHTML = '<p class="error">Kh√¥ng th·ªÉ g·ª≠i ƒë√°nh gi√°.</p>';
            }
        }

        async function init() {
            debugLog('Kh·ªüi t·∫°o trang');
            const isOpen = await checkAssessmentPeriod();
            if (isOpen) {
                await loadQuestions();
            }
            await loadLastAssessment();
            document.getElementById('submit-btn').addEventListener('click', submitAssessment);
        }
        const now = new Date();
        const monthDisplay = `${now.getMonth() + 1}/${now.getFullYear()}`;
        document.getElementById("epa-title").innerText = `T·ª± ƒê√°nh Gi√° EPA - ${monthDisplay} - ${tenTk}`;
        window.onload = init;
    </script>
</body>
</html>