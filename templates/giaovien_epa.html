<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìù T·ª± ƒê√°nh Gi√° EPA - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</title>
  
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="{{ url_for('static_files', filename='css/modern.css') }}" rel="stylesheet">
  <link href="{{ url_for('static_files', filename='css/scrollbar.css') }}" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', var(--font-family-sans);
      background: var(--bg-secondary);
      padding: var(--spacing-lg);
    }
    
    .page-header {
      background: linear-gradient(135deg, #166534 0%, #14532d 100%);
      color: white;
      padding: var(--spacing-xl);
      border-radius: var(--border-radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-lg);
    }
    
    .page-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      margin: 0 0 var(--spacing-sm) 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .school-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-right: var(--spacing-md);
    }
    
    .page-subtitle {
      font-size: var(--text-sm);
      opacity: 0.9;
      margin: 0;
    }
    
    .content-card {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }
    
    .section-title {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin: 0 0 var(--spacing-lg) 0;
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .status-message {
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      margin-bottom: var(--spacing-lg);
      font-weight: var(--font-medium);
    }
    
    .status-message.success {
      background: var(--success-light);
      border: 1px solid var(--success-color);
      color: var(--success-dark);
    }
    
    .status-message.warning {
      background: var(--warning-light);
      border: 1px solid var(--warning-color);
      color: var(--warning-dark);
    }
    
    .status-message.error {
      background: var(--error-light);
      border: 1px solid var(--error-color);
      color: var(--error-dark);
    }
    
    .total-score-display {
      background: var(--primary-light);
      border: 1px solid var(--primary-color);
      color: var(--primary-dark);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      font-weight: var(--font-semibold);
      margin-bottom: var(--spacing-lg);
      text-align: center;
    }
    
    .btn-primary-modern {
      background: var(--primary-color);
      border: 1px solid var(--primary-color);
      color: white;
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: var(--border-radius-md);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      transition: all var(--transition-normal);
      cursor: pointer;
    }
    
    .btn-primary-modern:hover:not(:disabled) {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary-modern:disabled {
      background: var(--gray-400);
      border-color: var(--gray-400);
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .modern-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: var(--border-radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-lg);
    }
    
    .modern-table th {
      background: var(--gray-50);
      color: var(--text-primary);
      font-weight: var(--font-semibold);
      padding: var(--spacing-md);
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .modern-table td {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--gray-100);
      color: var(--text-secondary);
    }
    
    .modern-table tr:hover {
      background: var(--gray-25);
    }
    
    .question {
      background: var(--bg-primary);
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    
    .question p {
      margin: 0 0 var(--spacing-md) 0;
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }
    
    .score-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }
    
    .score-inputs > div {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    
    .score-inputs label {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
    }
    
    .score-inputs input {
      padding: var(--spacing-sm);
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: var(--text-sm);
      transition: all var(--transition-fast);
    }
    
    .score-inputs input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .score-inputs input:disabled {
      background: var(--gray-100);
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    .comment-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }
    
    .comment-inputs > div {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    
    .comment-inputs label {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
    }
    
    .comment-inputs textarea {
      padding: var(--spacing-sm);
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: var(--text-sm);
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      transition: all var(--transition-fast);
    }
    
    .comment-inputs textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .comment-inputs textarea:disabled {
      background: var(--gray-100);
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    @media (max-width: 768px) {
      .score-inputs,
      .comment-inputs {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="page-header">
    <div style="display: flex; align-items: center;">
      <img src="{{ url_for('static_files', filename='mnhhd.jpg') }}" 
           alt="Logo Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng" 
           class="school-logo">
      <div>
        <div class="page-title">
          <i class="fas fa-clipboard-check"></i>
          T·ª± ƒê√°nh Gi√° EPA
        </div>
        <div class="page-subtitle">
          H·ªá th·ªëng ƒë√°nh gi√° hi·ªáu su·∫•t nh√¢n vi√™n - {{ user }} ({{ role }})
        </div>
      </div>
    </div>
  </div>

  <div class="content-card">
    <div class="section-title">
      <i class="fas fa-clock"></i>
      Th·ªùi Gian ƒê√°nh Gi√°
    </div>
    <div id="period-message"></div>
  </div>

  <div class="content-card">
    <div class="section-title">
      <i class="fas fa-history"></i>
      K·∫øt Qu·∫£ T·ª± ƒê√°nh Gi√° Tr∆∞·ªõc ƒê√¢y
    </div>
    <div id="last-assessment"></div>
  </div>

  <div class="content-card">
    <div class="section-title">
      <i class="fas fa-chart-bar"></i>
      T·ªïng ƒêi·ªÉm ƒê√°nh Gi√°
    </div>
    <table id="total-score-table" class="modern-table">
      <thead>
        <tr>
          <th>NƒÉm</th>
          <th>Th√°ng</th>
          <th>T·ªïng ƒëi·ªÉm t·ª± ƒë√°nh gi√°</th>
          <th>T·ªïng ƒëi·ªÉm gi√°m s√°t</th>
          <th>ƒêi·ªÉm c·∫•p tr√™n</th>
          <th>Nh·∫≠n x√©t c·∫•p tr√™n</th>
        </tr>
      </thead>
      <tbody id="total-score-table-body"></tbody>
    </table>
  </div>

  <div class="content-card">
    <div class="section-title">
      <i class="fas fa-edit"></i>
      G·ª≠i ƒê√°nh Gi√° EPA M·ªõi
    </div>
    <div class="total-score-display" id="total-score-display">
      T·ªïng ƒëi·ªÉm t·ª± ƒë√°nh gi√°: 0 | T·ªïng ƒëi·ªÉm gi√°m s√°t: 0
    </div>
    <div id="assessment-form"></div>
    <button disabled="" id="submit-btn" class="btn-primary-modern">
      <i class="fas fa-paper-plane"></i> G·ª≠i ƒê√°nh Gi√°
    </button>

    <div id="form-message"></div>
  </div>
<script>
        const API_BASE_URL = '/api';
        const tenTk = '{{ user }}';
        const userRole = '{{ role }}';

        function debugLog(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        async function checkAssessmentPeriod() {
            try {
                console.log('üöÄ STARTING: Fetching assessment period...');
                const response = await fetch(`${API_BASE_URL}/assessment-period`);
                console.log('üì° RESPONSE: Status:', response.status, 'OK:', response.ok);
                
                if (!response.ok) {
                    console.error('‚ùå HTTP Error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üîç DEBUG: API Response from /assessment-period:', data);

                const monthYear = `${data.month}/${data.year}`;
                const currentPhase = data.current_phase || 'Kh√¥ng x√°c ƒë·ªãnh';
                const startDay = data.start_day || 'N/A';
                const closeDay = data.close_day || 'N/A';
                
                let msg = `<p><strong>Giai ƒëo·∫°n hi·ªán t·∫°i:</strong> ${currentPhase}</p>`;
                msg += `<p><strong>Th·ªùi gian:</strong> ${startDay}/${monthYear} ‚Üí ${closeDay}/${monthYear}</p>`;
                
                console.log('üîç DEBUG: isOpen value:', data.isOpen, 'Type:', typeof data.isOpen);

                // Simplified logic based on actual API response
                const phaseNum = data.current_phase;
                const phaseName = data.phase_name || '';
                
                // Cho ph√©p submit trong giai ƒëo·∫°n 1 (t·ª± ƒë√°nh gi√°) ngay c·∫£ khi isOpen=false
                if (data.isOpen === true || data.isOpen === 'true' || 
                    (phaseNum === 1 && (phaseName && phaseName.includes('T·ª± ƒê√°nh Gi√°')))) {
                    msg += `<div class="status-message success">‚úÖ Th·ªùi gian ƒë√°nh gi√° ƒëang m·ªü - ${currentPhase}</div>`;
                    document.getElementById('submit-btn').disabled = false;
                } else {
                    // Check specific phases for better error messages
                    if (phaseNum === 3 || (phaseName && phaseName.includes('HT/PHT'))) {
                        msg += `<div class="status-message error">‚õî ƒê√£ k·∫øt th√∫c th·ªùi gian t·ª± ƒë√°nh gi√°. Hi·ªán t·∫°i l√† giai ƒëo·∫°n HT/PHT ƒë√°nh gi√°.</div>`;
                    } else if (phaseNum === 2 || (phaseName && phaseName.includes('TGV'))) {
                        msg += `<div class="status-message warning">‚è≥ ƒê√£ k·∫øt th√∫c th·ªùi gian t·ª± ƒë√°nh gi√°. Hi·ªán t·∫°i l√† giai ƒëo·∫°n TGV ch·∫•m ƒëi·ªÉm t·ªï vi√™n (kh√¥ng th·ªÉ t·ª± ch·∫•m).</div>`;
                    } else if (phaseNum === 1 || (phaseName && phaseName.includes('T·ª± ƒê√°nh Gi√°'))) {
                        msg += `<div class="status-message success">‚åö ƒêang trong giai ƒëo·∫°n t·ª± ƒë√°nh gi√° - ki·ªÉm tra quy·ªÅn truy c·∫≠p...</div>`;
                        console.log('‚ö†Ô∏è WARNING: Phase 1 detected but isOpen=false. Checking user permissions...');
                    } else {
                        msg += `<div class="status-message error">‚õî Ngo√†i th·ªùi gian ƒë√°nh gi√° EPA</div>`;
                    }
                    document.getElementById('submit-btn').disabled = true;
                }

                document.getElementById('period-message').innerHTML = msg;

                return data.isOpen;

            } catch (error) {
                console.error('L·ªói ki·ªÉm tra th·ªùi gian:', error);
                document.getElementById('period-message').innerHTML =
                    '<div class="status-message warning">‚è≥ ƒê√£ k·∫øt th√∫c th·ªùi gian t·ª± ƒë√°nh gi√°. Hi·ªán t·∫°i l√† giai ƒëo·∫°n TGV ch·∫•m ƒëi·ªÉm t·ªï vi√™n (kh√¥ng th·ªÉ t·ª± ch·∫•m).</div>';
                document.getElementById('submit-btn').disabled = true;
                return false;
            }
        }

        async function loadQuestions() {
            try {
                console.log('üîÑ Loading questions...');
                const response = await fetch(`${API_BASE_URL}/epa-questions`);
                const data = await response.json();
                debugLog('Danh s√°ch c√¢u h·ªèi:', data);
                
                if (!response.ok) {
                    console.error('‚ùå Failed to load questions:', data.message);
                    throw new Error(data.message || 'L·ªói khi t·∫£i c√¢u h·ªèi');
                }
                const formDiv = document.getElementById('assessment-form');
                const isSupervisorOrAdmin = userRole === 'supervisor' || userRole === 'admin';
                console.log('üîç DEBUG: userRole =', userRole, 'isSupervisorOrAdmin =', isSupervisorOrAdmin);
                formDiv.innerHTML = data.questions.slice(0, 10).map((q, index) => `
                    <div class="question">
                        <p><strong>${index + 1}. ${q.question}</strong></p>
                        <p style="font-size: 14px; color: #6b7280; margin: 5px 0;">
                            <i class="fas fa-star"></i> ƒêi·ªÉm t·ªëi ƒëa: <strong>${q.max_score || 20}</strong>
                        </p>
                        <!-- n·∫øu b·∫°n v·∫´n mu·ªën hi·ªÉn th·ªã English, c√≥ th·ªÉ th√™m d√≤ng sau: -->
                        <!-- <p class="text-muted"><em>(${q.translate || ''})</em></p> -->
                        <div class="score-inputs">
                            ${userRole === 'supervisor' ? `
                                <div>
                                    <label>ƒêi·ªÉm ƒë√°nh gi√°:</label>
                                    <input type="number" min="0" max="${q.max_score || 20}" id="score-${q.id}" placeholder="Nh·∫≠p ƒëi·ªÉm (0-${q.max_score || 20})">
                                </div>
                            ` : `
                                <div>
                                    <label>ƒêi·ªÉm t·ª± ch·∫•m:</label>
                                    <input type="number" min="0" max="${q.max_score || 20}" id="score-${q.id}" placeholder="Nh·∫≠p ƒëi·ªÉm (0-${q.max_score || 20})">
                                </div>
                                <div>
                                    <label>ƒêi·ªÉm t·ª´ Supervisor:</label>
                                    <input type="number" min="0" max="${q.max_score || 20}" id="sup-score-${q.id}" placeholder="Nh·∫≠p ƒëi·ªÉm (0-${q.max_score || 20})" ${isSupervisorOrAdmin ? '' : 'disabled'}>
                                </div>
                            `}
                        </div>
                        <div class="comment-inputs">
                            ${userRole === 'supervisor' ? `
                                <div>
                                    <label>√ù ki·∫øn ƒë√°nh gi√°:</label>
                                    <textarea id="user-comment-${q.id}" placeholder="Nh·∫≠p √Ω ki·∫øn ƒë√°nh gi√° cho c√¢u h·ªèi n√†y..." maxlength="1000" oninput="updateCharCount(this, 'user-count-${q.id}')"></textarea>
                                    <small class="text-muted">
                                        <span id="user-count-${q.id}">0</span>/1000 k√Ω t·ª±
                                    </small>
                                </div>
                            ` : `
                                <div>
                                    <label>√ù ki·∫øn t·ª± ƒë√°nh gi√°:</label>
                                    <textarea id="user-comment-${q.id}" placeholder="Nh·∫≠p √Ω ki·∫øn c·ªßa b·∫°n cho c√¢u h·ªèi n√†y..." maxlength="1000" oninput="updateCharCount(this, 'user-count-${q.id}')"></textarea>
                                    <small class="text-muted">
                                        <span id="user-count-${q.id}">0</span>/1000 k√Ω t·ª±
                                    </small>
                                </div>
                                <div>
                                    <label>√ù ki·∫øn t·ª´ Supervisor:</label>
                                    <textarea id="sup-comment-${q.id}" placeholder="Nh·∫≠p √Ω ki·∫øn ƒë√°nh gi√° (Supervisor)" maxlength="1000" ${isSupervisorOrAdmin ? '' : 'disabled'} oninput="updateCharCount(this, 'sup-count-${q.id}')"></textarea>
                                    <small class="text-muted">
                                        <span id="sup-count-${q.id}">0</span>/1000 k√Ω t·ª±
                                    </small>
                                </div>
                            `}
                        </div>
                    </div>
                `).join('');

                // Add event listeners for real-time total score update
                const scoreInputs = document.querySelectorAll('input[type="number"][id^="score-"]');
                const supScoreInputs = document.querySelectorAll('input[type="number"][id^="sup-score-"]');
                
                console.log('üîç DEBUG: Found score inputs:', scoreInputs.length, 'sup score inputs:', supScoreInputs.length);
                
                scoreInputs.forEach(input => {
                    console.log('üîç DEBUG: Score input', input.id, 'disabled:', input.disabled);
                    input.addEventListener('input', updateTotalScore);
                });
                supScoreInputs.forEach(input => {
                    console.log('üîç DEBUG: Sup score input', input.id, 'disabled:', input.disabled);
                    input.addEventListener('input', updateTotalScore);
                });
                updateTotalScore();
                
                // Initialize character counters for all textareas
                const textareas = document.querySelectorAll('textarea[maxlength]');
                console.log('üîç DEBUG: Found textareas:', textareas.length);
                textareas.forEach(textarea => {
                    console.log('üîç DEBUG: Textarea', textarea.id, 'disabled:', textarea.disabled, 'readonly:', textarea.readOnly);
                    const counterId = textarea.getAttribute('oninput').match(/'([^']+)'/)[1];
                    updateCharCount(textarea, counterId);
                    
                    // Add debug event listeners
                    textarea.addEventListener('input', function(e) {
                        console.log(`INPUT EVENT: ${this.id} - Length: ${this.value.length}`);
                    });
                    
                    textarea.addEventListener('keydown', function(e) {
                        console.log(`KEYDOWN: ${e.key} - Current length: ${this.value.length}`);
                        if (this.value.length >= 29 && e.key.length === 1) {
                            console.log('WARNING: At 29 char limit, key will be processed...');
                        }
                    });
                    
                    textarea.addEventListener('keyup', function(e) {
                        console.log(`KEYUP: ${e.key} - New length: ${this.value.length}`);
                    });
                    
                    textarea.addEventListener('paste', function(e) {
                        console.log(`PASTE EVENT detected`);
                        setTimeout(() => {
                            console.log(`PASTE RESULT: New length: ${this.value.length}`);
                        }, 0);
                    });
                });
                
                console.log('‚úÖ Questions loaded successfully');
            } catch (error) {
                debugLog('L·ªói t·∫£i c√¢u h·ªèi:', error);
                document.getElementById('assessment-form').innerHTML = '<div class="status-message error">Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi.</div>';
            }
        }

        function updateTotalScore() {
            const scoreInputs = document.querySelectorAll('input[type="number"][id^="score-"]');
            const supScoreInputs = document.querySelectorAll('input[type="number"][id^="sup-score-"]');
            let userTotal = 0;
            let supTotal = 0;
            scoreInputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                const maxScore = parseInt(input.getAttribute('max')) || 20;
                if (value >= 0 && value <= maxScore) userTotal += value;
            });
            // N·∫øu l√† supervisor, ch·ªâ t√≠nh userTotal
            if (userRole !== 'supervisor') {
                supScoreInputs.forEach(input => {
                    const value = parseInt(input.value) || 0;
                    const maxScore = parseInt(input.getAttribute('max')) || 20;
                    if (value >= 0 && value <= maxScore) supTotal += value;
                });
            }
            
            if (userRole === 'supervisor') {
                document.getElementById('total-score-display').textContent = `T·ªïng ƒëi·ªÉm ƒë√°nh gi√°: ${userTotal}`;
            } else {
                document.getElementById('total-score-display').textContent = `T·ªïng ƒëi·ªÉm t·ª± ƒë√°nh gi√°: ${userTotal} | T·ªïng ƒëi·ªÉm gi√°m s√°t: ${supTotal}`;
            }
        }

        function updateCharCount(textarea, counterId) {
            const currentLength = textarea.value.length;
            const maxLength = parseInt(textarea.getAttribute('maxlength')) || 1000;
            const counter = document.getElementById(counterId);
            
            // Debug logging
            console.log(`UPDATE CHAR COUNT: ${textarea.id} = ${currentLength}/${maxLength} chars`);
            console.log(`Textarea value: "${textarea.value}"`);
            
            if (counter) {
                counter.textContent = currentLength;
                // Change color based on usage
                if (currentLength > maxLength * 0.9) {
                    counter.style.color = '#dc3545'; // Red when near limit
                } else if (currentLength > maxLength * 0.7) {
                    counter.style.color = '#fd7e14'; // Orange when approaching limit
                } else {
                    counter.style.color = '#6c757d'; // Default gray
                }
            }
        }

        async function loadExistingDataIntoForm() {
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                
                console.log('=== LOADING EXISTING DATA INTO FORM ===');
                console.log(`üîç Requesting: ${API_BASE_URL}/last-assessment?year=${year}&month=${month}`);
                
                const response = await fetch(`${API_BASE_URL}/last-assessment?year=${year}&month=${month}`);
                console.log('üì° Response status:', response.status, 'OK:', response.ok);
                
                const data = await response.json();
                console.log('üìÑ Response data:', data);
                
                if (response.ok && data.assessments && data.assessments.length > 0) {
                    console.log('Found existing assessments:', data.assessments.length);
                    
                    // Use index-based matching since questions in DB don't have numbers
                    console.log('üìä Assessment data for matching:');
                    data.assessments.forEach((assessment, index) => {
                        console.log(`  ${index + 1}. "${assessment.question.substring(0, 60)}..." - User: ${assessment.user_score}, Sup: ${assessment.sup_score}`);
                    });
                    
                    // Populate form fields
                    const questions = document.querySelectorAll('.question');
                    console.log(`üîç Found ${questions.length} question elements in DOM`);
                    
                    if (questions.length === 0) {
                        console.error('‚ùå No question elements found! Form may not be loaded yet.');
                        return;
                    }
                    
                    questions.forEach((questionDiv, index) => {
                        const questionNumber = index + 1;
                        const questionText = questionDiv.querySelector('p strong')?.textContent || 'No text found';
                        
                        console.log(`Question ${questionNumber}: "${questionText}"`);
                        
                        // Use index-based matching (questions are in same order)
                        const matchedAssessment = data.assessments[index];
                        
                        if (!matchedAssessment) {
                            console.log(`‚ùå No assessment found at index ${index} for question ${questionNumber}`);
                        }
                        
                        if (matchedAssessment) {
                            console.log(`‚úÖ Found match for question ${questionNumber}:`, matchedAssessment);
                            
                            // Get question ID from the first input
                            const scoreInput = questionDiv.querySelector('input[type="number"]');
                            if (scoreInput) {
                                const questionId = scoreInput.id.split('-')[1];
                                console.log(`üìù Processing question ${questionNumber} with ID: ${questionId}`);
                                
                                // Populate user score and comment
                                if (matchedAssessment.user_score !== null && matchedAssessment.user_score !== undefined) {
                                    const userScoreElement = document.getElementById(`score-${questionId}`);
                                    if (userScoreElement) {
                                        userScoreElement.value = matchedAssessment.user_score;
                                        console.log(`‚úÖ Set user score ${questionId}: ${matchedAssessment.user_score}`);
                                    } else {
                                        console.error(`‚ùå Element score-${questionId} not found`);
                                    }
                                }
                                
                                if (matchedAssessment.user_comment) {
                                    const userCommentTextarea = document.getElementById(`user-comment-${questionId}`);
                                    console.log(`Setting user comment for ${questionId}: "${matchedAssessment.user_comment}" (${matchedAssessment.user_comment.length} chars)`);
                                    userCommentTextarea.value = matchedAssessment.user_comment;
                                    userCommentTextarea.dispatchEvent(new Event('input'));
                                }
                                
                                // Populate supervisor score and comment if user has permission (ch·ªâ cho non-supervisor)
                                if (userRole !== 'supervisor') {
                                    if (matchedAssessment.sup_score !== null && matchedAssessment.sup_score !== undefined) {
                                        const supScoreInput = document.getElementById(`sup-score-${questionId}`);
                                        if (supScoreInput && !supScoreInput.disabled) {
                                            supScoreInput.value = matchedAssessment.sup_score;
                                            console.log(`‚úÖ Set sup score ${questionId}: ${matchedAssessment.sup_score}`);
                                        } else if (supScoreInput && supScoreInput.disabled) {
                                            console.log(`‚ö†Ô∏è Sup score input ${questionId} is disabled`);
                                        } else {
                                            console.error(`‚ùå Element sup-score-${questionId} not found`);
                                        }
                                    }
                                    
                                    if (matchedAssessment.sup_comment) {
                                        const supCommentTextarea = document.getElementById(`sup-comment-${questionId}`);
                                        if (!supCommentTextarea.disabled) {
                                            supCommentTextarea.value = matchedAssessment.sup_comment;
                                            supCommentTextarea.dispatchEvent(new Event('input'));
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    updateTotalScore();
                    console.log('=== FORM POPULATED SUCCESSFULLY ===');
                } else {
                    console.log('No existing assessments found or error loading data');
                }
            } catch (error) {
                console.error('Error loading existing data into form:', error);
            }
        }



        async function loadLastAssessment() {
            try {
                const response = await fetch(`${API_BASE_URL}/last-assessment`);
                const data = await response.json();
                debugLog('K·∫øt qu·∫£ ƒë√°nh gi√° tr∆∞·ªõc:', data);
                if (!response.ok) throw new Error(data.message || 'L·ªói khi t·∫£i ƒë√°nh gi√°');
                const assessmentDiv = document.getElementById('last-assessment');
                const totalScoreTableBody = document.getElementById('total-score-table-body');

                // Load individual assessments
                if (data.assessments && data.assessments.length === 0) {
                    assessmentDiv.innerHTML = '<div class="status-message warning">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ƒë√°nh gi√° tr∆∞·ªõc ƒë√¢y.</div>';
                } else {
                    assessmentDiv.innerHTML = (data.assessments || data).map(a => `
                        <div class="assessment-entry">
                            <p class="highlight">NƒÉm: ${a.year}, Th√°ng: ${a.month}</p>
                            <p><strong>C√¢u h·ªèi:</strong> ${a.question}</p>
                            ${userRole === 'supervisor' ? `
                                <p><strong>ƒêi·ªÉm ƒë√°nh gi√°:</strong> ${a.user_score || 'N/A'}</p>
                                <p><strong>√ù ki·∫øn ƒë√°nh gi√°:</strong> ${a.user_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
                            ` : `
                                <p><strong>ƒêi·ªÉm t·ª± ch·∫•m:</strong> ${a.user_score || 'N/A'}</p>
                                <p><strong>ƒêi·ªÉm t·ª´ Supervisor:</strong> ${a.sup_score || 'Ch∆∞a ch·∫•m'}</p>
                                <p><strong>√ù ki·∫øn t·ª± ƒë√°nh gi√°:</strong> ${a.user_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
                                <p><strong>√ù ki·∫øn t·ª´ Supervisor:</strong> ${a.sup_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
                            `}
                        </div>
                    `).join('<hr>');
                }

                // Load total scores
                if (data.total_score) {
                    totalScoreTableBody.innerHTML = `
                        <tr>
                            <td>${data.total_score.year}</td>
                            <td>${data.total_score.month}</td>
                            <td>${data.total_score.user_total_score || 0}</td>
                            <td>${data.total_score.sup_total_score || 0}</td>
                            <td>${data.total_score.pri_total_score || 'Ch∆∞a c√≥'}</td>
                            <td>${data.total_score.pri_comment || 'Ch∆∞a c√≥'}</td>
                        </tr>
                    `;
                } else {
                    totalScoreTableBody.innerHTML = '<tr><td colspan="6">Kh√¥ng t√¨m th·∫•y t·ªïng ƒëi·ªÉm.</td></tr>';
                }
            } catch (error) {
                debugLog('L·ªói t·∫£i ƒë√°nh gi√° tr∆∞·ªõc:', error);
                document.getElementById('last-assessment').innerHTML = '<div class="status-message warning">Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£ ƒë√°nh gi√° tr∆∞·ªõc ƒë√¢y. C√≥ th·ªÉ b·∫°n ch∆∞a th·ª±c hi·ªán ƒë√°nh gi√° ho·∫∑c c√≥ l·ªói k·∫øt n·ªëi.</div>';
                document.getElementById('total-score-table-body').innerHTML = '<tr><td colspan="6">Kh√¥ng th·ªÉ t·∫£i t·ªïng ƒëi·ªÉm. Vui l√≤ng th·ª≠ l·∫°i sau.</td></tr>';
            }
        }

        async function submitAssessment() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const scores = [];
            const questionInputs = document.querySelectorAll('#assessment-form .question');
            let userTotalScore = 0;
            let supTotalScore = 0;

            questionInputs.forEach(inputGroup => {
                const questionId = inputGroup.querySelector('input[type="number"]').id.split('-')[1];
                const user_score = parseInt(inputGroup.querySelector(`#score-${questionId}`).value);
                
                // N·∫øu l√† supervisor, ch·ªâ s·ª≠ d·ª•ng user_score v√† user_comment
                let sup_score = null;
                let sup_comment = '';
                if (userRole !== 'supervisor') {
                    const supScoreInput = inputGroup.querySelector(`#sup-score-${questionId}`);
                    sup_score = supScoreInput && !supScoreInput.disabled ? parseInt(supScoreInput.value) : null;
                    const supCommentInput = inputGroup.querySelector(`#sup-comment-${questionId}`);
                    sup_comment = supCommentInput && !supCommentInput.disabled ? supCommentInput.value.trim() : '';
                }
                
                const user_comment = inputGroup.querySelector(`#user-comment-${questionId}`).value.trim();
                if (!isNaN(user_score)) {
                    scores.push({ 
                        questionId, 
                        score: user_score, 
                        sup_score: isNaN(sup_score) ? null : sup_score,
                        user_comment,
                        sup_comment
                    });
                    // L·∫•y ƒëi·ªÉm t·ªëi ƒëa t·ª´ thu·ªôc t√≠nh max c·ªßa input
                    const userScoreInput = inputGroup.querySelector(`#score-${questionId}`);
                    const maxScore = parseInt(userScoreInput.getAttribute('max')) || 20;
                    
                    if (user_score >= 0 && user_score <= maxScore) {
                        userTotalScore += user_score;
                    } else if (user_score > maxScore) {
                        document.getElementById('form-message').innerHTML = `<div class="status-message error">C√¢u ${questionId}: ƒêi·ªÉm t·ªëi ƒëa ch·ªâ ƒë∆∞·ª£c ${maxScore}, kh√¥ng th·ªÉ nh·∫≠p ${user_score}</div>`;
                        return;
                    }
                    
                    // N·∫øu l√† supervisor, kh√¥ng t√≠nh sup_score ri√™ng bi·ªát
                    if (userRole !== 'supervisor') {
                        if (!isNaN(sup_score) && sup_score >= 0 && sup_score <= maxScore) {
                            supTotalScore += sup_score;
                        } else if (!isNaN(sup_score) && sup_score > maxScore) {
                            document.getElementById('form-message').innerHTML = `<div class="status-message error">C√¢u ${questionId}: ƒêi·ªÉm TGV t·ªëi ƒëa ch·ªâ ƒë∆∞·ª£c ${maxScore}, kh√¥ng th·ªÉ nh·∫≠p ${sup_score}</div>`;
                            return;
                        }
                    }
                }
            });
            debugLog('G·ª≠i d·ªØ li·ªáu:', { ten_tk: tenTk, year, month, scores, user_total_score: userTotalScore, sup_total_score: supTotalScore });
            if (scores.length === 0) {
                document.getElementById('form-message').innerHTML = '<div class="status-message error">Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt ƒëi·ªÉm s·ªë.</div>';
                return;
            }

            try {
                const requestPayload = {
                    ten_tk: tenTk, 
                    year, 
                    month, 
                    scores,
                    user_total_score: userTotalScore,
                    sup_total_score: supTotalScore
                };
                
                debugLog('üöÄ Sending request to:', `${API_BASE_URL}/submit-assessment`);
                debugLog('üì¶ Request payload:', requestPayload);
                
                const response = await fetch(`${API_BASE_URL}/submit-assessment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });
                
                debugLog('üì° Response status:', response.status);
                debugLog('‚úÖ Response ok:', response.ok);
                
                const data = await response.json();
                debugLog('üìÑ Response data:', data);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${data.message || 'L·ªói khi g·ª≠i ƒë√°nh gi√°'}`);
                }
                
                document.getElementById('form-message').innerHTML = '<div class="status-message success">‚úÖ ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!</div>';
                
                // Kh√¥ng reset form n·ªØa, thay v√†o ƒë√≥ reload d·ªØ li·ªáu m·ªõi
                await loadExistingDataIntoForm();
                updateTotalScore();
                loadLastAssessment();
            } catch (error) {
                debugLog('‚ùå L·ªói g·ª≠i ƒë√°nh gi√°:', error);
                console.error('Full error details:', error);
                document.getElementById('form-message').innerHTML = `<div class="status-message error">‚ùå Kh√¥ng th·ªÉ g·ª≠i ƒë√°nh gi√°: ${error.message}</div>`;
            }
        }

        async function init() {
            debugLog('Kh·ªüi t·∫°o trang');
            const isOpen = await checkAssessmentPeriod();
            
            // Always load questions first
            await loadQuestions();
            
            // Wait a bit to ensure DOM is ready, then load existing data
            setTimeout(async () => {
                await loadExistingDataIntoForm();
            }, 100);
            
            // Only disable input fields if assessment period is closed AND not in phase 1
            if (!isOpen) {
                // Check if we're in phase 1 (self-assessment phase)
                const periodMessage = document.getElementById('period-message');
                const isPhase1 = periodMessage && periodMessage.innerHTML.includes('T·ª± ƒê√°nh Gi√°');
                
                if (!isPhase1) {
                    // Disable all input fields only if not in phase 1
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('#assessment-form input, #assessment-form textarea');
                        inputs.forEach(input => {
                            if (!input.disabled) {
                                input.disabled = true;
                                input.style.backgroundColor = '#f8f9fa';
                                input.style.color = '#6c757d';
                            }
                        });
                    }, 200);
                }
            }
            
            await loadLastAssessment();
            document.getElementById('submit-btn').addEventListener('click', submitAssessment);
        }
        window.onload = init;
    </script>
</div></div></div></body>
</html>