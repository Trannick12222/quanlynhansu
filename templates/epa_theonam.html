{% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
      <div id="non-admin-epa-section">
        <h3>üßë‚Äçüíª B·∫£ng ƒê√°nh Gi√° - EPA</h3>
        <div class="input-row" style="margin-bottom: 15px;">
            <label for="year_epa" style="margin-right: 10px; font-weight: bold;">Ch·ªçn NƒÉm:</label>
            <select id="year_epa" class="form-control-sm">
                <option value="">-- Ch·ªçn NƒÉm --</option>
            </select>
        </div>
        <div class="table-responsive">
            <table class="table-sm" style="border-collapse: collapse; width: 100%;">
                <thead>
                    <tr>
                        <th style="min-width: 120px;">T√™n t√†i kho·∫£n</th>
                        <th style="min-width: 150px;">H·ªç v√† t√™n</th>
                        <th style="min-width: 80px;">NƒÉm</th>
                        <th style="min-width: 80px;">Th√°ng</th>
                        <th style="min-width: 120px;">ƒêi·ªÉm Ng∆∞·ªùi D√πng</th>
                        <th style="min-width: 120px;">ƒêi·ªÉm T·ªï Tr∆∞·ªüng</th>
                        <th style="min-width: 120px;">ƒêi·ªÉm Hi·ªáu Tr∆∞·ªüng</th>
                        <th style="min-width: 200px;">ƒê√°nh gi√° c·ªßa Hi·ªáu Tr∆∞·ªüng</th>
                        <th style="min-width: 100px;">H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="epa-table-body">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #888;">
                            Vui l√≤ng ch·ªçn nƒÉm ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="assessment-title"></div>
        <div id="period-message"></div>
        <div id="old-assessment-message"></div>
        <div id="last-assessment"></div>
    </div>

        <script>
        const API_BASE_URL = '/api';

        document.addEventListener('DOMContentLoaded', async () => {
            const section = document.getElementById('non-admin-epa-section');
            console.log('[DEBUG] non-admin-epa-section exists:', !!section);
            if (section) {
                await loadYears();
                document.getElementById('year_epa').addEventListener('change', loadEPATable);
            }
        });

        async function loadYears() {
            console.log('[DEBUG] Starting loadYears, API_BASE_URL:', API_BASE_URL);
            try {
                console.log('[DEBUG] Fetching from:', `${API_BASE_URL}/epa-years`);
                const response = await fetch(`${API_BASE_URL}/epa-years`);
                console.log('[DEBUG] Fetch response:', response);
                const data = await response.json();
                console.log('[DEBUG] Fetch data:', data);
                if (!response.ok) throw new Error(data.message || 'L·ªói khi t·∫£i danh s√°ch nƒÉm');
                const yearSelect = document.getElementById('year_epa');
                yearSelect.innerHTML = '<option value="">-- Ch·ªçn NƒÉm --</option>';
                data.years.forEach(year => {
                    yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                });
            } catch (error) {
                console.error('[DEBUG] L·ªói t·∫£i danh s√°ch nƒÉm:', error);
                document.getElementById('epa-table-body').innerHTML = '<tr><td colspan="9">L·ªói khi t·∫£i danh s√°ch nƒÉm.</td></tr>';
            }
        }

        async function loadEPATable() {
            const year = document.getElementById('year_epa').value;
            if (!year) {
                document.getElementById('epa-table-body').innerHTML = '<tr><td colspan="9">Vui l√≤ng ch·ªçn nƒÉm.</td></tr>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/epa-data?year=${year}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'L·ªói khi t·∫£i d·ªØ li·ªáu EPA');

                const tableBody = document.getElementById('epa-table-body');
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho nƒÉm n√†y.</td></tr>';
                    return;
                }

                tableBody.innerHTML = data.map(row => `
                    <tr>
                        <td>${row.ten_tk}</td>
                        <td>${row.ho_va_ten || 'N/A'}</td>
                        <td>${row.year}</td>
                        <td>${row.month}</td>
                        <td>${row.user_total_score || 'N/A'}</td>
                        <td>${row.sup_total_score || 'N/A'}</td>
                        <td>${row.pri_total_score || 'N/A'}</td>
                        <td>${row.pri_comment || 'Kh√¥ng c√≥'}</td>
                        <td>
                            <button class="btn-sm" onclick="viewAssessment(${row.id}, ${row.year}, ${row.month})">Xem</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('[DEBUG] L·ªói t·∫£i d·ªØ li·ªáu EPA:', error);
                document.getElementById('epa-table-body').innerHTML = '<tr><td colspan="9">L·ªói khi t·∫£i d·ªØ li·ªáu EPA.</td></tr>';
            }
        }

        function viewAssessment(id, year, month) {
          const ten_tk = event.target.closest("tr").children[0].innerText.trim(); // L·∫•y t·ª´ √¥ ƒë·∫ßu ti√™n (ten_tk)
          window.open(`/epa-preview?year=${year}&month=${month}&ten_tk=${ten_tk}`, "_blank");
        }

        async function loadLastAssessmentNhanVien(year, month) {
          try {
              const response = await fetch(`${API_BASE_URL}/last-assessment?year=${year}&month=${month}`);
              const data = await response.json();
              console.log('[DEBUG] K·∫øt qu·∫£ ƒë√°nh gi√° tr∆∞·ªõc:', data);

              const assessmentDiv = document.getElementById('last-assessment');
              const totalScoreTableBody = document.getElementById('total-score-table-body');

              if (data.assessments && data.assessments.length === 0) {
                  assessmentDiv.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ƒë√°nh gi√° tr∆∞·ªõc ƒë√¢y.</p>';
              } else {
                  assessmentDiv.innerHTML = (data.assessments || data).map(a => `
                      <div class="assessment-entry">
                          <p class="highlight">NƒÉm: ${a.year}, Th√°ng: ${a.month}</p>
                          <p><strong>C√¢u h·ªèi:</strong> ${a.translate}</p>
                          <p><strong>ƒêi·ªÉm t·ª± ch·∫•m:</strong> ${a.user_score || 'N/A'}</p>
                          <p><strong>ƒêi·ªÉm t·ª´ Supervisor:</strong> ${a.sup_score || 'Ch∆∞a ch·∫•m'}</p>
                          <p><strong>√ù ki·∫øn t·ª± ƒë√°nh gi√°:</strong> ${a.user_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
                          <p><strong>√ù ki·∫øn t·ª´ Supervisor:</strong> ${a.sup_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
                      </div>
                  `).join('<hr>');
              }

              if (data.total_score) {
                  totalScoreTableBody.innerHTML = `
                      <tr>
                          <td>${data.total_score.year}</td>
                          <td>${data.total_score.month}</td>
                          <td>${data.total_score.user_total_score || 0}</td>
                          <td>${data.total_score.sup_total_score || 0}</td>
                          <td>${data.total_score.pri_total_score || 'Ch∆∞a c√≥'}</td>
                          <td>${data.total_score.pri_comment || 'Ch∆∞a c√≥'}</td>
                      </tr>
                  `;
              } else {
                  totalScoreTableBody.innerHTML = '<tr><td colspan="6">Kh√¥ng t√¨m th·∫•y t·ªïng ƒëi·ªÉm.</td></tr>';
              }
          } catch (error) {
              console.log('[DEBUG] L·ªói t·∫£i ƒë√°nh gi√° tr∆∞·ªõc:', error);
              document.getElementById('last-assessment').innerHTML = '<p class="error">H√£y ho√†n th√†nh b·∫£ng ƒë√°nh gi√° th√°ng.</p>';
              document.getElementById('total-score-table-body').innerHTML = '<tr><td colspan="6">L·ªói khi t·∫£i t·ªïng ƒëi·ªÉm.</td></tr>';
          }
      }
      </script>
    {% endif %}