<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>üë©‚Äçüè´ G√°n Gi√°o Vi√™n - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'neutral': {
            'primary': '#16a34a',
            'secondary': '#6b7280', 
            'muted': '#94a3b8',
            'light': '#cbd5e1',
            'lighter': '#e2e8f0'
          }
        },
        fontFamily: {
          'system': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
        }
      }
    }
  }
</script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-50 min-h-screen font-system">

<style>
.shadow-soft { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
.shadow-soft-lg { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #f1f5f9; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

<div class="container mx-auto p-6 max-w-6xl">
  <div class="bg-white rounded-xl shadow-soft-lg border border-gray-100 overflow-hidden">
    <!-- Header -->
    <div class="bg-neutral-primary p-6 text-white">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
            <i class="fas fa-user-friends text-lg"></i>
          </div>
          <div>
            <h1 class="text-xl font-semibold">G√°n Gi√°o Vi√™n Cho L·ªõp</h1>
            <p class="text-white/80 text-sm">Qu·∫£n l√Ω ph√¢n c√¥ng gi·∫£ng d·∫°y</p>
          </div>
        </div>
        <div class="bg-white/20 px-3 py-1 rounded-full text-sm font-medium">
          #GiangDay
        </div>
      </div>
    </div>
    
    <div class="p-6">
      <!-- Form Section -->
      <div class="bg-background-secondary/50 p-6 rounded-xl border border-neutral-lighter mb-6">
        <form class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end" id="assign-teacher-form">
          <div>
            <label class="block text-neutral-secondary font-system font-semibold text-sm mb-2">
              <span class="mr-2">üë®‚Äçüè´</span>Ch·ªçn Gi√°o Vi√™n
            </label>
            <select class="w-full p-3 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system bg-white" 
                    id="ma_gv"></select>
          </div>
          <div>
            <label class="block text-neutral-secondary font-system font-semibold text-sm mb-2">
              <span class="mr-2">üè´</span>Ch·ªçn L·ªõp
            </label>
            <select class="w-full p-3 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system bg-white" 
                    id="ma_lop"></select>
          </div>
          <div>
            <label class="block text-neutral-secondary font-system font-semibold text-sm mb-2">
              <span class="mr-2">‚≠ê</span>Vai Tr√≤
            </label>
            <select class="w-full p-3 border border-neutral-light rounded-lg focus:border-neutral-primary focus:outline-none transition-colors duration-200 font-system bg-white" 
                    id="vai_tro">
              <option value="GI√ÅO VI√äN M·∫™U GI√ÅO">GI√ÅO VI√äN M·∫™U GI√ÅO</option>
              <option value="GI√ÅO VI√äN NH√Ä TR·∫∫">GI√ÅO VI√äN NH√Ä TR·∫∫</option>
              <option value="NH√ÇN VI√äN C·∫§P D∆Ø·ª†NG">NH√ÇN VI√äN C·∫§P D∆Ø·ª†NG</option>
            </select>
          </div>
          <div>
            <button class="w-full px-4 py-3 bg-neutral-primary hover:bg-neutral-secondary text-white rounded-lg font-system font-semibold transition-colors duration-200 flex items-center justify-center" 
                    type="submit">
              <i class="fas fa-user-plus mr-2"></i>G√°n Gi√°o Vi√™n
            </button>
          </div>
        </form>
      </div>
</div>
</div>
      <!-- Table Section -->
      <div class="bg-white rounded-xl shadow-soft border border-neutral-lighter overflow-hidden">
        <div class="bg-background-secondary px-6 py-4 border-b border-neutral-lighter">
          <h3 class="text-neutral-primary font-system font-semibold text-lg flex items-center">
            <span class="mr-2">üìã</span>Danh s√°ch gi√°o vi√™n ƒë√£ g√°n
          </h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-neutral-lightest">
              <tr>
                <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center border-b border-neutral-lighter">STT</th>
                <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50" 
                    onclick="sortTable('ma_gv')">M√£ GV <i class="fas fa-sort ml-1 opacity-60"></i></th>
                <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50" 
                    onclick="sortTable('ho_va_ten')">H·ªç v√† T√™n <i class="fas fa-sort ml-1 opacity-60"></i></th>
                <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50" 
                    onclick="sortTable('chuc_vu')">Ch·ª©c V·ª• <i class="fas fa-sort ml-1 opacity-60"></i></th>
                <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50" 
                    onclick="sortTable('ten_lop')">T√™n L·ªõp <i class="fas fa-sort ml-1 opacity-60"></i></th>
                <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center border-b border-neutral-lighter cursor-pointer hover:bg-neutral-light/50" 
                    onclick="sortTable('vai_tro')">Vai Tr√≤ <i class="fas fa-sort ml-1 opacity-60"></i></th>
                <th class="px-4 py-3 text-neutral-secondary font-system font-semibold text-sm text-center border-b border-neutral-lighter">H√†nh ƒê·ªông</th>
              </tr>
            </thead>
            <tbody id="assignmentsTable"></tbody>
          </table>
        </div>
      </div>
</div>
<script>
window.onload = async () => {
  const gv = await (await fetch('/api/teachers')).json();
  const lop = await (await fetch('/api/classes')).json();
  gv.forEach(g => {
    ma_gv.innerHTML += `<option value="${g.ma_gv}">${g.ho_va_ten}</option>`;
  });
  lop.forEach(l => {
    ma_lop.innerHTML += `<option value="${l.ma_lop}">${l.ten_lop}</option>`;
  });
};
document.getElementById('assign-teacher-form').addEventListener('submit', async function(e) {
   e.preventDefault();
   const res = await fetch('/api/assign-teacher', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       ma_lop: ma_lop.value,
       ma_gv: ma_gv.value,
       vai_tro: vai_tro.value
     })
   });
   if (res.ok) {
     alert("üéâ G√°n gi√°o vi√™n th√†nh c√¥ng!");
     // g·ªçi l·∫°i ƒë·ªÉ load l·∫°i b·∫£ng m√† kh√¥ng c·∫ßn F5
     loadAssignments();
   } else {
     const err = await res.text();
     alert("‚ùå C√≥ l·ªói: " + err);
   }
 });
</script>
<script>
  let sortState = { field: null, asc: true };

  function sortTable(field) {
    if (sortState.field === field) {
      sortState.asc = !sortState.asc;
    } else {
      sortState.field = field;
      sortState.asc = true;
    }
    loadAssignments(); // G·ªçi l·∫°i b·∫£ng ƒë√£ sort
  }
  const assignmentsTable = document.getElementById('assignmentsTable');
  let classOptions = [];

  async function loadAssignments() {
    const res = await fetch('/api/assigned-teachers');  // backend tr·∫£ v·ªÅ danh s√°ch ƒë√£ g√°n
    const data = await res.json();
    assignmentsTable.innerHTML = '';
    // S·∫Øp x·∫øp tr∆∞·ªõc khi render
    if (sortState.field) {
      data.sort((a, b) => {
        const valA = (a[sortState.field] || "").toString().toLowerCase();
        const valB = (b[sortState.field] || "").toString().toLowerCase();
        if (valA < valB) return sortState.asc ? -1 : 1;
        if (valA > valB) return sortState.asc ? 1 : -1;
        return 0;
      });
    }
    data.forEach((item, index) => {
      assignmentsTable.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${item.ma_gv}</td>
          <td>${item.ho_va_ten}</td>
          <td>${item.chuc_vu}</td>
          <td>
            <select onchange="updateField('${item.ma_gv}', 'ma_lop', this.value)">
              ${classOptions.map(c => `<option value="${c.ma_lop}" ${c.ten_lop === item.ten_lop ? 'selected' : ''}>${c.ten_lop}</option>`).join('')}
            </select>
          </td>
          <td>
            <select onchange="updateField('${item.ma_gv}', 'vai_tro', this.value)">
              ${['GI√ÅO VI√äN M·∫™U GI√ÅO','GI√ÅO VI√äN NH√Ä TR·∫∫','NH√ÇN VI√äN C·∫§P D∆Ø·ª†NG'].map(v => `<option value="${v}" ${v === item.vai_tro ? 'selected' : ''}>${v}</option>`).join('')}
            </select>
          </td>
          <td>
            <button class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded font-system transition-colors duration-200" 
                    onclick="deleteAssignment('${item.ma_gv}', '${item.ma_lop}')">üóëÔ∏è X√≥a</button>
          </td>
        </tr>
      `;
    });
  }

  async function updateField(ma_gv, field, value) {
    if (!confirm("X√°c nh·∫≠n thay ƒë·ªïi th√¥ng tin?")) return;
    await fetch('/api/update-assignment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ma_gv, field, value })
    });
    loadAssignments();
  }

  async function deleteAssignment(ma_gv, ma_lop) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ph√¢n c√¥ng n√†y?")) return;
    await fetch('/api/delete-assignment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ma_gv, ma_lop })
    });
    loadAssignments();
  }

  // C·∫≠p nh·∫≠t window.onload ƒë·ªÉ ƒë·ªìng b·ªô classOptions
  window.onload = async () => {
    const gv = await (await fetch('/api/teachers')).json();
    const lop = await (await fetch('/api/classes')).json();
    classOptions = lop;
    gv.forEach(g => {
      ma_gv.innerHTML += `<option value="${g.ma_gv}">${g.ho_va_ten}</option>`;
    });
    lop.forEach(l => {
      ma_lop.innerHTML += `<option value="${l.ma_lop}">${l.ten_lop}</option>`;
    });
    loadAssignments();  // ‚úÖ load b·∫£ng ngay sau khi trang t·∫£i
  };
</script>
</body>
</html>