<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Th√¥ng Tin Nh√¢n S·ª± - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'dark-green': {
            'primary': '#14532d',
            'secondary': '#166534',
            'tertiary': '#15803d',
            'accent': '#16a34a',
            'light': '#22c55e',
            'bg': '#dcfce7',
            'bg-light': '#f0fdf4'
          }
        },
        fontFamily: {
          'cute': ['Inter', 'system-ui', 'sans-serif']
        }
      }
    }
  }
</script>

<!-- Bootstrap CSS (for compatibility) -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
<link href="{{ url_for('static_files', filename='css/styles.css') }}?v=20250719" rel="stylesheet"/>
<link href="{{ url_for('static_files', filename='css/scrollbar.css') }}" rel="stylesheet"/>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
  .shadow-dark-green { box-shadow: 0 10px 25px -5px rgba(20, 83, 45, 0.15), 0 4px 6px -2px rgba(20, 83, 45, 0.05); }
  .gradient-dark-green { background: linear-gradient(135deg, #14532d 0%, #166534 50%, #15803d 100%); }
  .animate-float { animation: float 3s ease-in-out infinite; }
  .animate-wiggle { animation: wiggle 2s ease-in-out infinite; }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }
  
  @keyframes wiggle {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-3deg); }
    75% { transform: rotate(3deg); }
  }
  
  /* Override table header color */
  th, .table-sm th {
    background-color: #278f49 !important; /* Custom green */
    color: white !important;
  }
  
  /* Custom scrollbar */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #dcfce7; border-radius: 10px; }
  ::-webkit-scrollbar-thumb { background: #14532d; border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: #166534; }
</style>
</head>
<body class="bg-gradient-to-br from-dark-green-bg/20 via-dark-green-bg-light/30 to-dark-green-bg/20 min-h-screen font-cute">
  <div class="p-6 space-y-6">
    <!-- Page Header -->
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-dark-green p-8 border border-white/60">
      <div class="flex items-center justify-center space-x-4 mb-6">
        <div class="w-16 h-16 gradient-dark-green rounded-2xl flex items-center justify-center text-white text-2xl animate-float">
          <i class="fas fa-users"></i>
        </div>
        <div class="text-center">
          <h1 class="text-4xl font-cute font-bold bg-gradient-to-r from-dark-green-primary to-dark-green-secondary bg-clip-text text-transparent">
            TH√îNG TIN NH√ÇN S·ª∞
          </h1>
          <p class="text-gray-600 font-cute text-lg animate-wiggle">
            üå∏ Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng üå∏
          </p>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-4 items-center justify-center">
        <a href="/user-epa-score" class="flex items-center space-x-2 px-6 py-3 gradient-dark-green text-white rounded-xl hover:shadow-dark-green transition-all duration-300 font-cute font-semibold group hover:scale-105">
          <span class="group-hover:animate-bounce">üìù</span>
          <span>ƒê√°nh gi√° EPA</span>
        </a>
        <button onclick="loadHistory()" class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-dark-green-accent/20 to-dark-green-light/20 text-dark-green-primary border-2 border-dark-green-accent rounded-xl hover:bg-dark-green-accent hover:text-white transition-all duration-300 font-cute font-semibold group hover:scale-105">
          <span class="group-hover:animate-wiggle">üìú</span>
          <span>Xem L·ªãch S·ª≠ ƒê√°nh Gi√°</span>
        </button>
        {% if role == "supervisor" %}
        <a href="/sup-epa-score" class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-dark-green-secondary to-dark-green-tertiary text-white rounded-xl hover:shadow-dark-green transition-all duration-300 font-cute font-semibold group hover:scale-105">
          <span class="group-hover:animate-bounce">üë•</span>
          <span>ƒê√°nh gi√° EPA t·ªï vi√™n</span>
        </a>
        {% endif %}
      </div>
    </div>


    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content rounded-3xl border-0 shadow-dark-green">
          <div class="modal-header gradient-dark-green text-white rounded-t-3xl">
            <h5 class="modal-title font-cute font-bold flex items-center">
              <span class="mr-2 text-2xl animate-wiggle">üìú</span>
              L·ªãch S·ª≠ ƒê√°nh Gi√°
            </h5>
            <button type="button" class="close text-white hover:text-gray-200 transition-colors duration-200" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body p-6">
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-dark-green-bg text-dark-green-primary">
                  <tr>
                    <th class="px-4 py-3 text-left font-cute font-semibold">ID</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">T√™n TK</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">ƒêi·ªÉm GV</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">ƒêi·ªÉm TGV</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">ƒêi·ªÉm HT/PHT</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">√ù Ki·∫øn HT/PHT</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">Th√°ng</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">NƒÉm</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">Ng√†y T·∫°o</th>
                    <th class="px-4 py-3 text-left font-cute font-semibold">H√†nh ƒê·ªông</th>
                  </tr>
                </thead>
                <tbody id="historyBody" class="divide-y divide-gray-200"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content rounded-3xl border-0 shadow-dark-green">
          <div class="modal-header gradient-dark-green text-white rounded-t-3xl">
            <h5 class="modal-title font-cute font-bold flex items-center">
              <span class="mr-2 text-2xl animate-bounce">üìã</span>
              Chi Ti·∫øt B·∫£ng ƒê√°nh Gi√°
            </h5>
            <button type="button" class="close text-white hover:text-gray-200 transition-colors duration-200" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body p-6" id="detailBody">
            <!-- n·ªôi dung chi ti·∫øt s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
          </div>
        </div>
      </div>
    </div>

    <!-- Department Selection -->
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-dark-green p-6 border border-white/60">
      <div class="flex flex-wrap gap-4 items-end justify-between">
        <div class="flex-1 min-w-[200px]">
          <label for="deptSelect" class="block text-dark-green-primary font-cute font-semibold mb-2">
            <span class="mr-2">üè¢</span>B·ªô Ph·∫≠n
          </label>
          <select class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-dark-green-primary focus:outline-none transition-colors duration-200 font-cute" id="deptSelect" name="deptSelect" onchange="switchDept()">
            <option value="">-- Ch·ªçn B·ªô Ph·∫≠n --</option>
            <option value="HS">üë∂ H·ªåC SINH</option>
            <option value="GV">üë©‚Äçüè´ GI√ÅO VI√äN</option>
          </select>
        </div>
        <div class="flex-1 min-w-[250px]">
          <label class="block text-dark-green-primary font-cute font-semibold mb-2" for="searchInput">
            <span class="mr-2">üîç</span>T√¨m ki·∫øm
          </label>
          <input class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-dark-green-primary focus:outline-none transition-colors duration-200 font-cute" id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm..." type="text"/>
        </div>
      </div>
      <div id="dynamicInputRow" class="mt-4"></div>
    </div>
    <!-- Data Tables -->
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-dark-green border border-white/60 overflow-hidden">
      <!-- Students Table -->
      <div id="table_hs" style="display: none;">
        <div class="gradient-dark-green p-6 text-white">
          <div class="flex items-center space-x-3">
            <span class="text-2xl animate-bounce">üë∂</span>
            <h3 class="text-xl font-cute font-bold text-white" style="text-shadow: none;">Danh S√°ch H·ªçc Sinh</h3>
          </div>
        </div>
        <div class="overflow-x-auto max-h-[70vh]">
          <table class="min-w-full text-sm">
            <thead class="text-white sticky top-0 z-10" style="background-color: #166534 !important;">
              <tr>
                <th class="px-4 py-3 text-left font-cute font-semibold">#</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">M√£ HS</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">M√£ GV</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">M√£ L·ªõp</th>
                <th class="px-4 py-3 text-left font-cute font-semibold min-w-[200px]">H·ªç v√† T√™n</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">Ng√†y Sinh</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">Gi·ªõi T√≠nh</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">D√¢n T·ªôc</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">M√£ ƒê·ªãnh Danh</th>
                <th class="px-4 py-3 text-left font-cute font-semibold min-w-[150px]">T√™n B·ªë</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">Ngh·ªÅ B·ªë</th>
                <th class="px-4 py-3 text-left font-cute font-semibold min-w-[150px]">T√™n M·∫π</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">Ngh·ªÅ M·∫π</th>
                <th class="px-4 py-3 text-left font-cute font-semibold min-w-[200px]">H·ªô Kh·∫©u</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">CCCD B·ªë/M·∫π</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">SƒêT B·ªë/M·∫π</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">H√†nh ƒê·ªông</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>

      <!-- Teachers Table -->
      <div id="table_gv" style="display: none;">
        <div class="gradient-dark-green p-6 text-white">
          <div class="flex items-center space-x-3">
            <span class="text-2xl animate-wiggle">üë©‚Äçüè´</span>
            <h3 class="text-xl font-cute font-bold text-white" style="text-shadow: none;">Danh S√°ch Gi√°o Vi√™n</h3>
          </div>
        </div>
        <div class="overflow-x-auto max-h-[70vh]">
          <table class="min-w-full text-sm">
            <thead class="text-white sticky top-0 z-10" style="background-color: #166534b2 !important;">
              <tr>
                <th class="px-4 py-3 text-left font-cute font-semibold">#</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">M√£ GV</th>
                <th class="px-4 py-3 text-left font-cute font-semibold min-w-[200px]">H·ªç v√† T√™n</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">T√™n TK</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">Ch·ª©c V·ª•</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">Ng√†y Sinh</th>
                <th class="px-4 py-3 text-left font-cute font-semibold min-w-[200px]">Qu√™ Qu√°n</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">CCCD</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">Ng√†y C·∫•p CCCD</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">M√£ S·ªë Thu·∫ø</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">CMND</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">S·ªë B·∫£o Hi·ªÉm</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">S·ªë ƒêi·ªán Tho·∫°i</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">T√†i Kho·∫£n NH</th>
                <th class="px-4 py-3 text-left font-cute font-semibold min-w-[300px]">Email</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">Nh√≥m M√°u</th>
                <th class="px-4 py-3 text-left font-cute font-semibold min-w-[400px]">ƒê·ªãa Ch·ªâ</th>
                <th class="px-4 py-3 text-left font-cute font-semibold">H√†nh ƒê·ªông</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<script>
  let maGVList = [];
  let maLopList = [];

  async function fetchMaLists() {
    const res = await fetch("/api/danh-sach-ma");
    const data = await res.json();
    maGVList = data.maGVList;
    maLopList = data.maLopList;
  }

  // G·ªçi h√†m n√†y tr∆∞·ªõc khi render b·∫£ng h·ªçc sinh
  fetchMaLists();
</script>
<script>
let schemaByDept = {};
const currentUser = "{{ user|lower }}";
const userRole = "{{ role }}";

async function fetchSchema() {
  try {
    const res = await fetch("/api/table-schema", { credentials: "include" });
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}, StatusText: ${res.statusText}`);
    const schema = await res.json();
    if (!schema || typeof schema !== "object") {
      throw new Error("Invalid schema format: " + JSON.stringify(schema));
    }
    // Map backend column names to frontend field names
    schemaByDept = {
      HS: schema.HS ? schema.HS.map(field => ({
        ma_hs: "ma_hs",
        ma_gv: "ma_gv",
        ma_lop: "ma_lop",
        ho_va_ten: "full_name",
        ngay_sinh: "birth_date",
        gioi_tinh: "gender",
        dan_toc: "ethnicity",
        ma_dinh_danh: "identifier_code",
        ho_ten_bo: "father_name",
        nghe_nghiep_bo: "father_job",
        ho_ten_me: "mother_name",
        nghe_nghiep_me: "mother_job",
        ho_khau: "household_address",
        cccd_bo_me: "parent_id_card",
        sdt: "parent_phone"
      }[field] || field)) : [],
      GV: schema.GV ? schema.GV.map(field => ({
        ma_gv: "staff_id",
        ho_va_ten: "full_name",
        ten_tk: "nick_name",
        chuc_vu: "team",
        ngay_sinh: "birth_date",
        que_quan: "hometown",
        cccd: "cccd",
        ngay_cap: "cccd_issued_date",
        mst: "tax_code",
        cmnd: "cmnd",
        so_bh: "insurance_number",
        sdt: "phone_number",
        tk_nh: "bank_account",
        email: "email",
        nhom_mau: "blood_type",
        dia_chi: "address"
      }[field] || field)) : []
    };
    console.log("DEBUG: Schema fetched successfully", schemaByDept);
    await switchDept();
  } catch (err) {
    console.error("‚ùå Failed to fetch schema:", err.message);
    //alert("Kh√¥ng th·ªÉ t·∫£i schema. Vui l√≤ng th·ª≠ l·∫°i. L·ªói: " + err.message);
  }
}

async function switchDept() {
  console.log("DEBUG: switchDept b·∫Øt ƒë·∫ßu");

  // Ki·ªÉm tra DOM
  const deptSelect = document.getElementById("deptSelect");
  const container = document.getElementById("dynamicInputRow");
  const tableHS = document.getElementById("table_hs");
  const tableGV = document.getElementById("table_gv");

  if (!deptSelect || !container || !tableHS || !tableGV) {
    console.error("‚ùå Thi·∫øu deptSelect, dynamicInputRow, table_hs, ho·∫∑c table_gv trong DOM");
    //alert("L·ªói: Kh√¥ng t√¨m th·∫•y c√°c ph·∫ßn t·ª≠ giao di·ªán c·∫ßn thi·∫øt. Vui l√≤ng th·ª≠ l·∫°i.");
    return;
  }

  const dept = deptSelect.value;
  console.log(`DEBUG: B·ªô ph·∫≠n ƒë∆∞·ª£c ch·ªçn: ${dept}`);
  // Hi·ªÉn th·ªã spinner
  container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">ƒêang t·∫£i...</span></div></div>';
  // ·∫®n/hi·ªán b·∫£ng
  tableHS.style.display = dept === "HS" ? "block" : "none";
  tableGV.style.display = dept === "GV" ? "block" : "none";
  console.log(`DEBUG: Tr·∫°ng th√°i hi·ªÉn th·ªã - table_hs: ${tableHS.style.display}, table_gv: ${tableGV.style.display}`);
  // Ki·ªÉm tra dept v√† schema
  if (!dept) {
    console.log("DEBUG: Ch∆∞a ch·ªçn b·ªô ph·∫≠n");
    //alert("Vui l√≤ng ch·ªçn m·ªôt b·ªô ph·∫≠n (HS ho·∫∑c GV).");
    container.innerHTML = "";
    return;
  }
  if (!schemaByDept[dept]) {
    console.log(`DEBUG: Kh√¥ng t√¨m th·∫•y schema cho ${dept}`);
    alert(`L·ªói: Kh√¥ng c√≥ schema cho b·ªô ph·∫≠n ${dept}. Vui l√≤ng th·ª≠ l·∫°i.`);
    container.innerHTML = "";
    return;
  }
  // T·∫°o tr∆∞·ªùng nh·∫≠p li·ªáu ƒë·ªông v√† n√∫t Th√™m ch·ªâ khi "kimnhung", role l√† Supervisor ho·∫∑c Administrator
  container.innerHTML = "";
  if (["kimnhung", "ngocquy", "admin"].includes(currentUser)) {
    let rowDiv = document.createElement("div");
    rowDiv.className = "row g-2 mb-2 w-100 d-flex";

    schemaByDept[dept].forEach((field, index) => {
      const label = field.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
      console.log(`DEBUG: T·∫°o input cho field: ${field}, label: ${label}`);
      let inputType = "text";
      if (field.includes("date")) inputType = "date";
      else if (field.includes("phone")) inputType = "tel";
      else if (field.includes("email")) inputType = "email";
      else if (field === "gender") inputType = "select";

      const colDiv = document.createElement("div");
      colDiv.className = "col-auto input-dynamic";
      if (inputType === "select") {
        colDiv.innerHTML = `
          <label class="form-label fw-bold w-100">${label}</label>
          <select id="${field}" class="form-control form-control-sm">
            <option value="">Ch·ªçn ${label}</option>
            <option value="Nam">Nam</option>
            <option value="N·ªØ">N·ªØ</option>
          </select>
        `;
      } else {
        colDiv.innerHTML = `
          <label class="form-label fw-bold w-100">${label}</label>
          <input type="${inputType}" id="${field}" class="form-control form-control-sm" 
                placeholder="${label}" 
                ${field === "ma_hs" || field === "full_name" || field === "staff_id" ? "required" : ""}
                ${inputType === "tel" ? 'pattern="[0-9]{10,11}" title="S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë"' : ""}
                ${inputType === "email" ? 'pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$" title="Email kh√¥ng h·ª£p l·ªá"' : ""}>
        `;
      }
      rowDiv.appendChild(colDiv);
      if ((index + 1) % 5 === 0) {
        container.appendChild(rowDiv);
        rowDiv = document.createElement("div");
        rowDiv.className = "row g-2 mb-2 w-100 d-flex";
      }
    });

    if (rowDiv.childElementCount > 0) {
      container.appendChild(rowDiv);
      console.log(`DEBUG: ƒê√£ th√™m h√†ng cu·ªëi v·ªõi ${rowDiv.childElementCount} input`);
    }

    // Th√™m n√∫t Add
    const buttonRow = document.createElement("div");
    buttonRow.className = "row g-2 mt-2 w-100 input-dynamic";
    buttonRow.innerHTML = `
      <div class="col-auto d-grid">
        <button class="btn btn-success btn-sm" onclick="addEmployee()">‚ûï Th√™m</button>
      </div>
    `;
    container.appendChild(buttonRow);
    console.log("DEBUG: ƒê√£ th√™m n√∫t Th√™m");
  }

  // T·∫£i d·ªØ li·ªáu
  try {
    await fetchAndRenderDept(dept);
    console.log("DEBUG: switchDept ho√†n t·∫•t");
  } catch (err) {
    console.error(`‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu cho ${dept}:`, err);
    alert(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu cho ${dept}. Vui l√≤ng th·ª≠ l·∫°i.`);
    container.innerHTML += '<div class="text-center text-danger mt-2">L·ªói t·∫£i d·ªØ li·ªáu.</div>';
  }
}

async function fetchAndRenderDept(dept) {
  console.log(`DEBUG: fetchAndRenderDept b·∫Øt ƒë·∫ßu cho ${dept}`);
  try {
    const res = await fetch(`/api/employees?dept=${dept}`, { credentials: "include" });
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    const result = await res.json();
    if (result.error) throw new Error(result.error);
    const rows = result.rows.map(row => ({
      // Map backend columns to frontend fields
      ma_hs: row.ma_hs,
      ma_gv: row.ma_gv,
      ma_lop: row.ma_lop,
      full_name: row.ho_va_ten,
      birth_date: row.ngay_sinh,
      gender: row.gioi_tinh,
      ethnicity: row.dan_toc,
      identifier_code: row.ma_dinh_danh,
      father_name: row.ho_ten_bo,
      father_job: row.nghe_nghiep_bo,
      mother_name: row.ho_ten_me,
      mother_job: row.nghe_nghiep_me,
      household_address: row.ho_khau,
      parent_id_card: row.cccd_bo_me,
      parent_phone: row.sdt,
      staff_id: row.ma_gv,
      nick_name: row.ten_tk,
      team: row.chuc_vu,
      hometown: row.que_quan,
      cccd: row.cccd,
      cccd_issued_date: row.ngay_cap,
      tax_code: row.mst,
      cmnd: row.cmnd,
      insurance_number: row.so_bh,
      phone_number: row.sdt,
      bank_account: row.tk_nh,
      email: row.email,
      blood_type: row.nhom_mau,
      address: row.dia_chi
    }));
    console.log(`DEBUG: ƒê√£ l·∫•y ${rows.length} h√†ng cho ${dept}`);
    renderTable(`table_${dept.toLowerCase()}`, rows);
  } catch (err) {
    console.error(`‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu cho ${dept}:`, err);
    throw err;
  }
}

function renderTable(tableId, rows) {
  console.log(`DEBUG: renderTable b·∫Øt ƒë·∫ßu cho ${tableId}, s·ªë h√†ng: ${rows.length}`);
  const table = document.getElementById(tableId)?.querySelector("tbody");
  if (!table) {
    console.error(`‚ùå Kh√¥ng t√¨m th·∫•y tbody trong ${tableId}`);
    alert(`L·ªói: Kh√¥ng t√¨m th·∫•y b·∫£ng ${tableId}.`);
    return;
  }
  table.innerHTML = "";
  rows.forEach((row, idx) => {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", row.ma_hs || row.staff_id || idx);
    tr.innerHTML = generateRowHtml(tableId, row, idx + 1);
    table.appendChild(tr);
  });
  console.log(`DEBUG: renderTable ho√†n t·∫•t cho ${tableId}`);
}

function generateRowHtml(tableId, row, index) {
  console.log(`DEBUG: generateRowHtml cho ${tableId}, h√†ng ${index}`);

  if (tableId === "table_hs") {
    console.log(`DEBUG: T·∫°o h√†ng HS v·ªõi d·ªØ li·ªáu: ${JSON.stringify(row)}`);

    const deleteButton = (currentUser === "kimnhung" || userRole === "administrator")
      ? `<td><button class="btn btn-sm btn-danger" onclick="deleteRowHS('${row.ma_hs || index}')">X√≥a</button></td>`
      : `<td></td>`;

    return `
      <td>${index}</td>
      <td>${row.ma_hs || ""}</td>
      <td>${row.ma_gv || ""}</td>
      <td>${row.ma_lop || ""}</td>
      <td>${row.full_name || ""}</td>
      <td>${formatDate(row.birth_date)}</td>
      <td>${row.gender || ""}</td>
      <td>${row.ethnicity || ""}</td>
      <td>${row.identifier_code || ""}</td>
      <td>${row.father_name || ""}</td>
      <td>${row.father_job || ""}</td>
      <td>${row.mother_name || ""}</td>
      <td>${row.mother_job || ""}</td>
      <td>${row.household_address || ""}</td>
      <td>${row.parent_id_card || ""}</td>
      <td>${row.parent_phone || ""}</td>
      ${deleteButton}
    `;
  }

  if (tableId === "table_gv") {
    console.log(`DEBUG: T·∫°o h√†ng GV v·ªõi d·ªØ li·ªáu: ${JSON.stringify(row)}`);

    const deleteButton = (currentUser === "kimnhung" || userRole === "administrator")
      ? `<td><button class="btn btn-sm btn-danger" onclick="deleteRowGV('${row.staff_id || index}')">X√≥a</button></td>`
      : `<td></td>`;

    return `
      <td>${index}</td>
      <td>${row.staff_id || ""}</td>
      <td>${row.full_name || ""}</td>
      <td>${row.nick_name || ""}</td>
      <td>${row.team || ""}</td>
      <td>${formatDate(row.birth_date)}</td>
      <td>${row.hometown || ""}</td>
      <td>${row.cccd || ""}</td>
      <td>${formatDate(row.cccd_issued_date)}</td>
      <td>${row.tax_code || ""}</td>
      <td>${row.cmnd || ""}</td>
      <td>${row.insurance_number || ""}</td>
      <td>${row.phone_number || ""}</td>
      <td>${row.bank_account || ""}</td>
      <td>${row.email || ""}</td>
      <td>${row.blood_type || ""}</td>
      <td>${row.address || ""}</td>
      ${deleteButton}
    `;
  }
  console.log(`DEBUG: Kh√¥ng kh·ªõp tableId: ${tableId}`);
  return "";
}

function formatDate(dateStr) {
  if (!dateStr || isNaN(new Date(dateStr))) return "";
  const d = new Date(dateStr);
  return d.getDate().toString().padStart(2, '0') + "/" +
         (d.getMonth() + 1).toString().padStart(2, '0') + "/" +
         d.getFullYear();
}
async function addEmployee() {
    const dept = document.getElementById("deptSelect").value;
    if (!dept || !schemaByDept[dept]) {
        alert("Please select a department.");
        return;
    }
    const data = { "Dept": dept };
    schemaByDept[dept].forEach(field => {
        data[field] = document.getElementById(field)?.value.trim() || "";
    });
    if (dept === "GV" && (!data["staff_id"] || !data["full_name"])) {
        alert("Staff ID and Full Name are required.");
        return;
    } else if (dept === "HS" && (!data["ma_hs"] || !data["ho_va_ten"])) {
        alert("M√£ HS v√† H·ªç v√† T√™n l√† b·∫Øt bu·ªôc.");
        return;
    }
    try {
        const res = await fetch("/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.status === "ok") {
            window.location.href = "/employees";
        } else {
            alert("‚ùå Failed to add employee: " + (result.message || ""));
        }
    } catch (err) {
        alert("‚ùå Error adding employee: " + err.message);
    }
}

window.addEventListener("DOMContentLoaded", async () => {
    await fetchSchema();
    const lastFile = localStorage.getItem('lastImportedFile');
    if (lastFile) {
        document.getElementById("deptSelect").value = lastFile.includes("hocsinh") ? "HS" : "GV";
        await switchDept();
        localStorage.removeItem('lastImportedFile');
    } else {
        document.getElementById("deptSelect").value = "HS"; // Default to HS
        await switchDept();
    }
});

function loadHistory() {
  fetch('/api/bangdanhgiaepa/history?user={{ user }}')
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';
      if (data.length > 0) {
        const userName = data[0].ten_tk || '';
        const userRole = data[0].chuc_vu || '';
        // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ modal
        document.querySelector('#historyModal .modal-title').textContent =
          `L·ªãch S·ª≠ ƒê√°nh Gi√° - ${userName} (${userRole})`;
      }
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-dark-green-bg/20 transition-colors duration-200';
        tr.innerHTML = `
          <td class="px-4 py-3 font-cute">${row.id}</td>
          <td class="px-4 py-3 font-cute font-semibold text-dark-green-primary">${row.ten_tk || ''}</td>
          <td class="px-4 py-3 font-cute text-center">${row.user_total_score || ''}</td>
          <td class="px-4 py-3 font-cute text-center">${row.sup_total_score || ''}</td>
          <td class="px-4 py-3 font-cute text-center">${row.pri_total_score || ''}</td>
          <td class="px-4 py-3 font-cute">${row.pri_comment || ''}</td>
          <td class="px-4 py-3 font-cute text-center">${row.month}</td>
          <td class="px-4 py-3 font-cute text-center">${row.year}</td>
          <td class="px-4 py-3 font-cute text-sm text-gray-600">${row.created_at}</td>
          <td class="px-4 py-3">
            <button class="px-3 py-1 gradient-dark-green text-white rounded-lg hover:shadow-dark-green transition-all duration-300 font-cute font-semibold text-sm hover:scale-105" onclick="loadDetail(${row.id})">
              üìã Chi ti·∫øt
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      $('#historyModal').modal('show');
    });
}

function loadDetail(id) {
  fetch(`/api/bangdanhgiaepa/detail/${id}`)
    .then(res => res.json())
    .then(data => {
      const body = document.getElementById('detailBody');
      if (data.error) {
        body.innerHTML = `<p class="text-danger">${data.error}</p>`;
        return;
      }
      // Render c√¢u h·ªèi + sup_score + sup_comment
      const questionsHTML = data.questions.map((q, index) => `
        <tr class="hover:bg-dark-green-bg/20 transition-colors duration-200">
          <td class="px-4 py-3 font-cute">${q.text}</td>
          <td class="px-4 py-3 font-cute font-bold text-center text-dark-green-primary">${q.score}</td>
          <td class="px-4 py-3 font-cute text-gray-700">${q.comment || '-'}</td>
          <td class="px-4 py-3 font-cute font-bold text-center text-dark-green-secondary">${q.sup_score || '-'}</td>
          <td class="px-4 py-3 font-cute text-gray-700">${q.sup_comment || '-'}</td>
        </tr>
      `).join('');
      body.innerHTML = `
        <div class="space-y-6">
          <h6 class="text-xl font-cute font-bold text-dark-green-primary flex items-center">
            <span class="mr-2 text-2xl">üìä</span>
            Chi Ti·∫øt ƒê√°nh Gi√°
          </h6>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-dark-green-bg text-dark-green-primary">
                <tr>
                  <th class="px-4 py-3 text-left font-cute font-semibold">C√¢u h·ªèi</th>
                  <th class="px-4 py-3 text-center font-cute font-semibold">ƒêi·ªÉm GV</th>
                  <th class="px-4 py-3 text-left font-cute font-semibold">√ù ki·∫øn GV</th>
                  <th class="px-4 py-3 text-center font-cute font-semibold">ƒêi·ªÉm T·ªï Tr∆∞·ªüng</th>
                  <th class="px-4 py-3 text-left font-cute font-semibold">√ù ki·∫øn T·ªï Tr∆∞·ªüng</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                ${questionsHTML}
              </tbody>
            </table>
          </div>
          <div class="bg-dark-green-bg/30 rounded-xl p-4 border-l-4 border-dark-green-primary">
            <p class="font-cute font-semibold text-dark-green-primary flex items-center">
              <span class="mr-2 text-xl">üèÜ</span>
              <strong>ƒêi·ªÉm & √ù ki·∫øn ƒë√°nh gi√° c·ªßa Hi·ªáu Tr∆∞·ªüng:</strong>
            </p>
            <p class="mt-2 font-cute text-gray-700">
              <span class="font-bold text-dark-green-primary">${data.pri_total_score || '-'}</span> - ${data.pri_comment || 'Ch∆∞a c√≥ √Ω ki·∫øn'}
            </p>
          </div>
        </div>
      `;
      $('#detailModal').modal('show');
    });
}

</script>
